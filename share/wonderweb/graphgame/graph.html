<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã‚°ãƒ©ãƒ•ã‚²ãƒ¼ãƒ </title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Interãƒ•ã‚©ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã™ */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');

        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            /* å…¨ä½“ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç¦æ­¢ */
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
        }

        /* --- ç›¤é¢ --- */
        #board-area {
            display: grid;
            /* CSSå¤‰æ•°ã‚’å®šç¾© (JSãŒä¸Šæ›¸ã) */
            --board-rows: 4;
            --board-cols: 6;

            /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæœ€é©åŒ–: 
               vminã‚’ä½¿ã£ã¦ç”»é¢ã®å¹…ã‹é«˜ã•ã®å°ã•ã„æ–¹ã«åˆã‚ã›ã¦ã‚µã‚¤ã‚ºã‚’æ±ºã‚ã‚‹ã“ã¨ã§ã€
               ç”»é¢ã‹ã‚‰ã¯ã¿å‡ºã•ãšã«æœ€å¤§é™å¤§ããè¡¨ç¤ºã™ã‚‹ã€‚
            */
            --cell-size: 13vmin;

            grid-template-rows: repeat(var(--board-rows), var(--cell-size));
            grid-template-columns: repeat(var(--board-cols), var(--cell-size));

            border: 2px solid #333;
            border-radius: 8px;
            /* overflow: hidden;  <-- æ ãŒã¯ã¿å‡ºã‚‹æ¼”å‡ºã®ãŸã‚å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã„ãŒã€ä»Šå›ã¯ç¶­æŒ */
            touch-action: none;
            user-select: none;
            position: relative;
            background-color: #FDFBF5;
            margin: auto;
            /* ä¸­å¤®å¯„ã› */
        }

        /* PCãªã©ã®å¤§ç”»é¢ç”¨èª¿æ•´ */
        @media (min-width: 1024px) {
            #board-area {
                --cell-size: 80px;
                /* ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã¯å›ºå®šã‚µã‚¤ã‚ºã‹ã€ã‚ã‚‹ã„ã¯é«˜ã•ã‚’åŸºæº–ã«ã™ã‚‹ */
                /* é«˜ã•ãƒ™ãƒ¼ã‚¹ã§æœ€å¤§åŒ–ã—ãŸã„å ´åˆã¯ä»¥ä¸‹ã®ã‚ˆã†ã«èª¿æ•´å¯èƒ½ */
                --cell-size: min(80px, 18vh);
            }
        }

        .cell {
            border: 1px solid #ccc;
            box-sizing: border-box;
            display: flex;
            justify-content: center;
            align-items: center;
            /* æ–‡å­—ã‚µã‚¤ã‚ºã‚‚ã‚»ãƒ«ã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦å¯å¤‰ã« */
            font-size: calc(var(--cell-size) * 0.6);
            user-select: none;
        }

        /* èµ¤ã„æ ã®ãƒ”ãƒ¼ã‚¹ */
        .frame-piece {
            background-color: rgba(229, 62, 62, 0.3);
            box-sizing: border-box;
            z-index: 10;
            cursor: grab;
            transition: transform 0.1s ease-out;
        }

        .frame-piece.dragging {
            cursor: grabbing;
            opacity: 0.9;
            transform: scale(1.05);
            z-index: 20;
        }

        /* --- ã‚°ãƒ©ãƒ•å…±é€š --- */
        /* ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢å…¨ä½“ã‚’flexã§ä¼¸ã°ã™ */
        #chart-area-wrapper {
            display: flex;
            flex-direction: column;
            height: 100%;
            justify-content: center;
        }

        .chart-container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            /* å¸¯ã‚°ãƒ©ãƒ•ã®é…ç½®ã®ãŸã‚ */
        }

        /* ã‚°ãƒ©ãƒ•ç”¨ã®SVG */
        #chart-svg-A,
        #chart-svg-B,
        #chart-svg-C {
            width: 100%;
            height: 100%;
            max-height: 40vh;
            /* ã‚°ãƒ©ãƒ•ãŒç¸¦ã«ä¼¸ã³ã™ããªã„ã‚ˆã†ã«åˆ¶é™ */
        }

        @media (min-width: 1024px) {

            #chart-svg-A,
            #chart-svg-B,
            #chart-svg-C {
                max-height: 350px;
            }
        }

        /* ã‚°ãƒ©ãƒ•ã®æ˜Ÿ */
        .star {
            stroke-width: 1;
            stroke: #F6AD55;
        }

        .star-solid-apple {
            fill: #E53E3E;
        }

        .star-solid-grape {
            fill: #805AD5;
        }

        .star-solid-kiwi {
            fill: #10B981;
        }

        #chart-svg-B .star,
        #chart-svg-B .star-dashed {
            stroke: #F6AD55;
        }

        .star-dashed {
            fill: none;
            stroke-width: 2;
            stroke-dasharray: 0.6 0.6;
        }

        .star-dashed-apple {
            stroke: #E53E3E;
        }

        .star-dashed-grape {
            stroke: #805AD5;
        }

        .star-dashed-kiwi {
            stroke: #10B981;
        }

        .chart-icon {
            font-size: 1.5rem;
        }

        /* ã‚°ãƒ©ãƒ•A (æ£’ã‚°ãƒ©ãƒ•) */
        .bar-apple {
            fill: #FEE2E2;
            transition: height 0.3s ease-in-out, y 0.3s ease-in-out;
        }

        .bar-grape {
            fill: #E9D8FD;
            transition: height 0.3s ease-in-out, y 0.3s ease-in-out;
        }

        .bar-kiwi {
            fill: #D1FAE5;
            transition: height 0.3s ease-in-out, y 0.3s ease-in-out;
        }

        #chart-svg-A .star,
        #chart-svg-A .star-dashed {
            transition: transform 0.3s ease-in-out;
        }

        /* ã‚°ãƒ©ãƒ•B (æ•£å¸ƒå›³) */
        .axis {
            stroke: #333;
            stroke-width: 2;
        }

        .guide-line {
            stroke: #aaa;
            stroke-width: 1;
            stroke-dasharray: 2 2;
            transition: x1 0.3s, y1 0.3s, x2 0.3s, y2 0.3s;
        }

        #chart-svg-B .star,
        #chart-svg-B .star-dashed {
            transition: transform 0.3s ease-in-out;
        }

        /* ã‚°ãƒ©ãƒ•C (å††ã‚°ãƒ©ãƒ•) */
        .pie-slice-apple {
            fill: #FEE2E2;
            stroke: #E53E3E;
            stroke-width: 1;
        }

        .pie-slice-grape {
            fill: #E9D8FD;
            stroke: #805AD5;
            stroke-width: 1;
        }

        .pie-slice-kiwi {
            fill: #D1FAE5;
            stroke: #10B981;
            stroke-width: 1;
        }

        #chart-svg-C .star,
        #chart-svg-C .star-dashed {
            transition: transform 0.3s ease-in-out;
        }

        /* ã‚°ãƒ©ãƒ•D (å¸¯ã‚°ãƒ©ãƒ•) */
        #chart-D {
            width: 100%;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .bar-D-container {
            width: 100%;
            height: 40px;
            border: 2px solid #333;
            border-radius: 8px;
            display: flex;
            overflow: hidden;
        }

        .bar-D-slice {
            height: 100%;
            transition: width 0.3s ease-in-out;
        }

        .bar-D-slice-apple {
            background-color: #FEE2E2;
        }

        .bar-D-slice-grape {
            background-color: #E9D8FD;
        }

        .bar-D-slice-kiwi {
            background-color: #D1FAE5;
        }

        .bar-D-icons {
            display: flex;
            justify-content: space-between;
            padding: 0 5px;
            margin-top: 4px;
        }

        .bar-D-icons.three-fruits {
            justify-content: space-around;
        }

        .bar-D-star-container {
            position: relative;
            /* ç›¸å¯¾é…ç½®ã«å¤‰æ›´ */
            height: 30px;
            width: 100%;
            margin-bottom: 5px;
        }

        .bar-D-star {
            position: absolute;
            top: 0;
            transform: translateX(-50%);
            transition: left 0.3s ease-in-out;
            z-index: 10;
        }

        /* --- ã‚¯ãƒªã‚¢ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ (å…¨ç”»é¢ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤) --- */
        #win-message {
            position: fixed;
            inset: 0;
            /* top:0, right:0, bottom:0, left:0 */
            z-index: 9999;
            /* æœ€å‰é¢ */
            background-color: rgba(255, 255, 255, 0.4);
            /* åŠé€æ˜ã®ç™½ */
            backdrop-filter: blur(4px);
            /* èƒŒæ™¯ã‚’ã¼ã‹ã™ */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            /* ã‚¿ãƒƒãƒ—ã§ãã‚‹ã“ã¨ã‚’ç¤ºã™ */

            opacity: 0;
            pointer-events: none;
            /* éè¡¨ç¤ºæ™‚ã¯ã‚¯ãƒªãƒƒã‚¯ç„¡åŠ¹ */
            transition: opacity 0.3s ease-in-out;
        }

        #win-message.active {
            opacity: 1;
            pointer-events: auto;
        }

        #win-message-content {
            background-color: white;
            padding: 2rem 4rem;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        #win-message.active #win-message-content {
            transform: scale(1);
        }

        /* å­¦å¹´é¸æŠç”»é¢ */
        #grade-select-screen {
            position: fixed;
            inset: 0;
            background-color: #f7f7f7;
            z-index: 100;
            transition: opacity 0.3s;
        }

        .grade-button {
            transition: transform 0.1s, box-shadow 0.1s;
        }

        .grade-button:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform: translateY(-2px);
        }

        .grade-button:active {
            transform: translateY(0);
            box-shadow: none;
        }
    </style>
</head>

<body class="bg-gray-100">

    <!-- å­¦å¹´é¸æŠç”»é¢ -->
    <div id="grade-select-screen" class="opacity-100 flex flex-col justify-center items-center">
        <h2 class="text-3xl font-bold text-gray-800 mb-10">ãŒãã­ã‚“ã‚’ ãˆã‚‰ã¼ã†!</h2>
        <div class="flex flex-col md:flex-row gap-8">
            <button id="select-1-2" data-grade="1-2"
                class="grade-button bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-8 rounded-xl shadow-lg w-64 text-xl">
                1ãƒ»2 ã­ã‚“ã›ã„
            </button>
            <button id="select-3-4" data-grade="3-4"
                class="grade-button bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-8 rounded-xl shadow-lg w-64 text-xl">
                3ãƒ»4 ã­ã‚“ã›ã„
            </button>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ã‚³ãƒ³ãƒ†ãƒŠ -->
    <!-- h-full flex flex-col ã§ç”»é¢ã„ã£ã±ã„ã‚’ä½¿ã† -->
    <div id="main-game-container" class="h-full w-full flex flex-col opacity-0 hidden transition-opacity duration-500">

        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¨ãƒªã‚¢ (ã‚¿ã‚¤ãƒˆãƒ« & ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«) -->
        <div class="flex-none bg-white shadow-sm p-4 z-10">
            <div class="container mx-auto max-w-7xl flex flex-col sm:flex-row items-center justify-between gap-4">
                <h1 class="text-2xl font-bold text-gray-800">ã‚°ãƒ©ãƒ•ã‚²ãƒ¼ãƒ </h1>

                <div class="flex items-center space-x-4">
                    <label for="stage-select" class="text-lg font-medium text-gray-700 whitespace-nowrap">ã‚‚ã‚“ã ã„:</label>
                    <select id="stage-select"
                        class="p-2 border rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 min-w-[150px] text-lg">
                        <!-- JSã§ç”Ÿæˆ -->
                    </select>
                    <button id="next-stage-button"
                        class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition disabled:bg-gray-400 disabled:cursor-not-allowed whitespace-nowrap">
                        ã¤ãã¸
                    </button>
                </div>
            </div>
        </div>

        <!-- ã‚²ãƒ¼ãƒ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ (æ®‹ã‚Šé«˜ã•ã‚’å…¨ã¦ä½¿ã†) -->
        <div class="flex-grow overflow-hidden p-2 lg:p-4">
            <div class="container mx-auto max-w-7xl h-full flex flex-col lg:flex-row gap-4 lg:gap-8">

                <!-- å·¦å´: ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ -->
                <!-- h-full ã‚’æŒ‡å®šã—ã¦é«˜ã•ã‚’ç¢ºä¿ -->
                <div id="chart-area-wrapper"
                    class="w-full lg:w-1/3 bg-white p-4 rounded-lg shadow-lg h-full lg:h-auto lg:flex-grow-0 overflow-y-auto">
                    <!-- ã‚°ãƒ©ãƒ•A (æ£’ã‚°ãƒ©ãƒ•) -->
                    <div id="chart-A" class="chart-container" style="display: none;">
                        <svg id="chart-svg-A" viewBox="0 0 200 250" preserveAspectRatio="xMidYMid meet"></svg>
                    </div>

                    <!-- ã‚°ãƒ©ãƒ•B (æ•£å¸ƒå›³) -->
                    <div id="chart-B" class="chart-container" style="display: none;">
                        <svg id="chart-svg-B" viewBox="0 0 250 250" preserveAspectRatio="xMidYMid meet"></svg>
                    </div>

                    <!-- ã‚°ãƒ©ãƒ•C (å††ã‚°ãƒ©ãƒ•) -->
                    <div id="chart-C" class="chart-container" style="display: none;">
                        <svg id="chart-svg-C" viewBox="0 0 200 250" preserveAspectRatio="xMidYMid meet"></svg>
                    </div>

                    <!-- ã‚°ãƒ©ãƒ•D (å¸¯ã‚°ãƒ©ãƒ•) -->
                    <div id="chart-D" class="chart-container" style="display: none;">
                        <div class="bar-D-star-container">
                            <!-- æ˜Ÿã‚¢ã‚¤ã‚³ãƒ³ (JSã§åˆ¶å¾¡) -->
                            <svg id="star-D-target-apple" class="bar-D-star star-dashed star-dashed-apple"
                                viewBox="0 0 24 24" width="24" height="24" style="left: 50%;">
                                <path
                                    d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z">
                                </path>
                            </svg>
                            <svg id="star-D-current-apple" class="bar-D-star star star-solid-apple" viewBox="0 0 24 24"
                                width="24" height="24" style="left: 50%;">
                                <path
                                    d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z">
                                </path>
                            </svg>
                            <svg id="star-D-target-grape" class="bar-D-star star-dashed star-dashed-grape"
                                viewBox="0 0 24 24" width="24" height="24" style="left: 50%; display: none;">
                                <path
                                    d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z">
                                </path>
                            </svg>
                            <svg id="star-D-current-grape" class="bar-D-star star star-solid-grape" viewBox="0 0 24 24"
                                width="24" height="24" style="left: 50%; display: none;">
                                <path
                                    d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z">
                                </path>
                            </svg>
                        </div>
                        <div class="bar-D-container">
                            <div id="bar-D-apple" class="bar-D-slice bar-D-slice-apple" style="width: 33.3%;"></div>
                            <div id="bar-D-grape" class="bar-D-slice bar-D-slice-grape" style="width: 33.3%;"></div>
                            <div id="bar-D-kiwi" class="bar-D-slice bar-D-slice-kiwi" style="width: 33.3%;"></div>
                        </div>
                        <div id="bar-D-icons" class="bar-D-icons">
                            <span class="chart-icon icon-apple">ğŸ</span>
                            <span class="chart-icon icon-kiwi" style="display: none;">ğŸ¥</span>
                            <span class="chart-icon icon-grape">ğŸ‡</span>
                        </div>
                    </div>
                </div>

                <!-- å³å´: ç›¤é¢ã‚¨ãƒªã‚¢ -->
                <!-- flex-grow ã§æ®‹ã‚Šã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’åŸ‹ã‚ã‚‹ -->
                <div class="w-full lg:w-2/3 flex justify-center items-center h-full">
                    <div id="board-area">
                        <!-- JSã§ãƒã‚¹ã¨æ ãŒã“ã“ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- ã‚¯ãƒªã‚¢ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ (å…¨ç”»é¢ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤) -->
    <div id="win-message">
        <div id="win-message-content">
            <div class="text-6xl mb-4">ğŸ‰</div>
            <h3 class="text-4xl font-bold text-green-600 mb-2">ã‚¯ãƒªã‚¢ï¼</h3>
            <p class="text-gray-500 text-sm">ãŒã‚ã‚“ã‚’ ã‚¿ãƒƒãƒ—ã—ã¦ã­</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- 1. å®šæ•°ã¨çŠ¶æ…‹ ---

            // --- ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿ ---
            const ALL_STAGES = [
                {
                    id: 'ã‚¹ãƒ†ãƒ¼ã‚¸1-1',
                    name: 'ã‚¹ãƒ†ãƒ¼ã‚¸1-1',
                    graphType: 'A',
                    level: 1,
                    fruits: [
                        ['a', 0, 0, 0, 'a', 0],
                        [0, 'a', 0, 0, 0, 'a'],
                        [0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 'a', 0]
                    ],
                    frames: [
                        [0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0],
                        [0, 1, 1, 2, 2, 0],
                        [0, 1, 1, 2, 2, 0]
                    ],
                    targets: { apple: 4 }
                },
                {
                    id: 'ã‚¹ãƒ†ãƒ¼ã‚¸1-2',
                    name: 'ã‚¹ãƒ†ãƒ¼ã‚¸1-2',
                    graphType: 'A',
                    level: 1,
                    fruits: [
                        ['a', 0, 0, 'a', 'a', 0],
                        [0, 0, 0, 'a', 0, 'a'],
                        ['a', 0, 'a', 0, 'a', 0],
                        [0, 'a', 'a', 0, 0, 0]
                    ],
                    frames: [
                        [0, 1, 1, 0, 0, 0],
                        [0, 1, 1, 0, 0, 0],
                        [0, 0, 0, 0, 2, 2],
                        [0, 0, 0, 0, 2, 2]
                    ],
                    targets: { apple: 6 }
                },
                {
                    id: 'ã‚¹ãƒ†ãƒ¼ã‚¸1-3',
                    name: 'ã‚¹ãƒ†ãƒ¼ã‚¸1-3',
                    graphType: 'A',
                    level: 1,
                    fruits: [
                        [0, 0, 'a', 0, 'a', 0],
                        ['a', 0, 0, 0, 0, 'a'],
                        [0, 0, 0, 0, 'a', 0],
                        [0, 'a', 'a', 0, 0, 0]
                    ],
                    frames: [
                        [0, 0, 0, 0, 0, 0],
                        [1, 1, 0, 0, 2, 2],
                        [1, 1, 0, 0, 0, 0],
                        [1, 1, 0, 0, 0, 0]
                    ],
                    targets: { apple: 5 }
                },
                {
                    id: 'ã‚¹ãƒ†ãƒ¼ã‚¸1-4',
                    name: 'ã‚¹ãƒ†ãƒ¼ã‚¸1-4',
                    graphType: 'A',
                    level: 1,
                    fruits: [
                        [0, 0, 'a', 'a', 0, 0],
                        [0, 'a', 0, 'a', 0, 'a'],
                        [0, 'a', 0, 0, 0, 'a'],
                        ['a', 0, 'a', 0, 'a', 0]
                    ],
                    frames: [
                        [2, 2, 0, 0, 1, 0],
                        [2, 2, 0, 0, 1, 1],
                        [0, 0, 0, 0, 0, 1],
                        [0, 0, 0, 0, 0, 0]
                    ],
                    targets: { apple: 6 }
                },


                {
                    id: 'ã‚¹ãƒ†ãƒ¼ã‚¸2-1',
                    name: 'ã‚¹ãƒ†ãƒ¼ã‚¸2-1',
                    graphType: 'A',
                    level: 1,
                    fruits: [
                        [0, 0, 0, 0, 0, 0],
                        [0, 'a', 0, 'g', 'g', 0],
                        ['a', 'a', 'a', 0, 'g', 0],
                        [0, 'a', 0, 0, 'g', 'g']
                    ],
                    frames: [
                        [1, 0, 0, 0, 2, 0],
                        [1, 1, 0, 0, 2, 2],
                        [0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0]
                    ],
                    targets: { apple: 3, grape: 3 }
                },
                {
                    id: 'ã‚¹ãƒ†ãƒ¼ã‚¸2-2',
                    name: 'ã‚¹ãƒ†ãƒ¼ã‚¸2-2',
                    graphType: 'A',
                    level: 1,
                    fruits: [
                        [0, 0, 'a', 0, 0, 0],
                        ['a', 'g', 'g', 'a', 'a', 'g'],
                        [0, 0, 'a', 0, 0, 0],
                        [0, 0, 'a', 'g', 'a', 'g']
                    ],
                    frames: [
                        [0, 0, 0, 2, 2, 2],
                        [0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0],
                        [1, 1, 0, 0, 0, 0]
                    ],
                    targets: { apple: 1, grape: 4 }
                },



                {
                    id: 'ã‚¹ãƒ†ãƒ¼ã‚¸2-3',
                    name: 'ã‚¹ãƒ†ãƒ¼ã‚¸2-3',
                    graphType: 'A',
                    level: 1,
                    fruits: [
                        ['a', 'a', 'a', 0, 0, 0],
                        [0, 0, 'g', 'g', 'g', 0],
                        ['a', 'a', 0, 0, 'g', 'a'],
                        [0, 0, 0, 0, 0, 0]
                    ],
                    frames: [
                        [0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0],
                        [1, 1, 0, 0, 2, 2],
                        [1, 1, 0, 0, 2, 2]
                    ],
                    targets: { apple: 3, grape: 3 }
                },
                {
                    id: 'ã‚¹ãƒ†ãƒ¼ã‚¸2-4',
                    name: 'ã‚¹ãƒ†ãƒ¼ã‚¸2-4',
                    graphType: 'A',
                    level: 1,
                    fruits: [
                        ['a', 0, 'a', 0, 'g', 'a'],
                        [0, 'g', 'a', 0, 'a', 0],
                        ['g', 'g', 0, 'a', 0, 'g'],
                        [0, 0, 0, 0, 0, 0]
                    ],
                    frames: [
                        [1, 1, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 2, 2],
                        [0, 0, 0, 0, 0, 0]
                    ],
                    targets: { apple: 2, grape: 2 }
                },
                {
                    id: 'ã‚¹ãƒ†ãƒ¼ã‚¸3-1',
                    name: 'ã‚¹ãƒ†ãƒ¼ã‚¸3-1',
                    graphType: 'B',
                    level: 1,
                    fruits: [
                        [0, 'a', 0, 'a', 0, 'a'],
                        ['g', 'a', 'g', 'a', 'a', 'a'],
                        [0, 'a', 0, 'a', 0, 'g'],
                        ['a', 'a', 'a', 'a', 'a', 'g']
                    ],
                    frames: [
                        [0, 0, 0, 0, 0, 0],
                        [1, 1, 0, 0, 2, 0],
                        [1, 1, 0, 2, 2, 0],
                        [0, 0, 0, 0, 0, 0]
                    ],
                    targets: { apple: 3, grape: 3 }
                },
                {
                    id: 'ã‚¹ãƒ†ãƒ¼ã‚¸3-2',
                    name: 'ã‚¹ãƒ†ãƒ¼ã‚¸3-2',
                    graphType: 'B',
                    level: 1,
                    fruits: [
                        ['a', 0, 'a', 'a', 0, 'g'],
                        ['a', 0, 'g', 'a', 0, 'a'],
                        ['a', 0, 'g', 'a', 0, 'g'],
                        ['g', 0, 'a', 'g', 0, 'a']
                    ],
                    frames: [
                        [1, 1, 1, 0, 0, 0],
                        [1, 1, 1, 0, 0, 0],
                        [2, 0, 0, 0, 0, 0],
                        [2, 0, 0, 0, 0, 0]
                    ],
                    targets: { apple: 2, grape: 4 }
                },
                {
                    id: 'ã‚¹ãƒ†ãƒ¼ã‚¸3-3',
                    name: 'ã‚¹ãƒ†ãƒ¼ã‚¸3-3',
                    graphType: 'B',
                    level: 1,
                    fruits: [
                        ['a', 0, 0, 'g', 0, 0],
                        [0, 'g', 'a', 0, 'a', 'g'],
                        ['g', 0, 0, 'g', 'a', 0],
                        ['a', 'g', 'a', 0, 0, 'g']
                    ],
                    frames: [
                        [0, 1, 1, 0, 0, 0],
                        [1, 1, 0, 0, 0, 0],
                        [0, 0, 0, 0, 2, 2],
                        [0, 0, 0, 0, 2, 2]
                    ],
                    targets: { apple: 3, grape: 4 }
                },
                {
                    id: 'ã‚¹ãƒ†ãƒ¼ã‚¸3-4',
                    name: 'ã‚¹ãƒ†ãƒ¼ã‚¸3-4',
                    graphType: 'B',
                    level: 1,
                    fruits: [
                        ['g', 'a', 'a', 'a', 'a', 'a'],
                        ['a', 'a', 'g', 'g', 'g', 'g'],
                        ['a', 'a', 'a', 'a', 'a', 'a'],
                        ['a', 'g', 'g', 'a', 'g', 'g']
                    ],
                    frames: [
                        [1, 0, 0, 0, 2, 0],
                        [1, 0, 0, 0, 2, 0],
                        [1, 1, 0, 0, 2, 0],
                        [0, 0, 0, 0, 0, 0]
                    ],
                    targets: { apple: 2, grape: 5 }
                },


                {
                    id: 'ã‚¹ãƒ†ãƒ¼ã‚¸4-1',
                    name: 'ã‚¹ãƒ†ãƒ¼ã‚¸4-1',
                    graphType: 'C',
                    level: 1,
                    fruits: [
                        ['g', 0, 0, 'a', 0, 0],
                        [0, 0, 0, 0, 0, 'a'],
                        [0, 'a', 0, 'a', 'a', 0],
                        ['a', 0, 0, 'a', 0, 'a']
                    ],
                    frames: [
                        [1, 1, 0, 2, 2, 0],
                        [1, 1, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0]
                    ],
                    targets: { apple: 3, grape: 1 }
                },
                {
                    id: 'ã‚¹ãƒ†ãƒ¼ã‚¸4-2',
                    name: 'ã‚¹ãƒ†ãƒ¼ã‚¸4-2',
                    graphType: 'C',
                    level: 1,
                    fruits: [
                        ['g', 'a', 'a', 0, 'g', 'a'],
                        [0, 'a', 0, 0, 'a', 'a'],
                        ['a', 0, 'g', 'a', 0, 0],
                        ['a', 0, 'a', 'a', 0, 'g']
                    ],
                    frames: [
                        [0, 0, 0, 0, 2, 2],
                        [1, 1, 1, 0, 0, 0],
                        [1, 1, 1, 0, 0, 0],
                        [1, 1, 1, 0, 0, 0]
                    ],
                    targets: { apple: 3, grape: 3 }
                },
                {
                    id: 'ã‚¹ãƒ†ãƒ¼ã‚¸4-3',
                    name: 'ã‚¹ãƒ†ãƒ¼ã‚¸4-3',
                    graphType: 'C',
                    level: 1,
                    fruits: [
                        [0, 'a', 0, 'a', 0, 'a'],
                        ['g', 'a', 'a', 'g', 'a', 'a'],
                        [0, 'g', 0, 'a', 0, 'a'],
                        ['a', 'g', 'a', 'g', 'a', 'g']
                    ],
                    frames: [
                        [0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 2, 2, 2],
                        [1, 0, 0, 0, 0, 0],
                        [1, 0, 0, 0, 0, 0]
                    ],
                    targets: { apple: 1, grape: 4 }
                },
                {
                    id: 'ã‚¹ãƒ†ãƒ¼ã‚¸5-1',
                    name: 'ã‚¹ãƒ†ãƒ¼ã‚¸5-1',
                    graphType: 'D',
                    level: 1,
                    fruits: [
                        [0, 'a', 'a', 'a', 'a', 'g'],
                        [0, 'a', 'a', 0, 0, 0],
                        [0, 'a', 'a', 0, 0, 0],
                        [0, 'g', 'a', 0, 0, 0]
                    ],
                    frames: [
                        [2, 2, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0],
                        [1, 1, 0, 0, 0, 0],
                        [1, 1, 0, 0, 0, 0]
                    ],
                    targets: { apple: 3, grape: 1 }
                },
                {
                    id: 'ã‚¹ãƒ†ãƒ¼ã‚¸5-2',
                    name: 'ã‚¹ãƒ†ãƒ¼ã‚¸5-2',
                    graphType: 'D',
                    level: 1,
                    fruits: [
                        ['a', 0, 'g', 0, 'a', 0],
                        [0, 'g', 0, 'a', 0, 'a'],
                        ['g', 0, 'a', 0, 'g', 0],
                        [0, 'a', 0, 'g', 0, 'g']
                    ],
                    frames: [
                        [0, 1, 0, 0, 0, 0],
                        [1, 1, 1, 0, 0, 0],
                        [0, 2, 0, 0, 0, 0],
                        [2, 2, 2, 0, 0, 0]
                    ],
                    targets: { apple: 4, grape: 2 }
                },
                {
                    id: 'ã‚¹ãƒ†ãƒ¼ã‚¸5-3',
                    name: 'ã‚¹ãƒ†ãƒ¼ã‚¸5-3',
                    graphType: 'D',
                    level: 1,
                    fruits: [
                        ['a', 'a', 'g', 'a', 'g', 'g'],
                        ['a', 'g', 'a', 'a', 'a', 'a'],
                        ['g', 'a', 'g', 'a', 'g', 'g'],
                        ['a', 'a', 'a', 'a', 'a', 'g']
                    ],
                    frames: [
                        [1, 1, 1, 0, 0, 2],
                        [1, 0, 1, 0, 0, 2],
                        [1, 0, 1, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0]
                    ],
                    targets: { apple: 3, grape: 6 }
                },
                {
                    id: 'ã‚¹ãƒ†ãƒ¼ã‚¸6-1',
                    name: 'ã‚¹ãƒ†ãƒ¼ã‚¸6-1',
                    graphType: 'A',
                    level: 1,
                    fruits: [
                        ['k', 'a', 'g', 'g', 'k', 'k'],
                        [0, 0, 0, 0, 0, 0],
                        ['a', 'g', 'a', 'g', 'g', 'a'],
                        [0, 0, 0, 0, 0, 0]
                    ],
                    frames: [
                        [0, 0, 0, 0, 0, 0],
                        [1, 1, 1, 2, 2, 2],
                        [0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0]
                    ],
                    targets: { apple: 2, grape: 2, kiwi: 2 }
                },
                {
                    id: 'ã‚¹ãƒ†ãƒ¼ã‚¸6-2',
                    name: 'ã‚¹ãƒ†ãƒ¼ã‚¸6-2',
                    graphType: 'A',
                    level: 1,
                    fruits: [
                        ['a', 'k', 0, 0, 'k', 'k'],
                        ['a', 'k', 'g', 'a', 'g', 'g'],
                        [0, 'g', 'g', 'a', 'a', 0],
                        [0, 0, 'a', 'a', 0, 0]
                    ],
                    frames: [
                        [0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0],
                        [1, 1, 0, 0, 2, 2],
                        [1, 1, 0, 0, 2, 2]
                    ],
                    targets: { apple: 2, grape: 4, kiwi: 2 }
                },
                {
                    id: 'ã‚¹ãƒ†ãƒ¼ã‚¸6-3',
                    name: 'ã‚¹ãƒ†ãƒ¼ã‚¸6-3',
                    graphType: 'A',
                    level: 1,
                    fruits: [
                        ['a', 'a', 'k', 'k', 'k', 'k'],
                        ['a', 'a', 'k', 'k', 'k', 'k'],
                        ['a', 'a', 'k', 'k', 'k', 'k'],
                        ['g', 'g', 'g', 'g', 'g', 'g']
                    ],
                    frames: [
                        [1, 1, 0, 0, 2, 2],
                        [1, 1, 0, 0, 2, 2],
                        [0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0]
                    ],
                    targets: { apple: 3, grape: 2, kiwi: 3 }
                },





                {
                    id: 'ã‚¹ãƒ†ãƒ¼ã‚¸7-1',
                    name: 'ã‚¹ãƒ†ãƒ¼ã‚¸7-1',
                    graphType: 'C',
                    level: 1,
                    fruits: [
                        [0, 0, 'k', 'k', 'a', 'a'],
                        ['g', 'g', 'k', 'k', 'a', 'a'],
                        ['g', 'g', 'g', 'g', 'g', 'g'],
                        ['k', 'k', 'g', 'g', 0, 0]
                    ],
                    frames: [
                        [0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 2, 2],
                        [1, 1, 0, 0, 2, 2],
                        [1, 1, 0, 0, 0, 0]
                    ],
                    targets: { apple: 2, grape: 2, kiwi: 2 }
                },
                {
                    id: 'ã‚¹ãƒ†ãƒ¼ã‚¸7-2',
                    name: 'ã‚¹ãƒ†ãƒ¼ã‚¸7-2',
                    graphType: 'C',
                    level: 1,
                    fruits: [
                        ['k', 'g', 'a', 'k', 0, 0],
                        [0, 0, 'k', 'g', 'k', 'a'],
                        ['a', 'k', 'g', 'k', 0, 0],
                        [0, 0, 'k', 'g', 'a', 'k']
                    ],
                    frames: [
                        [1, 1, 0, 0, 0, 0],
                        [1, 1, 0, 0, 0, 0],
                        [0, 0, 0, 0, 2, 2],
                        [0, 0, 0, 0, 2, 2]
                    ],
                    targets: { apple: 2, grape: 2, kiwi: 2 }
                },
                {
                    id: 'ã‚¹ãƒ†ãƒ¼ã‚¸7-3',
                    name: 'ã‚¹ãƒ†ãƒ¼ã‚¸7-3',
                    graphType: 'D',
                    level: 1,
                    fruits: [
                        ['k', 'g', 0, 'k', 'g', 0],
                        ['g', 'a', 'g', 'a', 'k', 'g'],
                        ['a', 'k', 'g', 'a', 'g', 'a'],
                        [0, 'a', 'k', 0, 'a', 'k']
                    ],
                    frames: [
                        [1, 1, 0, 0, 2, 2],
                        [1, 1, 0, 0, 2, 2],
                        [0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0]
                    ],
                    targets: { apple: 2, grape: 2, kiwi: 4 }
                },
                {
                    id: 'stage10',
                    name: 'å•é¡Œ 10 (6x8 æ£’ã‚°ãƒ©ãƒ•)',
                    graphType: 'A',
                    level: 1,
                    fruits: [
                        ['a', 'g', 'a', 'g', 'a', 'g', 'a', 'g'],
                        ['g', 'a', 'g', 'a', 'g', 'a', 'g', 'a'],
                        ['a', 'g', 'a', 'g', 'a', 'g', 'a', 'g'],
                        ['g', 'a', 'g', 'a', 'g', 'a', 'g', 'a'],
                        ['k', 'k', 'k', 'k', 'k', 'k', 'k', 'k'],
                        ['a', 'g', 'k', 0, 0, 'k', 'g', 'a']
                    ],
                    frames: [
                        [0, 1, 1, 1, 0, 0, 0, 0],
                        [0, 1, 1, 1, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 2, 2, 0],
                        [0, 0, 0, 0, 0, 2, 2, 0],
                        [0, 0, 0, 0, 0, 2, 2, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0]
                    ],
                    targets: { apple: 3, grape: 3, kiwi: 3 }
                }
            ];

            // --- åˆ¶å¾¡ãƒªã‚¹ãƒˆ (å­¦å¹´ã¨ãƒ¬ãƒ™ãƒ«ã®å¯¾å¿œ) ---
            const LEVEL_MAP = {
                // 1ãƒ»2å¹´ç”Ÿã¯ãƒ¬ãƒ™ãƒ«1ã®ã¿ (åˆç´š)
                '1-2': [1],
                // 3ãƒ»4å¹´ç”Ÿã¯ãƒ¬ãƒ™ãƒ«1ï¼ˆå¾©ç¿’ï¼‰ã¨ãƒ¬ãƒ™ãƒ«2ï¼ˆæœ¬ç·¨ï¼‰
                '3-4': [1, 2]
            };

            // --- çŠ¶æ…‹å¤‰æ•° ---
            let stages = []; // é¸æŠã•ã‚ŒãŸå­¦å¹´ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚ŒãŸå•é¡Œãƒªã‚¹ãƒˆ
            let currentStage = null;
            let currentCounts = { apple: 0, grape: 0, kiwi: 0 };
            let frames = [];
            let boardRows = 4;
            let boardCols = 6;
            let currentStageIndex = 0; // ç¾åœ¨ã®å•é¡Œã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
            let clearedStages = new Set(); // ã‚¯ãƒªã‚¢ã—ãŸå•é¡ŒIDã‚’ä¿æŒ (sessionStorageã‹ã‚‰ãƒ­ãƒ¼ãƒ‰)

            // DOMè¦ç´ 
            let boardElement = document.getElementById('board-area');
            let chartContainers = {
                A: document.getElementById('chart-A'),
                B: document.getElementById('chart-B'),
                C: document.getElementById('chart-C'),
                D: document.getElementById('chart-D')
            };
            let winMessageElement = document.getElementById('win-message');
            let stageSelectElement = document.getElementById('stage-select');
            let nextButton = document.getElementById('next-stage-button');
            let gradeSelectScreen = document.getElementById('grade-select-screen');
            let mainGameContainer = document.getElementById('main-game-container');

            // ãƒ‰ãƒ©ãƒƒã‚°ã®çŠ¶æ…‹
            let isDragging = false;
            let activeFrame = null;
            let dragStartPos = { x: 0, y: 0 };
            let dragStartGrid = { r: 0, c: 0 };
            let lastDragGrid = { r: 0, c: 0 };

            // æ˜Ÿã®SVGãƒ‘ã‚¹
            const STAR_PATH_D = "M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z";
            const STAR_SIZE = 24;
            const STAR_OFFSET = STAR_SIZE / 2;

            // --- 2. åˆæœŸåŒ–/ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ© ---

            function loadClearedStages() {
                // sessionStorageã‹ã‚‰ã‚¯ãƒªã‚¢æƒ…å ±ã‚’ãƒ­ãƒ¼ãƒ‰ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ã‚‹ã¨ãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹ï¼‰
                const cleared = sessionStorage.getItem('clearedStages');
                if (cleared) {
                    try {
                        clearedStages = new Set(JSON.parse(cleared));
                    } catch {
                        clearedStages = new Set();
                    }
                }
            }

            function saveClearedStages() {
                // ã‚¯ãƒªã‚¢æƒ…å ±ã‚’sessionStorageã«ä¿å­˜
                sessionStorage.setItem('clearedStages', JSON.stringify(Array.from(clearedStages)));
            }

            function filterStages(gradeKey) {
                const allowedLevels = LEVEL_MAP[gradeKey] || [];

                // è¨±å¯ã•ã‚ŒãŸãƒ¬ãƒ™ãƒ«ã®å•é¡Œã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                stages = ALL_STAGES.filter(stage => allowedLevels.includes(stage.level));

                if (stages.length === 0) {
                    console.error("Warning: No stages found for selected grade:", gradeKey);
                }
                currentStageIndex = 0;
            }

            function initApp() {
                loadClearedStages();

                // å­¦å¹´é¸æŠãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                document.getElementById('select-1-2').addEventListener('click', (e) => handleGradeSelect(e.currentTarget.dataset.grade));
                document.getElementById('select-3-4').addEventListener('click', (e) => handleGradeSelect(e.currentTarget.dataset.grade));

                // ã‚¯ãƒªã‚¢ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆé–‰ã˜ã‚‹ï¼‰
                winMessageElement.addEventListener('click', () => {
                    winMessageElement.classList.remove('active');
                });
            }

            function handleGradeSelect(gradeKey) {
                // å•é¡Œã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                filterStages(gradeKey);

                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã¨åˆ‡ã‚Šæ›¿ãˆã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®èª¿æ•´

                // 1. ã¾ãšå­¦å¹´é¸æŠç”»é¢ã‚’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ (opacity: 0, clickç„¡åŠ¹)
                gradeSelectScreen.classList.add('opacity-0', 'pointer-events-none');
                gradeSelectScreen.classList.remove('opacity-100');

                // 2. ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã®transition(300ms)ã‚’å¾…ã£ã¦ã‹ã‚‰DOMæ“ä½œã‚’è¡Œã†
                setTimeout(() => {
                    // å­¦å¹´é¸æŠç”»é¢ã‚’éè¡¨ç¤º (display: none)
                    gradeSelectScreen.classList.add('hidden');

                    // ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ã‚³ãƒ³ãƒ†ãƒŠã‚’è¡¨ç¤ºæº–å‚™ (display: blockç­‰)
                    mainGameContainer.classList.remove('hidden');

                    // ãƒ–ãƒ©ã‚¦ã‚¶ã®æç”»æ›´æ–°ã‚’å¾…ã¤ãŸã‚ã«å°‘ã—é…ã‚‰ã›ã‚‹ã‹ã€requestAnimationFrameã‚’ä½¿ã†
                    requestAnimationFrame(() => {
                        mainGameContainer.classList.remove('opacity-0');
                        mainGameContainer.classList.add('opacity-100');
                    });

                    setupGameUI(); // UIã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¦æœ€åˆã®å•é¡Œã‚’ãƒ­ãƒ¼ãƒ‰
                }, 300); // CSSã®transitionæ™‚é–“ã«åˆã‚ã›ã‚‹
            }

            function setupGameUI() {
                // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³å¤‰æ›´æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                stageSelectElement.addEventListener('change', (e) => {
                    const selectedStageId = e.target.value;
                    const index = stages.findIndex(s => s.id === selectedStageId);
                    if (index !== -1) {
                        currentStageIndex = index;
                        loadStage(stages[currentStageIndex]);
                    }
                });

                // ã€Œã¤ãã® ã‚‚ã‚“ã ã„ã¸ã€ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                nextButton.addEventListener('click', goToNextStage);

                // å…¨ã‚°ãƒ©ãƒ•ã®é™çš„è¦ç´ ã‚’åˆæœŸåŒ–
                initAllCharts();

                // å•é¡Œãƒªã‚¹ãƒˆã‚’UIã«è¡¨ç¤ºã—ã€æœ€åˆã®å•é¡Œã‚’ãƒ­ãƒ¼ãƒ‰
                updateStageSelectUI();
                loadStage(stages[0]);
            }

            function updateStageSelectUI() {
                stageSelectElement.innerHTML = ''; // æ—¢å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢

                stages.forEach((stage, index) => {
                    const option = document.createElement('option');
                    option.value = stage.id;

                    // ã‚¯ãƒªã‚¢ãƒãƒ¼ã‚¯ã‚’è¿½åŠ 
                    const star = clearedStages.has(stage.id) ? ' â˜…' : '';
                    option.textContent = `${stage.name}${star}`;

                    option.selected = (index === currentStageIndex);
                    stageSelectElement.appendChild(option);
                });

                // æ¬¡ã¸ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
                updateNextButtonState();
            }

            function updateNextButtonState() {
                const isLastStage = currentStageIndex === stages.length - 1;
                nextButton.disabled = isLastStage;
                // ã‚¯ãƒªã‚¢çŠ¶æ…‹ã«å¿œã˜ã¦ã€æ¬¡ã®ãƒœã‚¿ãƒ³ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚‚ãƒªã‚»ãƒƒãƒˆ
                if (nextButton.disabled) {
                    nextButton.classList.remove('animate-pulse');
                }
            }

            function goToNextStage() {
                if (currentStageIndex < stages.length - 1) {
                    currentStageIndex++;
                    loadStage(stages[currentStageIndex]);
                    // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚‚æ›´æ–°
                    stageSelectElement.value = stages[currentStageIndex].id;
                    updateNextButtonState();
                }
            }


            // ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã‚€ (åˆæœŸåŒ–å‡¦ç†)
            function loadStage(stageData) {
                currentStage = stageData;

                // --- ç›¤é¢ã®ã‚µã‚¤ã‚ºã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ã‹ã‚‰å–å¾— ---
                boardRows = stageData.fruits.length;
                boardCols = stageData.fruits[0].length;
                // CSSå¤‰æ•°ã‚’æ›´æ–°ã—ã¦ã€ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å‹•çš„ã«å¤‰æ›´
                boardElement.style.setProperty('--board-rows', boardRows);
                boardElement.style.setProperty('--board-cols', boardCols);

                // è¡¨ç¤ºã™ã‚‹ã‚°ãƒ©ãƒ•ã‚³ãƒ³ãƒ†ãƒŠã‚’åˆ‡ã‚Šæ›¿ãˆ
                for (const type in chartContainers) {
                    chartContainers[type].style.display = (type === currentStage.graphType) ? 'block' : 'none';
                }

                initBoard(currentStage.fruits);
                initFrames(currentStage.frames);
                // ã‚°ãƒ©ãƒ•ã®ã€Œç›®æ¨™ã€ã‚’æ›´æ–°
                updateChartTargets(currentStage.graphType, currentStage.targets);

                // ã‚¯ãƒªã‚¢ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éš ã™ (ã‚¯ãƒ©ã‚¹åˆ¶å¾¡ã«å¤‰æ›´)
                winMessageElement.classList.remove('active');
                nextButton.classList.remove('animate-pulse'); // ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ

                updateGame(false); // åˆå›æ›´æ–° (ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãªã—)
            }

            // ç›¤é¢(ãƒã‚¹ã¨æœç‰©)ã®DOMã‚’ç”Ÿæˆ (å¤‰æ›´ãªã—)
            function initBoard(fruitsLayout) {
                boardElement.innerHTML = '';
                let cells = [];

                for (let r = 0; r < boardRows; r++) {
                    for (let c = 0; c < boardCols; c++) {
                        const cell = document.createElement('div');
                        cell.classList.add('cell');
                        cell.style.gridRow = r + 1;
                        cell.style.gridColumn = c + 1;

                        const fruit = fruitsLayout[r][c];
                        if (fruit === 'a') {
                            cell.textContent = 'ğŸ';
                        } else if (fruit === 'g') {
                            cell.textContent = 'ğŸ‡';
                        } else if (fruit === 'k') {
                            cell.textContent = 'ğŸ¥';
                        }
                        cells.push(cell);
                    }
                }
                boardElement.append(...cells);
            }

            // æ ã®å†…éƒ¨ãƒ‡ãƒ¼ã‚¿ã¨DOMã‚’ç”Ÿæˆ (å¤‰æ›´ãªã—)
            function initFrames(framesLayout) {
                frames = [];
                const framePiecesDOM = [];

                const tempFrames = new Map();
                for (let r = 0; r < boardRows; r++) {
                    for (let c = 0; c < boardCols; c++) {
                        const frameId = framesLayout[r][c];
                        if (frameId > 0) {
                            if (!tempFrames.has(frameId)) {
                                tempFrames.set(frameId, { pieces: [], minR: r, minC: c });
                            }
                            const data = tempFrames.get(frameId);
                            data.pieces.push({ r, c });
                            data.minR = Math.min(data.minR, r);
                            data.minC = Math.min(data.minC, c);
                        }
                    }
                }

                tempFrames.forEach(data => {
                    data.pieceSet = new Set(data.pieces.map(p => `${p.r},${p.c}`));
                });

                tempFrames.forEach((data, id) => {
                    const anchor = { r: data.minR, c: data.minC };
                    const frame = {
                        id: id,
                        anchor: anchor,
                        pieces: [],
                        domElements: []
                    };

                    const pieceSet = data.pieceSet;

                    data.pieces.forEach(pos => {
                        const offset = { r: pos.r - anchor.r, c: pos.c - anchor.c };
                        frame.pieces.push(offset);

                        const pieceElement = document.createElement('div');
                        pieceElement.classList.add('frame-piece');
                        pieceElement.dataset.frameId = id;

                        pieceElement.style.gridRow = pos.r + 1;
                        pieceElement.style.gridColumn = pos.c + 1;

                        const r = pos.r;
                        const c = pos.c;

                        const hasTop = pieceSet.has(`${r - 1},${c}`);
                        const hasBottom = pieceSet.has(`${r + 1},${c}`);
                        const hasLeft = pieceSet.has(`${r},${c - 1}`);
                        const hasRight = pieceSet.has(`${r},${c + 1}`);

                        const shadows = [];
                        const radius = '8px';

                        if (!hasTop) shadows.push("inset 0 4px 0 0 #E53E3E");
                        if (!hasBottom) shadows.push("inset 0 -4px 0 0 #E53E3E");
                        if (!hasLeft) shadows.push("inset 4px 0 0 0 #E53E3E");
                        if (!hasRight) shadows.push("inset -4px 0 0 0 #E53E3E");

                        pieceElement.style.boxShadow = shadows.join(', ');

                        pieceElement.style.borderRadius = '0';
                        if (!hasTop && !hasLeft) pieceElement.style.borderTopLeftRadius = radius;
                        if (!hasTop && !hasRight) pieceElement.style.borderTopRightRadius = radius;
                        if (!hasBottom && !hasLeft) pieceElement.style.borderBottomLeftRadius = radius;
                        if (!hasBottom && !hasRight) pieceElement.style.borderBottomRightRadius = radius;

                        pieceElement.addEventListener('mousedown', handleDragStart);
                        pieceElement.addEventListener('touchstart', handleDragStart, { passive: false });

                        frame.domElements.push(pieceElement);
                        framePiecesDOM.push(pieceElement);
                    });

                    frames.push(frame);
                });

                boardElement.append(...framePiecesDOM);
            }

            // --- ã‚°ãƒ©ãƒ•åˆæœŸåŒ– (åˆå›1å›ã®ã¿) ---
            function initAllCharts() {
                initChartA();
                initChartB();
                initChartC();
                initChartD();
            }

            // ã‚°ãƒ©ãƒ•A (æ£’ã‚°ãƒ©ãƒ•) ã®é™çš„è¦ç´ ã‚’åˆæœŸåŒ– (å¤‰æ›´ãªã—)
            function initChartA() {
                const svg = document.getElementById('chart-svg-A');
                const svgNS = "http://www.w3.org/2000/svg";
                const chartBottomY = 230;
                const barWidth = 40;

                const axis = document.createElementNS(svgNS, 'line');
                axis.setAttribute('x1', '20');
                axis.setAttribute('y1', chartBottomY - 20);
                axis.setAttribute('x2', '180');
                axis.setAttribute('y2', chartBottomY - 20);
                axis.setAttribute('stroke', '#333');
                axis.setAttribute('stroke-width', '2');
                svg.appendChild(axis);

                const xApple = 60;
                const targetStarApple = createStar(
                    'star-dashed star-dashed-apple',
                    xApple,
                    chartBottomY - 20
                );
                targetStarApple.id = 'target-star-A-apple';

                const barApple = document.createElementNS(svgNS, 'rect');
                barApple.setAttribute('id', 'bar-apple');
                barApple.setAttribute('class', 'bar-apple');
                barApple.setAttribute('x', xApple - barWidth / 2);
                barApple.setAttribute('width', barWidth);
                barApple.setAttribute('rx', '4');

                const currentStarApple = createStar(
                    'star star-solid-apple',
                    xApple,
                    chartBottomY - 20
                );
                currentStarApple.setAttribute('id', 'star-apple');

                const iconApple = document.createElementNS(svgNS, 'text');
                iconApple.setAttribute('id', 'icon-A-apple');
                iconApple.setAttribute('class', 'chart-icon');
                iconApple.setAttribute('x', xApple);
                iconApple.setAttribute('y', chartBottomY + 5);
                iconApple.setAttribute('text-anchor', 'middle');
                iconApple.textContent = 'ğŸ';

                const xGrape = 140;
                const targetStarGrape = createStar(
                    'star-dashed star-dashed-grape',
                    xGrape,
                    chartBottomY - 20
                );
                targetStarGrape.id = 'target-star-A-grape';

                const barGrape = document.createElementNS(svgNS, 'rect');
                barGrape.setAttribute('id', 'bar-grape');
                barGrape.setAttribute('class', 'bar-grape');
                barGrape.setAttribute('x', xGrape - barWidth / 2);
                barGrape.setAttribute('width', barWidth);
                barGrape.setAttribute('rx', '4');

                const currentStarGrape = createStar(
                    'star star-solid-grape',
                    xGrape,
                    chartBottomY - 20
                );
                currentStarGrape.setAttribute('id', 'star-grape');

                const iconGrape = document.createElementNS(svgNS, 'text');
                iconGrape.setAttribute('id', 'icon-A-grape');
                iconGrape.setAttribute('class', 'chart-icon');
                iconGrape.setAttribute('x', xGrape);
                iconGrape.setAttribute('y', chartBottomY + 5);
                iconGrape.setAttribute('text-anchor', 'middle');
                iconGrape.textContent = 'ğŸ‡';

                const xKiwi = 100;
                const targetStarKiwi = createStar(
                    'star-dashed star-dashed-kiwi',
                    xKiwi,
                    chartBottomY - 20
                );
                targetStarKiwi.id = 'target-star-A-kiwi';

                const barKiwi = document.createElementNS(svgNS, 'rect');
                barKiwi.setAttribute('id', 'bar-kiwi');
                barKiwi.setAttribute('class', 'bar-kiwi');
                barKiwi.setAttribute('x', xKiwi - barWidth / 2);
                barKiwi.setAttribute('width', barWidth);
                barKiwi.setAttribute('rx', '4');

                const currentStarKiwi = createStar(
                    'star star-solid-kiwi',
                    xKiwi,
                    chartBottomY - 20
                );
                currentStarKiwi.setAttribute('id', 'star-kiwi');

                const iconKiwi = document.createElementNS(svgNS, 'text');
                iconKiwi.setAttribute('id', 'icon-A-kiwi');
                iconKiwi.setAttribute('class', 'chart-icon');
                iconKiwi.setAttribute('x', xKiwi);
                iconKiwi.setAttribute('y', chartBottomY + 5);
                iconKiwi.setAttribute('text-anchor', 'middle');
                iconKiwi.textContent = 'ğŸ¥';

                svg.appendChild(barApple);
                svg.appendChild(barGrape);
                svg.appendChild(barKiwi);
                svg.appendChild(targetStarApple);
                svg.appendChild(currentStarApple);
                svg.appendChild(targetStarGrape);
                svg.appendChild(currentStarGrape);
                svg.appendChild(targetStarKiwi);
                svg.appendChild(currentStarKiwi);
                svg.appendChild(iconApple);
                svg.appendChild(iconGrape);
                svg.appendChild(iconKiwi);
            }

            // ã‚°ãƒ©ãƒ•B (æ•£å¸ƒå›³) ã®é™çš„è¦ç´ ã‚’åˆæœŸåŒ– (å¤‰æ›´ãªã—)
            function initChartB() {
                const svg = document.getElementById('chart-svg-B');
                const svgNS = "http://www.w3.org/2000/svg";
                const maxCount = 7;
                const chartWidth = 200;
                const chartHeight = 200;
                const origin = { x: 25, y: 225 };

                const getX = (count) => origin.x + (count * (chartWidth / maxCount));
                const getY = (count) => origin.y - (count * (chartHeight / maxCount));

                const yAxis = document.createElementNS(svgNS, 'line');
                yAxis.setAttribute('class', 'axis');
                yAxis.setAttribute('x1', origin.x);
                yAxis.setAttribute('y1', origin.y);
                yAxis.setAttribute('x2', origin.x);
                yAxis.setAttribute('y2', origin.y - chartHeight);
                svg.appendChild(yAxis);

                const yIcon = document.createElementNS(svgNS, 'text');
                yIcon.setAttribute('class', 'chart-icon');
                yIcon.setAttribute('x', origin.x - 10);
                yIcon.setAttribute('y', origin.y - chartHeight);
                yIcon.setAttribute('text-anchor', 'end');
                yIcon.textContent = 'ğŸ';
                svg.appendChild(yIcon);

                const xAxis = document.createElementNS(svgNS, 'line');
                xAxis.setAttribute('class', 'axis');
                xAxis.setAttribute('x1', origin.x);
                xAxis.setAttribute('y1', origin.y);
                xAxis.setAttribute('x2', origin.x + chartWidth);
                xAxis.setAttribute('y2', origin.y);
                svg.appendChild(xAxis);

                const xIcon = document.createElementNS(svgNS, 'text');
                xIcon.setAttribute('class', 'chart-icon');
                xIcon.setAttribute('x', origin.x + chartWidth);
                xIcon.setAttribute('y', origin.y + 25);
                xIcon.setAttribute('text-anchor', 'middle');
                xIcon.textContent = 'ğŸ‡';
                svg.appendChild(xIcon);

                for (let i = 1; i <= maxCount; i++) {
                    const gx = getX(i);
                    const gy = getY(i);

                    const tickX = document.createElementNS(svgNS, 'line');
                    tickX.setAttribute('x1', gx);
                    tickX.setAttribute('y1', origin.y - 5);
                    tickX.setAttribute('x2', gx);
                    tickX.setAttribute('y2', origin.y);
                    tickX.setAttribute('stroke', '#ccc');
                    svg.appendChild(tickX);

                    const tickY = document.createElementNS(svgNS, 'line');
                    tickY.setAttribute('x1', origin.x);
                    tickY.setAttribute('y1', gy);
                    tickY.setAttribute('x2', origin.x + 5);
                    tickY.setAttribute('y2', gy);
                    tickY.setAttribute('stroke', '#ccc');
                    svg.appendChild(tickY);
                }


                const targetStar = createStar(
                    'star-dashed star-dashed-b',
                    getX(0),
                    getY(0)
                );
                targetStar.id = 'target-star-B';

                const lineX = document.createElementNS(svgNS, 'line');
                lineX.setAttribute('id', 'guide-line-B-x');
                lineX.setAttribute('class', 'guide-line');
                svg.appendChild(lineX);
                const lineY = document.createElementNS(svgNS, 'line');
                lineY.setAttribute('id', 'guide-line-B-y');
                lineY.setAttribute('class', 'guide-line');
                svg.appendChild(lineY);

                const currentStar = createStar(
                    'star star-solid-b',
                    getX(0),
                    getY(0)
                );
                currentStar.id = 'star-B';

                svg.appendChild(targetStar);
                svg.appendChild(currentStar);

                const style = document.createElementNS(svgNS, 'style');
                style.textContent = `
                    .star-dashed-b { stroke: #F6AD55; fill: none; stroke-width: 2; stroke-dasharray: 0.6 0.6; }
                    .star-solid-b { fill: #F6AD55; stroke: #D69E2E; stroke-width: 1; }
                `;
                svg.appendChild(style);
            }

            // ã‚°ãƒ©ãƒ•C (å††ã‚°ãƒ©ãƒ•) ã®é™çš„è¦ç´ ã‚’åˆæœŸåŒ– (å¤‰æ›´ãªã—)
            function initChartC() {
                const svg = document.getElementById('chart-svg-C');
                const svgNS = "http://www.w3.org/2000/svg";
                const cx = 100;
                const cy = 120;
                const r = 80;

                const targetStarApple = createStar(
                    'star-dashed star-dashed-apple',
                    cx, cy - r
                );
                targetStarApple.id = 'target-star-C-apple';

                const targetStarGrape = createStar(
                    'star-dashed star-dashed-grape',
                    cx, cy - r
                );
                targetStarGrape.id = 'target-star-C-grape';
                targetStarGrape.style.display = 'none';

                const sliceKiwi = document.createElementNS(svgNS, 'path');
                sliceKiwi.id = 'pie-kiwi';
                sliceKiwi.setAttribute('class', 'pie-slice-kiwi');
                svg.appendChild(sliceKiwi);

                const sliceGrape = document.createElementNS(svgNS, 'path');
                sliceGrape.id = 'pie-grape';
                sliceGrape.setAttribute('class', 'pie-slice-grape');
                svg.appendChild(sliceGrape);

                const sliceApple = document.createElementNS(svgNS, 'path');
                sliceApple.id = 'pie-apple';
                sliceApple.setAttribute('class', 'pie-slice-apple');
                svg.appendChild(sliceApple);

                const iconApple = document.createElementNS(svgNS, 'text');
                iconApple.id = 'icon-C-apple';
                iconApple.setAttribute('class', 'chart-icon');
                iconApple.setAttribute('x', cx + r);
                iconApple.setAttribute('y', cy - r - 10);
                iconApple.setAttribute('text-anchor', 'middle');
                iconApple.textContent = 'ğŸ';
                svg.appendChild(iconApple);

                const iconGrape = document.createElementNS(svgNS, 'text');
                iconGrape.id = 'icon-C-grape';
                iconGrape.setAttribute('class', 'chart-icon');
                iconGrape.setAttribute('x', cx - r);
                iconGrape.setAttribute('y', cy - r - 10);
                iconGrape.setAttribute('text-anchor', 'middle');
                iconGrape.textContent = 'ğŸ‡';
                svg.appendChild(iconGrape);

                const iconKiwi = document.createElementNS(svgNS, 'text');
                iconKiwi.id = 'icon-C-kiwi';
                iconKiwi.setAttribute('class', 'chart-icon');
                iconKiwi.setAttribute('x', cx);
                iconKiwi.setAttribute('y', cy - r - 10);
                iconKiwi.setAttribute('text-anchor', 'middle');
                iconKiwi.textContent = 'ğŸ¥';
                iconKiwi.style.display = 'none';
                svg.appendChild(iconKiwi);


                const currentStarApple = createStar(
                    'star star-solid-apple',
                    cx, cy - r
                );
                currentStarApple.id = 'star-C-apple';

                const currentStarGrape = createStar(
                    'star star-solid-grape',
                    cx, cy - r
                );
                currentStarGrape.id = 'star-C-grape';
                currentStarGrape.style.display = 'none';

                svg.appendChild(targetStarApple);
                svg.appendChild(targetStarGrape);
                svg.appendChild(currentStarApple);
                svg.appendChild(currentStarGrape);
            }

            // ã‚°ãƒ©ãƒ•D (å¸¯ã‚°ãƒ©ãƒ•) ã®é™çš„è¦ç´ ã‚’åˆæœŸåŒ– (å¤‰æ›´ãªã—)
            function initChartD() {
                // JSã§åˆæœŸåŒ–ã™ã‚‹é™çš„è¦ç´ ã¯ç‰¹ã«ãªã—
            }

            // ã‚°ãƒ©ãƒ•ã®ã€Œç›®æ¨™ã€ã‚’æ›´æ–°
            function updateChartTargets(graphType, targets) {
                const svgNS = "http://www.w3.org/2000/svg";

                switch (graphType) {
                    case 'A': {
                        const chartBottomY = 230;
                        const chartHeight = 200;
                        const hasGrape = targets.grape !== undefined;
                        const hasKiwi = targets.kiwi !== undefined;
                        const maxCount = Math.max(5, (targets.apple || 0), (targets.grape || 0), (targets.kiwi || 0)) + 1;

                        const getY = (count) => chartBottomY - 20 - (count * (chartHeight / maxCount));

                        const xApple = hasKiwi ? 40 : (hasGrape ? 60 : 100);
                        const xGrape = hasKiwi ? 100 : 140;
                        const xKiwi = 160;
                        const barWidth = 40;

                        const targetApple = document.getElementById('target-star-A-apple');
                        const barApple = document.getElementById('bar-apple');
                        const starApple = document.getElementById('star-apple');
                        const iconApple = document.getElementById('icon-A-apple');

                        const targetGrape = document.getElementById('target-star-A-grape');
                        const barGrape = document.getElementById('bar-grape');
                        const starGrape = document.getElementById('star-grape');
                        const iconGrape = document.getElementById('icon-A-grape');

                        const targetKiwi = document.getElementById('target-star-A-kiwi');
                        const barKiwi = document.getElementById('bar-kiwi');
                        const starKiwi = document.getElementById('star-kiwi');
                        const iconKiwi = document.getElementById('icon-A-kiwi');

                        const targetYApple = getY(targets.apple);
                        targetApple.setAttribute('transform', `translate(${xApple - STAR_OFFSET}, ${targetYApple - STAR_OFFSET}) scale(1.2)`);
                        barApple.setAttribute('x', xApple - barWidth / 2);
                        iconApple.setAttribute('x', xApple);
                        iconApple.setAttribute('y', chartBottomY + 5);
                        starApple.setAttribute('transform', `translate(${xApple - STAR_OFFSET}, ${getY(0) - STAR_OFFSET}) scale(1.2)`);

                        if (hasGrape) {
                            const targetYGrape = getY(targets.grape);
                            targetGrape.setAttribute('transform', `translate(${xGrape - STAR_OFFSET}, ${targetYGrape - STAR_OFFSET}) scale(1.2)`);
                            barGrape.setAttribute('x', xGrape - barWidth / 2);
                            iconGrape.setAttribute('x', xGrape);
                            iconGrape.setAttribute('y', chartBottomY + 5);
                            starGrape.setAttribute('transform', `translate(${xGrape - STAR_OFFSET}, ${getY(0) - STAR_OFFSET}) scale(1.2)`);

                            targetGrape.style.display = 'block';
                            barGrape.style.display = 'block';
                            starGrape.style.display = 'block';
                            iconGrape.style.display = 'block';
                        } else {
                            targetGrape.style.display = 'none';
                            barGrape.style.display = 'none';
                            starGrape.style.display = 'none';
                            iconGrape.style.display = 'none';
                        }

                        if (hasKiwi) {
                            const targetYKiwi = getY(targets.kiwi);
                            targetKiwi.setAttribute('transform', `translate(${xKiwi - STAR_OFFSET}, ${targetYKiwi - STAR_OFFSET}) scale(1.2)`);
                            barKiwi.setAttribute('x', xKiwi - barWidth / 2);
                            iconKiwi.setAttribute('x', xKiwi);
                            iconKiwi.setAttribute('y', chartBottomY + 5);
                            starKiwi.setAttribute('transform', `translate(${xKiwi - STAR_OFFSET}, ${getY(0) - STAR_OFFSET}) scale(1.2)`);

                            targetKiwi.style.display = 'block';
                            barKiwi.style.display = 'block';
                            starKiwi.style.display = 'block';
                            iconKiwi.style.display = 'block';
                        } else {
                            targetKiwi.style.display = 'none';
                            barKiwi.style.display = 'none';
                            starKiwi.style.display = 'none';
                            iconKiwi.style.display = 'none';
                        }

                        break;
                    }
                    case 'B': {
                        const maxCount = 7;
                        const chartWidth = 200;
                        const chartHeight = 200;
                        const origin = { x: 25, y: 225 };

                        const getX = (count) => origin.x + (count * (chartWidth / maxCount));
                        const getY = (count) => origin.y - (count * (chartHeight / maxCount));

                        const tx = getX(targets.grape);
                        const ty = getY(targets.apple);

                        document.getElementById('target-star-B').setAttribute('transform', `translate(${tx - STAR_OFFSET}, ${ty - STAR_OFFSET}) scale(1.2)`);
                        break;
                    }
                    case 'C': {
                        const cx = 100, cy = 120, r = 80;
                        const total = (targets.apple || 0) + (targets.grape || 0) + (targets.kiwi || 0);
                        const hasKiwi = (targets.kiwi || 0) > 0;

                        const iconApple = document.getElementById('icon-C-apple');
                        const iconGrape = document.getElementById('icon-C-grape');
                        const iconKiwi = document.getElementById('icon-C-kiwi');

                        if (hasKiwi) {
                            // 3ç¨®: Kiwi(å·¦ä¸Š), Apple(å³ä¸Š), Grape(ä¸‹ä¸­å¤®)
                            iconKiwi.style.display = 'block';

                            // Kiwi (å·¦ä¸Š)
                            iconKiwi.setAttribute('x', cx - r);
                            iconKiwi.setAttribute('y', cy - r - 10);

                            // Apple (å³ä¸Š)
                            iconApple.setAttribute('x', cx + r);
                            iconApple.setAttribute('y', cy - r - 10);

                            // Grape (ä¸‹ä¸­å¤®)
                            iconGrape.setAttribute('x', cx);
                            iconGrape.setAttribute('y', cy + r + 40);
                            iconGrape.style.display = 'block';

                        } else {
                            // 2ç¨®: Grape(å·¦ä¸Š), Apple(å³ä¸Š)
                            iconKiwi.style.display = 'none';

                            // Apple (å³ä¸Š)
                            iconApple.setAttribute('x', cx + r);
                            iconApple.setAttribute('y', cy - r - 10);

                            // Grape (å·¦ä¸Š)
                            iconGrape.setAttribute('x', cx - r);
                            iconGrape.setAttribute('y', cy - r - 10);
                            iconGrape.style.display = 'block';
                        }

                        const ratioApple = (total > 0) ? ((targets.apple || 0) / total) : 0;
                        const angleRadApple = (ratioApple * 2 * Math.PI) - (Math.PI / 2);
                        const txApple = cx + r * Math.cos(angleRadApple);
                        const tyApple = cy + r * Math.sin(angleRadApple);
                        document.getElementById('target-star-C-apple').setAttribute('transform', `translate(${txApple - STAR_OFFSET}, ${tyApple - STAR_OFFSET}) scale(1.2)`);

                        const starGrape = document.getElementById('target-star-C-grape');
                        if (hasKiwi) {
                            const ratioGrape = (total > 0) ? (((targets.apple || 0) + (targets.grape || 0)) / total) : 0;
                            const angleRadGrape = (ratioGrape * 2 * Math.PI) - (Math.PI / 2);
                            const txGrape = cx + r * Math.cos(angleRadGrape);
                            const tyGrape = cy + r * Math.sin(angleRadGrape);
                            starGrape.setAttribute('transform', `translate(${txGrape - STAR_OFFSET}, ${tyGrape - STAR_OFFSET}) scale(1.2)`);
                            starGrape.style.display = 'block';
                        } else {
                            starGrape.style.display = 'none';
                        }

                        break;
                    }
                    case 'D': {
                        const total = (targets.apple || 0) + (targets.grape || 0) + (targets.kiwi || 0);
                        const hasKiwi = (targets.kiwi || 0) > 0;

                        const iconContainer = document.getElementById('bar-D-icons');
                        const iconApple = iconContainer.querySelector('.icon-apple');
                        const iconGrape = iconContainer.querySelector('.icon-grape');
                        const iconKiwi = iconContainer.querySelector('.icon-kiwi');

                        document.getElementById('bar-D-kiwi').style.display = hasKiwi ? 'block' : 'none';

                        if (hasKiwi) {
                            // 3ç¨®: Apple, Grape, Kiwi ã®é †ã«ä¸¦ã¹æ›¿ãˆ
                            iconContainer.classList.add('three-fruits');
                            iconKiwi.style.display = 'inline';

                            iconContainer.appendChild(iconApple);
                            iconContainer.appendChild(iconGrape);
                            iconContainer.appendChild(iconKiwi);

                        } else {
                            // 2ç¨®: Apple, Grape ã®é †
                            iconContainer.classList.remove('three-fruits');
                            iconKiwi.style.display = 'none';

                            iconContainer.appendChild(iconApple);
                            iconContainer.appendChild(iconGrape);
                        }

                        const ratioApple = (total > 0) ? (((targets.apple || 0) / total) * 100) : 0;
                        document.getElementById('star-D-target-apple').style.left = `${ratioApple}%`;

                        const starGrapeTarget = document.getElementById('star-D-target-grape');
                        const starGrapeCurrent = document.getElementById('star-D-current-grape');
                        if (hasKiwi) {
                            const ratioAppleGrape = (total > 0) ? ((((targets.apple || 0) + (targets.grape || 0)) / total) * 100) : 0;
                            starGrapeTarget.style.left = `${ratioAppleGrape}%`;
                            starGrapeTarget.style.display = 'block';
                            starGrapeCurrent.style.display = 'block';
                        } else {
                            starGrapeTarget.style.display = 'none';
                            starGrapeCurrent.style.display = 'none';
                        }

                        break;
                    }
                }
            }

            // æ˜Ÿã®SVGè¦ç´ ã‚’ä½œæˆã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼ (å¤‰æ›´ãªã—)
            function createStar(className, cx, cy) {
                const svgNS = "http://www.w3.org/2000/svg";
                const g = document.createElementNS(svgNS, 'g');
                g.setAttribute('class', className);

                const path = document.createElementNS(svgNS, 'path');
                path.setAttribute('d', STAR_PATH_D);

                g.appendChild(path);
                g.setAttribute('transform', `translate(${cx - STAR_OFFSET}, ${cy - STAR_OFFSET}) scale(1.2)`);
                return g;
            }

            // --- 3. ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ ---

            function updateGame(animate = true) {
                calculateCounts();
                updateChart(animate);
                checkWin();
            }

            // æ å†…ã®æœç‰©ã‚’æ•°ãˆã‚‹ (å¤‰æ›´ãªã—)
            function calculateCounts() {
                const counts = { apple: 0, grape: 0, kiwi: 0 };
                const occupiedCells = new Set();

                frames.forEach(frame => {
                    const anchor = frame.anchor;
                    frame.pieces.forEach(offset => {
                        const r = anchor.r + offset.r;
                        const c = anchor.c + offset.c;

                        if (r < 0 || r >= boardRows || c < 0 || c >= boardCols) {
                            return;
                        }

                        const cellKey = `${r},${c}`;
                        if (occupiedCells.has(cellKey)) {
                            return;
                        }
                        occupiedCells.add(cellKey);

                        const fruit = currentStage.fruits[r][c];
                        if (fruit === 'a') {
                            counts.apple++;
                        } else if (fruit === 'g') {
                            counts.grape++;
                        } else if (fruit === 'k') {
                            counts.kiwi++;
                        }
                    });
                });

                currentCounts = counts;
            }

            // ã‚°ãƒ©ãƒ•(æ£’ã¨æ˜Ÿ)ã‚’æ›´æ–° (å¤‰æ›´ãªã—)
            function updateChart(animate) {
                if (!currentStage) return;

                const graphType = currentStage.graphType;

                switch (graphType) {
                    case 'A':
                        updateChartA(animate);
                        break;
                    case 'B':
                        updateChartB(animate);
                        break;
                    case 'C':
                        updateChartC(animate);
                        break;
                    case 'D':
                        updateChartD(animate);
                        break;
                }
            }

            // ã‚°ãƒ©ãƒ•A (æ£’ã‚°ãƒ©ãƒ•) ã®æ›´æ–° (å¤‰æ›´ãªã—)
            function updateChartA(animate) {
                const transitionSetting = animate ? '' : 'transition: none;';

                const targets = currentStage.targets;
                const hasGrape = targets.grape !== undefined;
                const hasKiwi = targets.kiwi !== undefined;
                const maxCount = Math.max(5, (targets.apple || 0), (targets.grape || 0), (targets.kiwi || 0)) + 1;
                const chartHeight = 200;
                const chartBottomY = 230;

                const getY = (count) => chartBottomY - 20 - (count * (chartHeight / maxCount));
                const getH = (count) => (count * (chartHeight / maxCount));

                const xApple = hasKiwi ? 40 : (hasGrape ? 60 : 100);
                const xGrape = hasKiwi ? 100 : 140;
                const xKiwi = 160;
                const barWidth = 40;

                const appleCount = currentCounts.apple;
                const yApple = getY(appleCount);
                const hApple = getH(appleCount);

                const barApple = document.getElementById('bar-apple');
                barApple.setAttribute('x', xApple - barWidth / 2);
                barApple.setAttribute('y', yApple);
                barApple.setAttribute('height', hApple);
                barApple.style.cssText = transitionSetting;

                const starApple = document.getElementById('star-apple');
                starApple.setAttribute('transform', `translate(${xApple - STAR_OFFSET}, ${yApple - STAR_OFFSET}) scale(1.2)`);
                starApple.style.cssText = transitionSetting;

                if (hasGrape) {
                    const grapeCount = currentCounts.grape;
                    const yGrape = getY(grapeCount);
                    const hGrape = getH(grapeCount);

                    const barGrape = document.getElementById('bar-grape');
                    barGrape.setAttribute('x', xGrape - barWidth / 2);
                    barGrape.setAttribute('y', yGrape);
                    barGrape.setAttribute('height', hGrape);
                    barGrape.style.cssText = transitionSetting;

                    const starGrape = document.getElementById('star-grape');
                    starGrape.setAttribute('transform', `translate(${xGrape - STAR_OFFSET}, ${yGrape - STAR_OFFSET}) scale(1.2)`);
                    starGrape.style.cssText = transitionSetting;
                }

                if (hasKiwi) {
                    const kiwiCount = currentCounts.kiwi;
                    const yKiwi = getY(kiwiCount);
                    const hKiwi = getH(kiwiCount);

                    const barKiwi = document.getElementById('bar-kiwi');
                    barKiwi.setAttribute('x', xKiwi - barWidth / 2);
                    barKiwi.setAttribute('y', yKiwi);
                    barKiwi.setAttribute('height', hKiwi);
                    barKiwi.style.cssText = transitionSetting;

                    const starKiwi = document.getElementById('star-kiwi');
                    starKiwi.setAttribute('transform', `translate(${xKiwi - STAR_OFFSET}, ${yKiwi - STAR_OFFSET}) scale(1.2)`);
                    starKiwi.style.cssText = transitionSetting;
                }
            }

            // ã‚°ãƒ©ãƒ•B (æ•£å¸ƒå›³) ã®æ›´æ–° (å¤‰æ›´ãªã—)
            function updateChartB(animate) {
                const transitionSetting = animate ? '' : 'transition: none;';

                const maxCount = 7;
                const chartWidth = 200;
                const chartHeight = 200;
                const origin = { x: 25, y: 225 };

                const getX = (count) => origin.x + (count * (chartWidth / maxCount));
                const getY = (count) => origin.y - (count * (chartHeight / maxCount));

                const cx = getX(currentCounts.grape);
                const cy = getY(currentCounts.apple);

                const star = document.getElementById('star-B');
                star.setAttribute('transform', `translate(${cx - STAR_OFFSET}, ${cy - STAR_OFFSET}) scale(1.2)`);
                star.style.cssText = transitionSetting;

                const lineX = document.getElementById('guide-line-B-x');
                lineX.setAttribute('x1', origin.x);
                lineX.setAttribute('y1', cy);
                lineX.setAttribute('x2', cx);
                lineX.setAttribute('y2', cy);
                lineX.style.cssText = transitionSetting;

                const lineY = document.getElementById('guide-line-B-y');
                lineY.setAttribute('x1', cx);
                lineY.setAttribute('y1', origin.y);
                lineY.setAttribute('x2', cx);
                lineY.setAttribute('y2', cy);
                lineY.style.cssText = transitionSetting;
            }

            // ã‚°ãƒ©ãƒ•C (å††ã‚°ãƒ©ãƒ•) ã®æ›´æ–° (å¤‰æ›´ãªã—)
            function updateChartC(animate) {
                const transitionSetting = animate ? '' : 'transition: none;';

                const cx = 100, cy = 120, r = 80;
                const total = currentCounts.apple + currentCounts.grape + currentCounts.kiwi;
                const hasKiwi = (currentStage.targets.kiwi || 0) > 0 || currentCounts.kiwi > 0;

                const ratioApple = (total > 0) ? (currentCounts.apple / total) : 0;
                const ratioGrape = (total > 0) ? (currentCounts.grape / total) : 0;

                const angleRatioApple = Math.max(0, Math.min(1, ratioApple));
                const angleRatioGrape = Math.max(0, Math.min(1, ratioApple + ratioGrape));

                const angleRadApple = (angleRatioApple * 2 * Math.PI) - (Math.PI / 2);
                const angleRadGrape = (angleRatioGrape * 2 * Math.PI) - (Math.PI / 2);

                const getArcPath = (startRatio, endRatio) => {
                    if (Math.abs(endRatio - startRatio) < 0.0001) return "";
                    if (Math.abs(endRatio - startRatio) >= 0.9999) {
                        const midRad = (startRatio + (endRatio - startRatio) / 2) * 2 * Math.PI - (Math.PI / 2);
                        const mx = cx + r * Math.cos(midRad);
                        const my = cy + r * Math.sin(midRad);
                        const endRad = endRatio * 2 * Math.PI - (Math.PI / 2);
                        const ex = cx + r * Math.cos(endRad);
                        const ey = cy + r * Math.sin(endRad);
                        const startRad = startRatio * 2 * Math.PI - (Math.PI / 2);
                        const sx = cx + r * Math.cos(startRad);
                        const sy = cy + r * Math.sin(startRad);
                        return `M ${cx} ${cy} L ${sx} ${sy} A ${r} ${r} 0 0 1 ${mx} ${my} A ${r} ${r} 0 0 1 ${ex} ${ey} Z`;
                    }

                    const startRad = startRatio * 2 * Math.PI - (Math.PI / 2);
                    const endRad = endRatio * 2 * Math.PI - (Math.PI / 2);
                    const sx = cx + r * Math.cos(startRad);
                    const sy = cy + r * Math.sin(startRad);
                    const ex = cx + r * Math.cos(endRad);
                    const ey = cy + r * Math.sin(endRad);
                    const largeArcFlag = (endRatio - startRatio) > 0.5 ? 1 : 0;
                    return `M ${cx} ${cy} L ${sx} ${sy} A ${r} ${r} 0 ${largeArcFlag} 1 ${ex} ${ey} Z`;
                };

                const applePath = (total > 0) ? getArcPath(0, angleRatioApple) : "";
                const grapePath = (total > 0) ? getArcPath(angleRatioApple, angleRatioGrape) : "";
                const kiwiPath = (total > 0 && hasKiwi) ? getArcPath(angleRatioGrape, 1) : "";

                const sliceApple = document.getElementById('pie-apple');
                const sliceGrape = document.getElementById('pie-grape');
                const sliceKiwi = document.getElementById('pie-kiwi');

                sliceApple.setAttribute('d', applePath);
                sliceGrape.setAttribute('d', grapePath);
                sliceKiwi.setAttribute('d', kiwiPath);

                const starXApple = cx + r * Math.cos(angleRadApple);
                const starYApple = cy + r * Math.sin(angleRadApple);
                const starApple = document.getElementById('star-C-apple');
                starApple.setAttribute('transform', `translate(${starXApple - 12}, ${starYApple - 12}) scale(1.2)`);
                starApple.style.cssText = transitionSetting;

                const starGrape = document.getElementById('star-C-grape');
                if (hasKiwi) {
                    const starXGrape = cx + r * Math.cos(angleRadGrape);
                    const starYGrape = cy + r * Math.sin(angleRadGrape);
                    starGrape.setAttribute('transform', `translate(${starXGrape - 12}, ${starYGrape - 12}) scale(1.2)`);
                    starGrape.style.cssText = transitionSetting;
                    starGrape.style.display = 'block';
                } else {
                    starGrape.style.display = 'none';
                }
            }

            // ã‚°ãƒ©ãƒ•D (å¸¯ã‚°ãƒ©ãƒ•) ã®æ›´æ–° (å¤‰æ›´ãªã—)
            function updateChartD(animate) {
                const total = currentCounts.apple + currentCounts.grape + currentCounts.kiwi;
                const hasKiwi = (currentStage.targets.kiwi || 0) > 0 || currentCounts.kiwi > 0;

                const ratioApple = (total > 0) ? (currentCounts.apple / total) : 0;
                const ratioGrape = (total > 0) ? (currentCounts.grape / total) : 0;
                const ratioKiwi = (total > 0) ? (currentCounts.kiwi / total) : 0;

                const percentApple = ratioApple * 100;
                const percentGrape = ratioGrape * 100;
                const percentKiwi = ratioKiwi * 100;

                const barApple = document.getElementById('bar-D-apple');
                const barGrape = document.getElementById('bar-D-grape');
                const barKiwi = document.getElementById('bar-D-kiwi');
                const starApple = document.getElementById('star-D-current-apple');
                const starGrape = document.getElementById('star-D-current-grape');

                barApple.style.width = `${percentApple}%`;
                barGrape.style.width = `${percentGrape}%`;
                barKiwi.style.width = `${percentKiwi}%`;

                starApple.style.left = `${percentApple}%`;

                barApple.style.transition = animate ? 'width 0.3s ease-in-out' : 'none';
                barGrape.style.transition = animate ? 'width 0.3s ease-in-out' : 'none';
                barKiwi.style.transition = animate ? 'width 0.3s ease-in-out' : 'none';
                starApple.style.transition = animate ? 'left 0.3s ease-in-out' : 'none';

                if (hasKiwi) {
                    const percentAppleGrape = (ratioApple + ratioGrape) * 100;
                    starGrape.style.left = `${percentAppleGrape}%`;
                    starGrape.style.transition = animate ? 'left 0.3s ease-in-out' : 'none';
                    starGrape.style.display = 'block';
                } else {
                    starGrape.style.display = 'none';
                }
            }


            // å‹åˆ©æ¡ä»¶ã‚’ãƒã‚§ãƒƒã‚¯
            function checkWin() {
                if (!currentStage) return;

                const targets = currentStage.targets;
                const graphType = currentStage.graphType;
                let isWin = false;

                if (graphType === 'A') {
                    const hasGrapeTarget = targets.grape !== undefined;
                    const hasKiwiTarget = targets.kiwi !== undefined;

                    if (hasKiwiTarget) {
                        isWin = (currentCounts.apple === targets.apple &&
                            currentCounts.grape === targets.grape &&
                            currentCounts.kiwi === targets.kiwi);
                    } else if (hasGrapeTarget) {
                        isWin = (currentCounts.apple === targets.apple &&
                            currentCounts.grape === targets.grape);
                    } else {
                        isWin = (currentCounts.apple === targets.apple);
                    }
                } else if (graphType === 'B') {
                    isWin = (currentCounts.apple === targets.apple &&
                        currentCounts.grape === targets.grape);
                } else {
                    const targetTotal = (targets.apple || 0) + (targets.grape || 0) + (targets.kiwi || 0);
                    const hasKiwiTarget = (targets.kiwi || 0) > 0;

                    const targetRatioApple = (targetTotal > 0) ? ((targets.apple || 0) / targetTotal) : 0;
                    const targetRatioGrape = (targetTotal > 0) ? ((targets.grape || 0) / targetTotal) : 0;

                    const currentTotal = currentCounts.apple + currentCounts.grape + currentCounts.kiwi;
                    const currentRatioApple = (currentTotal > 0) ? (currentCounts.apple / currentTotal) : 0;
                    const currentRatioGrape = (currentTotal > 0) ? (currentCounts.grape / currentTotal) : 0;

                    if (currentTotal === 0 && targetTotal > 0) {
                        isWin = false;
                    }
                    else if (targetTotal === 0 && currentTotal === 0) {
                        isWin = true;
                    }
                    else {
                        const appleMatch = Math.abs(currentRatioApple - targetRatioApple) < 0.001;
                        const grapeMatch = Math.abs(currentRatioGrape - targetRatioGrape) < 0.001;

                        if (hasKiwiTarget) {
                            isWin = appleMatch && grapeMatch;
                        } else {
                            isWin = appleMatch;
                        }
                    }
                }

                if (isWin) {
                    winMessageElement.classList.add('active'); // è¡¨ç¤º

                    if (currentStage && !clearedStages.has(currentStage.id)) {
                        clearedStages.add(currentStage.id);
                        saveClearedStages();
                        updateStageSelectUI();
                    }
                    if (currentStageIndex < stages.length - 1) {
                        nextButton.classList.add('animate-pulse');
                    }

                } else {
                    winMessageElement.classList.remove('active'); // éè¡¨ç¤º
                    nextButton.classList.remove('animate-pulse');
                }
            }

            // æ ã®DOMä½ç½®ã‚’æ›´æ–° (å¤‰æ›´ãªã—)
            function updateFramePosition(frame, newAnchor) {
                frame.anchor = newAnchor;
                frame.domElements.forEach((el, index) => {
                    const offset = frame.pieces[index];
                    const newRow = newAnchor.r + offset.r + 1;
                    const newCol = newAnchor.c + offset.c + 1;
                    el.style.gridRow = newRow;
                    el.style.gridColumn = newCol;
                });
            }

            // --- 4. ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆ --- (å¤‰æ›´ãªã—)

            function handleDragStart(e) {
                if (isDragging) return;

                const frameId = parseInt(e.currentTarget.dataset.frameId, 10);
                activeFrame = frames.find(f => f.id === frameId);
                if (!activeFrame) return;

                isDragging = true;
                dragStartGrid = { ...activeFrame.anchor };
                lastDragGrid = { ...activeFrame.anchor };

                const pos = getEventPosition(e);
                dragStartPos = pos;

                activeFrame.domElements.forEach(el => el.classList.add('dragging'));

                window.addEventListener('mousemove', handleDragMove);
                window.addEventListener('mouseup', handleDragEnd);
                window.addEventListener('touchmove', handleDragMove, { passive: false });
                window.addEventListener('touchend', handleDragEnd);

                if (e.type === 'touchstart') {
                    e.preventDefault();
                }
            }

            function handleDragMove(e) {
                if (!isDragging || !activeFrame) return;

                e.preventDefault();

                const pos = getEventPosition(e);

                const cellRect = boardElement.children[0].getBoundingClientRect();
                const cellWidth = cellRect.width;
                const cellHeight = cellRect.height;

                const deltaX = pos.x - dragStartPos.x;
                const deltaY = pos.y - dragStartPos.y;

                const gridDeltaC = Math.round(deltaX / cellWidth);
                const gridDeltaR = Math.round(deltaY / cellHeight);

                let newR = dragStartGrid.r + gridDeltaR;
                let newC = dragStartGrid.c + gridDeltaC;

                if (newR !== lastDragGrid.r || newC !== lastDragGrid.c) {

                    if (Math.abs(newR - lastDragGrid.r) > 1) {
                        newR = lastDragGrid.r + Math.sign(newR - lastDragGrid.r);
                    }
                    if (Math.abs(newC - lastDragGrid.c) > 1) {
                        newC = lastDragGrid.c + Math.sign(newC - lastDragGrid.c);
                    }

                    if (isValidPosition(activeFrame, newR, newC)) {
                        updateFramePosition(activeFrame, { r: newR, c: newC });

                        lastDragGrid = { r: newR, c: newC };

                        updateGame(true);
                    } else {
                        newR = lastDragGrid.r;
                        newC = lastDragGrid.c;
                    }
                }
            }

            function handleDragEnd(e) {
                if (!isDragging || !activeFrame) return;

                isDragging = false;

                activeFrame.domElements.forEach(el => {
                    el.classList.remove('dragging');
                    el.style.transform = '';
                });

                activeFrame.anchor = { ...lastDragGrid };
                updateFramePosition(activeFrame, activeFrame.anchor);

                activeFrame = null;

                window.removeEventListener('mousemove', handleDragMove);
                window.removeEventListener('mouseup', handleDragEnd);
                window.removeEventListener('touchmove', handleDragMove);
                window.removeEventListener('touchend', handleDragEnd);

                updateGame(true);
            }

            function isValidPosition(frame, newR, newC) {
                for (const offset of frame.pieces) {
                    const r = newR + offset.r;
                    const c = newC + offset.c;

                    if (r < 0 || r >= boardRows || c < 0 || c >= boardCols) {
                        return false;
                    }
                }
                return true;
            }

            function getEventPosition(e) {
                if (e.touches && e.touches.length > 0) {
                    return { x: e.touches[0].clientX, y: e.touches[0].clientY };
                } else {
                    return { x: e.clientX, y: e.clientY };
                }
            }

            // --- 5. ã‚²ãƒ¼ãƒ é–‹å§‹ ---
            initApp();

        });
    </script>

</body>

</html>