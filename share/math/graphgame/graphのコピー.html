<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœç‰©ã‚ã¤ã‚ã‚²ãƒ¼ãƒ </title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Interãƒ•ã‚©ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã™ */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none; /* ãƒšãƒ¼ã‚¸ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é˜²æ­¢ */
        }

        /* --- ç›¤é¢ --- */
        #board-area {
            display: grid;
            grid-template-rows: repeat(4, 80px); /* 4è¡Œ x 80px */
            grid-template-columns: repeat(6, 80px); /* 6åˆ— x 80px */
            border: 2px solid #333;
            border-radius: 8px;
            overflow: hidden; /* æ ãŒã¯ã¿å‡ºãªã„ã‚ˆã†ã« */
            touch-action: none; /* ãƒ¢ãƒã‚¤ãƒ«ã§ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç„¡åŠ¹åŒ– */
            user-select: none;
            position: relative; /* æ ã®åŸºæº– */
            background-color: #FDFBF5; /* ç›¤é¢ã®è‰² */
        }
        
        @media (max-width: 1024px) {
            #board-area {
                /* ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ãƒã‚¹ã‚’å°ã•ãã™ã‚‹ */
                grid-template-rows: repeat(4, 12vw);
                grid-template-columns: repeat(6, 12vw);
                max-width: calc(12vw * 6 + 4px); /* (12vw * 6) + border */
                margin-left: auto;
                margin-right: auto;
            }
        }
        @media (min-width: 1024px) and (max-width: 1280px) {
            /* ä¸­é–“ã‚µã‚¤ã‚º */
            #board-area {
                grid-template-rows: repeat(4, 60px);
                grid-template-columns: repeat(6, 60px);
            }
        }


        .cell {
            border: 1px solid #ccc;
            box-sizing: border-box; /* borderã‚’å«ã‚ã¦ã‚µã‚¤ã‚ºè¨ˆç®— */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.5rem; /* æœç‰©ã®çµµæ–‡å­—ã‚µã‚¤ã‚º */
            user-select: none; /* ãƒ†ã‚­ã‚¹ãƒˆé¸æŠã‚’ç„¡åŠ¹åŒ– */
        }
        
        @media (max-width: 1024px) {
            .cell {
                font-size: 1.8rem;
            }
        }
         @media (min-width: 1024px) and (max-width: 1280px) {
            .cell {
                font-size: 2rem;
            }
        }

        /* èµ¤ã„æ ã®ãƒ”ãƒ¼ã‚¹ */
        .frame-piece {
            /* position: absolute; ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚°ãƒªãƒƒãƒ‰ã‚¢ã‚¤ãƒ†ãƒ ã¨ã—ã¦ã‚»ãƒ«ã«é‡ãªã‚Šã¾ã™ã€‚ */
            /* JSã§ grid-row/grid-column ã‚’è¨­å®šã—ã¾ã™ */
            /* border: 4px solid #E53E3E;  <-- JSã§ box-shadow inset ã‚’ä½¿ã†ãŸã‚å‰Šé™¤ */
            background-color: rgba(229, 62, 62, 0.3); /* åŠé€æ˜ã®èµ¤ã‚’è¿½åŠ  */
            /* border-radius: 4px; <-- JSã§åˆ¶å¾¡ã™ã‚‹ãŸã‚å‰Šé™¤ */
            box-sizing: border-box; /* borderã‚’å«ã‚ã¦ã‚µã‚¤ã‚ºè¨ˆç®— */
            z-index: 10;
            cursor: grab;
            transition: transform 0.1s ease-out; /* ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ç§»å‹•ã‚’æ»‘ã‚‰ã‹ã« */
        }

        .frame-piece.dragging {
            cursor: grabbing;
            opacity: 0.9;
            transform: scale(1.05); /* ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã«å°‘ã—å¤§ãã */
            z-index: 20;
        }

        /* --- ã‚°ãƒ©ãƒ•å…±é€š --- */
        .chart-container {
            width: 100%;
            height: 100%;
            min-height: 300px;
        }
        
        /* ã‚°ãƒ©ãƒ•ç”¨ã®SVG */
        #chart-svg-A, #chart-svg-B, #chart-svg-C {
            width: 100%;
            height: 100%;
            min-height: 300px;
        }

        /* ã‚°ãƒ©ãƒ•ã®æ˜Ÿ */
        .star {
            stroke-width: 1;
            stroke: #D69E2E; /* æ˜Ÿã®ç¸ã®è‰² (é»„åœŸè‰²) */
            transition: transform 0.3s ease-in-out;
        } /* <-- ã“ã“ã«é–‰ã˜æ‹¬å¼§ã‚’è¿½åŠ ã—ã¾ã—ãŸ */
        .star-solid-apple { fill: #E53E3E; } /* èµ¤ */
        .star-solid-grape { fill: #805AD5; } /* ç´« */
        .star-solid-kiwi { fill: #10B981; } /* æ–°è¦: ã‚­ã‚¦ã‚¤ (ç·‘) */
        
        .star-dashed {
            fill: none;
            stroke-width: 2;
            stroke-dasharray: 4 4;
            transition: transform 0.3s ease-in-out;
        }
        .star-dashed-apple { stroke: #E53E3E; } /* èµ¤ */
        .star-dashed-grape { stroke: #805AD5; } /* ç´« */
        .star-dashed-kiwi { stroke: #10B981; } /* æ–°è¦: ã‚­ã‚¦ã‚¤ (ç·‘) */
        
        /* ã‚°ãƒ©ãƒ•ã®æœç‰©ã‚¢ã‚¤ã‚³ãƒ³ */
        .chart-icon {
            font-size: 1.5rem; /* å°‘ã—å°ã•ãèª¿æ•´ */
        }
        
        /* --- ã‚°ãƒ©ãƒ•A (æ£’ã‚°ãƒ©ãƒ•) --- */
        /* .bar ã‚’ .bar-apple ã¨ .bar-grape ã«åˆ†å‰² */
        .bar-apple {
            fill: #FEE2E2; /* ã‚ªãƒ¬ãƒ³ã‚¸ -> è–„ã„èµ¤ */
            transition: height 0.3s ease-in-out, y 0.3s ease-in-out;
        }
        .bar-grape {
            fill: #E9D8FD; /* æ–°è¦ (è–„ã„ç´«) */
            transition: height 0.3s ease-in-out, y 0.3s ease-in-out;
        }

        /* --- ã‚°ãƒ©ãƒ•B (æ•£å¸ƒå›³) --- */
        .axis {
            stroke: #333;
            stroke-width: 2;
        }
        .guide-line {
            stroke: #aaa;
            stroke-width: 1;
            stroke-dasharray: 2 2;
        }

        /* --- ã‚°ãƒ©ãƒ•C (å††ã‚°ãƒ©ãƒ•) --- */
        .pie-slice-apple {
            fill: #FEE2E2; /* è–„ã„ã‚ªãƒ¬ãƒ³ã‚¸ -> è–„ã„èµ¤ */
            stroke: #E53E3E; /* stroke ã‚’æ¿ƒã„èµ¤ã«å¤‰æ›´ */
            stroke-width: 1;
            /* transition: d 0.3s ease-in-out; <-- æ­ªã¿ã®åŸå› ã®ãŸã‚å‰Šé™¤ */
        }
        .pie-slice-grape {
            fill: #E9D8FD; /* è–„ã„é’ -> è–„ã„ç´« */
            stroke: #805AD5; /* stroke ã‚’æ¿ƒã„ç´«ã«å¤‰æ›´ */
            stroke-width: 1;
            /* transition: d 0.3s ease-in-out; <-- æ­ªã¿ã®åŸå› ã®ãŸã‚å‰Šé™¤ */
        }
        .pie-slice-kiwi {
            fill: #D1FAE5; /* æ–°è¦: ã‚­ã‚¦ã‚¤ (è–„ã„ç·‘) */
            stroke: #10B981;
            stroke-width: 1;
        }

        /* --- ã‚°ãƒ©ãƒ•D (å¸¯ã‚°ãƒ©ãƒ•) --- */
        #chart-D {
            position: relative;
            padding: 20px;
            box-sizing: border-box;
        }
        .bar-D-container {
            width: 100%;
            height: 40px;
            border: 2px solid #333;
            border-radius: 8px;
            display: flex;
            overflow: hidden; /* è§’ä¸¸ã®ãŸã‚ */
        }
        .bar-D-slice {
            height: 100%;
            transition: width 0.3s ease-in-out;
        }
        .bar-D-slice-apple { background-color: #FEE2E2; } /* è–„ã„ã‚ªãƒ¬ãƒ³ã‚¸ -> è–„ã„èµ¤ */
        .bar-D-slice-grape { background-color: #E9D8FD; } /* è–„ã„é’ -> è–„ã„ç´« */
        .bar-D-slice-kiwi { background-color: #D1FAE5; } /* æ–°è¦: ã‚­ã‚¦ã‚¤ (è–„ã„ç·‘) */
        
        .bar-D-icons {
            display: flex;
            justify-content: space-between;
            padding: 0 5px;
            margin-top: 4px;
        }
        /* 3ç¨®é¡ç”¨ã«ä¸­å¤®æƒãˆ */
        .bar-D-icons.three-fruits {
            justify-content: space-around;
        }

        .bar-D-star-container {
            position: absolute;
            top: 60px; /* å¸¯ã‚°ãƒ©ãƒ•ã®ä¸Šéƒ¨ */
            left: 20px; /* paddingã¨åˆã‚ã›ã‚‹ */
            right: 20px; /* paddingã¨åˆã‚ã›ã‚‹ */
            height: 24px;
        }
        .bar-D-star {
            position: absolute;
            top: 0;
            /* left ã¯JSã§è¨­å®š */
            transform: translateX(-50%); /* ä¸­å¤®æƒãˆ */
            transition: left 0.3s ease-in-out;
            z-index: 10; /* ç¢ºå®Ÿã«æ‰‹å‰ã«è¡¨ç¤º */
        }

        /* ã‚¯ãƒªã‚¢ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        #win-message {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 lg:p-8">

    <div class="container mx-auto max-w-7xl">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-4">æœç‰©ã‚ã¤ã‚ã‚²ãƒ¼ãƒ </h1>
        
        <!-- å•é¡Œé¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ -->
        <div class="mb-6 text-center">
            <label for="stage-select" class="mr-2 text-lg font-medium text-gray-700">å•é¡Œã‚’é¸æŠ:</label>
            <select id="stage-select" class="p-2 border rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                <!-- JSã§ã“ã“ã«<option>ãŒè¿½åŠ ã•ã‚Œã¾ã™ -->
            </select>
        </div>
        
        <!-- ãƒ¡ã‚¤ãƒ³ã®ã‚²ãƒ¼ãƒ ã‚³ãƒ³ãƒ†ãƒŠ (flex) -->
        <div class="flex flex-col lg:flex-row gap-8">

            <!-- å·¦å´: ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ -->
            <div id="chart-area" class="w-full lg:w-1/3 bg-white p-6 rounded-lg shadow-lg relative">
                <h2 class="text-xl font-semibold text-center mb-4">ã‚¹ã‚³ã‚¢</h2>
                
                <!-- ã‚°ãƒ©ãƒ•ã‚³ãƒ³ãƒ†ãƒŠ (JSã§è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹) -->
                
                <!-- ã‚°ãƒ©ãƒ•A (æ£’ã‚°ãƒ©ãƒ•) -->
                <div id="chart-A" class="chart-container" style="display: none;">
                    <svg id="chart-svg-A" viewBox="0 0 200 300" preserveAspectRatio="xMidYMid meet"></svg>
                </div>

                <!-- ã‚°ãƒ©ãƒ•B (æ•£å¸ƒå›³) -->
                <div id="chart-B" class="chart-container" style="display: none;">
                    <svg id="chart-svg-B" viewBox="0 0 200 300" preserveAspectRatio="xMidYMid meet"></svg>
                </div>
                
                <!-- ã‚°ãƒ©ãƒ•C (å††ã‚°ãƒ©ãƒ•) -->
                <div id="chart-C" class="chart-container" style="display: none;">
                    <svg id="chart-svg-C" viewBox="0 0 200 300" preserveAspectRatio="xMidYMid meet"></svg>
                </div>

                <!-- ã‚°ãƒ©ãƒ•D (å¸¯ã‚°ãƒ©ãƒ•) -->
                <div id="chart-D" class="chart-container" style="display: none;">
                    <!-- å¸¯ã‚°ãƒ©ãƒ•æœ¬ä½“ -->
                    <div class="bar-D-container">
                        <div id="bar-D-apple" class="bar-D-slice bar-D-slice-apple" style="width: 33.3%;"></div>
                        <div id="bar-D-grape" class="bar-D-slice bar-D-slice-grape" style="width: 33.3%;"></div>
                        <div id="bar-D-kiwi" class="bar-D-slice bar-D-slice-kiwi" style="width: 33.3%;"></div> <!-- ã‚­ã‚¦ã‚¤è¿½åŠ  -->
                    </div>
                    <!-- ã‚¢ã‚¤ã‚³ãƒ³ (JSã§åˆ‡ã‚Šæ›¿ãˆ) -->
                    <div id="bar-D-icons" class="bar-D-icons">
                        <span class="chart-icon icon-apple">ğŸ</span>
                        <span class="chart-icon icon-kiwi" style="display: none;">ğŸ¥</span> <!-- ã‚­ã‚¦ã‚¤è¿½åŠ  -->
                        <span class="chart-icon icon-grape">ğŸ‡</span>
                    </div>
                    <!-- æ˜Ÿã®ã‚³ãƒ³ãƒ†ãƒŠ -->
                    <div class="bar-D-star-container">
                        <!-- å¢ƒç•Œ1 (Apple/Grape) -->
                        <svg id="star-D-target-apple" class="bar-D-star star-dashed star-dashed-apple" viewBox="0 0 24 24" width="24" height="24" style="left: 50%;">
                            <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"></path>
                        </svg>
                        <svg id="star-D-current-apple" class="bar-D-star star star-solid-apple" viewBox="0 0 24 24" width="24" height="24" style="left: 50%;">
                            <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"></path>
                        </svg>
                        <!-- å¢ƒç•Œ2 (Grape/Kiwi) - 3ç¨®é¡ã®å ´åˆã®ã¿è¡¨ç¤º -->
                        <svg id="star-D-target-grape" class="bar-D-star star-dashed star-dashed-grape" viewBox="0 0 24 24" width="24" height="24" style="left: 50%; display: none;">
                            <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"></path>
                        </svg>
                        <svg id="star-D-current-grape" class="bar-D-star star star-solid-grape" viewBox="0 0 24 24" width="24" height="24" style="left: 50%; display: none;">
                            <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"></path>
                        </svg>
                    </div>
                </div>

                <!-- ã‚¯ãƒªã‚¢ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ (æœ€åˆã¯éè¡¨ç¤º) -->
                <div id="win-message" class="absolute inset-0 bg-white bg-opacity-90 flex flex-col justify-center items-center opacity-0 transform scale-95 pointer-events-none rounded-lg">
                    <span class="text-6xl mb-4">ğŸ‰</span>
                    <h3 class="text-3xl font-bold text-green-600">ã‚¯ãƒªã‚¢ï¼</h3>
                </div>
            </div>

            <!-- å³å´: ç›¤é¢ã‚¨ãƒªã‚¢ -->
            <div class="w-full lg:w-2/3 flex justify-center items-start">
                <div id="board-area">
                    <!-- JSã§ãƒã‚¹ã¨æ ãŒã“ã“ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
                </div>
            </div>
            
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- 1. å®šæ•°ã¨çŠ¶æ…‹ ---

            const BOARD_ROWS = 4;
            const BOARD_COLS = 6;

            // --- ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿ ---
            const STAGES = [
                {
                    id: 'stage1',
                    name: 'å•é¡Œ 1 (æ£’ã‚°ãƒ©ãƒ•)',
                    graphType: 'A', // A: æ£’ã‚°ãƒ©ãƒ•
                    fruits: [
                        ['a', 0, 0, 'g', 0, 0],
                        [0, 'g', 'a', 0, 'a', 'g'],
                        ['g', 0, 0, 'g', 'a', 0],
                        ['a', 'g', 'a', 'g', 0, 'g']
                    ],
                    frames: [
                        [0, 1, 1, 0, 0, 0],
                        [1, 1, 0, 0, 0, 0],
                        [0, 0, 0, 0, 2, 2],
                        [0, 0, 0, 0, 2, 2]
                    ],
                    targets: { apple: 3}
                },
                {
                    id: 'stage2',
                    name: 'å•é¡Œ 2 (æ£’ã‚°ãƒ©ãƒ•)',
                    graphType: 'A',
                    fruits: [
                        ['a', 'g', 'a', 'g', 'a', 'g'],
                        ['g', 'a', 'g', 'a', 'g', 'a'],
                        ['a', 'g', 'a', 'g', 'a', 'g'],
                        ['g', 'a', 'g', 'a', 'g', 'a']
                    ],
                    frames: [
                        [1, 0, 0, 0, 0, 2],
                        [1, 0, 0, 0, 0, 2],
                        [1, 1, 0, 0, 0, 2],
                        [0, 0, 0, 0, 0, 2]
                    ],
                    targets: { apple: 4, grape: 3 }
                },
                {
                    id: 'stage3',
                    name: 'å•é¡Œ 3 (æ•£å¸ƒå›³)',
                    graphType: 'B', // B: æ•£å¸ƒå›³
                    fruits: [
                        ['g', 'g', 'a', 'a', 'g', 'g'],
                        ['a', 'a', 0, 0, 'a', 'a'],
                        ['g', 0, 'g', 'g', 0, 'g'],
                        ['a', 'a', 'a', 'a', 'a', 'a']
                    ],
                    frames: [
                        [0, 0, 0, 0, 0, 0],
                        [0, 1, 1, 1, 0, 0],
                        [0, 1, 1, 1, 0, 0],
                        [0, 0, 0, 0, 0, 0]
                    ],
                    targets: { apple: 2, grape: 4 }
                },
                {
                    id: 'stage4',
                    name: 'å•é¡Œ 4 (å††ã‚°ãƒ©ãƒ•)',
                    graphType: 'C', // C: å††ã‚°ãƒ©ãƒ•
                    fruits: [
                        ['a', 'g', 'a', 'g', 0, 0],
                        ['g', 'a', 'g', 0, 'a', 0],
                        ['a', 'g', 0, 0, 'g', 'a'],
                        ['g', 0, 'g', 'a', 'g', 'g']
                    ],
                    frames: [
                        [1, 1, 0, 0, 0, 0],
                        [1, 1, 0, 0, 0, 0],
                        [0, 0, 0, 2, 2, 0],
                        [0, 0, 0, 2, 2, 0]
                    ],
                    targets: { apple: 1, grape: 3 } // ã‚Šã‚“ã” 1/4 (25%)
                },
                {
                    id: 'stage5',
                    name: 'å•é¡Œ 5 (å¸¯ã‚°ãƒ©ãƒ•)',
                    graphType: 'D', // D: å¸¯ã‚°ãƒ©ãƒ•
                    fruits: [
                        ['g', 'g', 'g', 'g', 'g', 'g'],
                        ['a', 0, 'a', 0, 'a', 'a'],
                        ['g', 'g', 0, 'g', 'g', 'g'],
                        ['a', 'a', 'a', 'a', 'a', 'a']
                    ],
                    frames: [
                        [0, 0, 0, 0, 0, 0],
                        [0, 1, 1, 1, 1, 0],
                        [0, 1, 1, 1, 1, 0],
                        [0, 0, 0, 0, 0, 0]
                    ],
                    targets: { apple: 2, grape: 2 } // ã‚Šã‚“ã” 2/4 (50%)
                },
                {
                    id: 'stage6',
                    name: 'å•é¡Œ 6 (å††ã‚°ãƒ©ãƒ• 3ç¨®)',
                    graphType: 'C', // C: å††ã‚°ãƒ©ãƒ• (3ç¨®é¡)
                    fruits: [
                        ['a', 'g', 'k', 'a', 'g', 'k'],
                        ['k', 'a', 'g', 'k', 'a', 'g'],
                        ['g', 'k', 'a', 'g', 'k', 'a'],
                        ['a', 'g', 'k', 'a', 'g', 'k']
                    ],
                    frames: [
                        [1, 1, 0, 0, 0, 0],
                        [1, 1, 0, 0, 0, 0],
                        [0, 0, 0, 2, 2, 0],
                        [0, 0, 0, 2, 2, 0]
                    ],
                    // total 8. a:2, g:2, k:4
                    targets: { apple: 2, grape: 2, kiwi: 4 } // a: 25%, g: 25%
                },
                {
                    id: 'stage7',
                    name: 'å•é¡Œ 7 (å¸¯ã‚°ãƒ©ãƒ• 3ç¨®)',
                    graphType: 'D', // D: å¸¯ã‚°ãƒ©ãƒ• (3ç¨®é¡)
                    fruits: [
                        ['a', 'a', 'a', 'a', 'a', 'a'],
                        ['g', 'g', 'g', 'g', 'g', 'g'],
                        ['k', 'k', 'k', 'k', 'k', 'k'],
                        ['a', 'g', 'k', 'a', 'g', 'k']
                    ],
                    frames: [
                        [0, 1, 1, 0, 0, 0],
                        [0, 1, 1, 0, 0, 0],
                        [0, 1, 1, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0]
                    ],
                    // total 6. a:2, g:2, k:2
                    targets: { apple: 2, grape: 2, kiwi: 2 } // a: 33.3%, g: 33.3%
                }
            ];

            // ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹
            let currentStage = null; // ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿
            let frames = []; // æ ã®ãƒ‡ãƒ¼ã‚¿ (id, anchor, pieces)
            let currentCounts = { apple: 0, grape: 0, kiwi: 0 }; // ã‚­ã‚¦ã‚¤è¿½åŠ 
            
            // DOMè¦ç´ 
            let boardElement = document.getElementById('board-area');
            let chartAreaElement = document.getElementById('chart-area');
            let chartContainers = {
                A: document.getElementById('chart-A'),
                B: document.getElementById('chart-B'),
                C: document.getElementById('chart-C'),
                D: document.getElementById('chart-D')
            };
            let winMessageElement = document.getElementById('win-message');
            let stageSelectElement = document.getElementById('stage-select');
            
            // ãƒ‰ãƒ©ãƒƒã‚°ã®çŠ¶æ…‹
            let isDragging = false;
            let activeFrame = null;
            let dragStartPos = { x: 0, y: 0 };
            let dragStartGrid = { r: 0, c: 0 };
            let lastDragGrid = { r: 0, c: 0 };

            // æ˜Ÿã®SVGãƒ‘ã‚¹
            const STAR_PATH_D = "M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z";

            // --- 2. åˆæœŸåŒ– ---

            function initApp() {
                // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’åˆæœŸåŒ–
                STAGES.forEach(stage => {
                    const option = document.createElement('option');
                    option.value = stage.id;
                    option.textContent = stage.name;
                    stageSelectElement.appendChild(option);
                });
                
                // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³å¤‰æ›´æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                stageSelectElement.addEventListener('change', (e) => {
                    const selectedStageId = e.target.value;
                    const stageData = STAGES.find(s => s.id === selectedStageId);
                    if (stageData) {
                        loadStage(stageData);
                    }
                });
                
                // å…¨ã‚°ãƒ©ãƒ•ã®é™çš„è¦ç´ ã‚’åˆæœŸåŒ–
                initAllCharts();

                // æœ€åˆã®ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã‚€
                loadStage(STAGES[0]);
            }
            
            // ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã‚€ (åˆæœŸåŒ–å‡¦ç†)
            function loadStage(stageData) {
                currentStage = stageData;
                
                // è¡¨ç¤ºã™ã‚‹ã‚°ãƒ©ãƒ•ã‚³ãƒ³ãƒ†ãƒŠã‚’åˆ‡ã‚Šæ›¿ãˆ
                for (const type in chartContainers) {
                    chartContainers[type].style.display = (type === currentStage.graphType) ? 'block' : 'none';
                }

                initBoard(currentStage.fruits);
                initFrames(currentStage.frames);
                // ã‚°ãƒ©ãƒ•ã®ã€Œç›®æ¨™ã€ã‚’æ›´æ–°
                updateChartTargets(currentStage.graphType, currentStage.targets);
                
                // ã‚¯ãƒªã‚¢ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éš ã™
                winMessageElement.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
                winMessageElement.classList.remove('opacity-100', 'scale-100');

                updateGame(false); // åˆå›æ›´æ–° (ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãªã—)
            }

            // ç›¤é¢(ãƒã‚¹ã¨æœç‰©)ã®DOMã‚’ç”Ÿæˆ
            function initBoard(fruitsLayout) {
                boardElement.innerHTML = ''; // æ—¢å­˜ã®è¦ç´ ã‚’ã‚¯ãƒªã‚¢
                let cells = []; // DOMè¦ç´ ã‚’ä¸€æ™‚çš„ã«ä¿æŒ
                
                for (let r = 0; r < BOARD_ROWS; r++) {
                    for (let c = 0; c < BOARD_COLS; c++) {
                        // ãƒã‚¹
                        const cell = document.createElement('div');
                        cell.classList.add('cell');
                        cell.style.gridRow = r + 1;
                        cell.style.gridColumn = c + 1;
                        
                        // æœç‰©
                        const fruit = fruitsLayout[r][c]; // å¼•æ•°ã‚’ä½¿ç”¨
                        if (fruit === 'a') {
                            cell.textContent = 'ğŸ';
                        } else if (fruit === 'g') {
                            cell.textContent = 'ğŸ‡';
                        } else if (fruit === 'k') { // ã‚­ã‚¦ã‚¤è¿½åŠ 
                            cell.textContent = 'ğŸ¥';
                        }
                        cells.push(cell);
                    }
                }
                // ãƒã‚¹ã‚’ä¸€æ‹¬ã§è¿½åŠ 
                boardElement.append(...cells);
            }

            // æ ã®å†…éƒ¨ãƒ‡ãƒ¼ã‚¿ã¨DOMã‚’ç”Ÿæˆ
            function initFrames(framesLayout) {
                frames = []; // å†…éƒ¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
                const framePiecesDOM = []; // DOMè¦ç´ ã‚’ä¸€æ™‚çš„ã«ä¿æŒ
                
                // 1. ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‹ã‚‰ãƒ•ãƒ¬ãƒ¼ãƒ IDã”ã¨ã«ãƒ”ãƒ¼ã‚¹ã®ä½ç½®ã‚’åé›†
                const tempFrames = new Map(); // frameId -> { pieces: [], minR, minC }
                
                for (let r = 0; r < BOARD_ROWS; r++) {
                    for (let c = 0; c < BOARD_COLS; c++) {
                        const frameId = framesLayout[r][c]; // å¼•æ•°ã‚’ä½¿ç”¨
                        if (frameId > 0) {
                            if (!tempFrames.has(frameId)) {
                                tempFrames.set(frameId, { pieces: [], minR: r, minC: c });
                            }
                            const data = tempFrames.get(frameId);
                            data.pieces.push({ r, c });
                            // ã‚¢ãƒ³ã‚«ãƒ¼(å·¦ä¸Šã®ãƒ”ãƒ¼ã‚¹)ã‚’æ›´æ–°
                            data.minR = Math.min(data.minR, r);
                            data.minC = Math.min(data.minC, c);
                        }
                    }
                }
                
                // éš£æ¥æ¤œç´¢ç”¨ã«ã€å„ãƒ•ãƒ¬ãƒ¼ãƒ ã®ãƒ”ãƒ¼ã‚¹ä½ç½®ã‚’Setã¨ã—ã¦è¿½åŠ 
                tempFrames.forEach(data => {
                    data.pieceSet = new Set(data.pieces.map(p => `${p.r},${p.c}`));
                });
                
                // 2. å†…éƒ¨ãƒ‡ãƒ¼ã‚¿ (frames) ã¨ DOM (framePiecesDOM) ã‚’æ§‹ç¯‰
                tempFrames.forEach((data, id) => {
                    const anchor = { r: data.minR, c: data.minC };
                    const frame = {
                        id: id,
                        anchor: anchor, // ç¾åœ¨ã®ã‚¢ãƒ³ã‚«ãƒ¼ä½ç½® (r, c)
                        pieces: [], // ã‚¢ãƒ³ã‚«ãƒ¼ã‹ã‚‰ã®ç›¸å¯¾ã‚ªãƒ•ã‚»ãƒƒãƒˆ
                        domElements: [] // ã“ã®æ ã‚’æ§‹æˆã™ã‚‹DOMãƒ”ãƒ¼ã‚¹
                    };
                    
                    const pieceSet = data.pieceSet; // é«˜é€Ÿæ¤œç´¢ç”¨Set

                    data.pieces.forEach(pos => {
                        const offset = { r: pos.r - anchor.r, c: pos.c - anchor.c };
                        frame.pieces.push(offset);
                        
                        const pieceElement = document.createElement('div');
                        pieceElement.classList.add('frame-piece');
                        pieceElement.dataset.frameId = id;
                        // ã‚°ãƒªãƒƒãƒ‰ä½ç½® (CSSã¯ 1-indexed)
                        pieceElement.style.gridRow = pos.r + 1;
                        pieceElement.style.gridColumn = pos.c + 1;
                        
                        // --- ã“ã“ã‹ã‚‰å¤–éƒ­æç”»ãƒ­ã‚¸ãƒƒã‚¯ ---
                        const r = pos.r;
                        const c = pos.c;

                        // åŒã˜ãƒ•ãƒ¬ãƒ¼ãƒ å†…ã®éš£æ¥ãƒ”ãƒ¼ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯
                        const hasTop = pieceSet.has(`${r - 1},${c}`);
                        const hasBottom = pieceSet.has(`${r + 1},${c}`);
                        const hasLeft = pieceSet.has(`${r},${c - 1}`);
                        const hasRight = pieceSet.has(`${r},${c + 1}`);

                        // inset box-shadow ã§å¤–éƒ­ç·šã‚’æç”»
                        const shadows = [];
                        const radius = '8px'; // è§’ä¸¸ã®åŠå¾„

                        if (!hasTop) shadows.push("inset 0 4px 0 0 #E53E3E");
                        if (!hasBottom) shadows.push("inset 0 -4px 0 0 #E53E3E");
                        if (!hasLeft) shadows.push("inset 4px 0 0 0 #E53E3E");
                        if (!hasRight) shadows.push("inset -4px 0 0 0 #E53E3E");
                        
                        pieceElement.style.boxShadow = shadows.join(', ');

                        // å¤–å´ã®è§’ã ã‘ä¸¸ã‚ã‚‹
                        pieceElement.style.borderRadius = '0';
                        if (!hasTop && !hasLeft) pieceElement.style.borderTopLeftRadius = radius;
                        if (!hasTop && !hasRight) pieceElement.style.borderTopRightRadius = radius;
                        if (!hasBottom && !hasLeft) pieceElement.style.borderBottomLeftRadius = radius;
                        if (!hasBottom && !hasRight) pieceElement.style.borderBottomRightRadius = radius;
                        // --- å¤–éƒ­æç”»ãƒ­ã‚¸ãƒƒã‚¯ã“ã“ã¾ã§ ---

                        // ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
                        pieceElement.addEventListener('mousedown', handleDragStart);
                        pieceElement.addEventListener('touchstart', handleDragStart, { passive: false });
                        
                        frame.domElements.push(pieceElement);
                        framePiecesDOM.push(pieceElement);
                    });
                    
                    frames.push(frame);
                });

                // æ ãƒ”ãƒ¼ã‚¹ã‚’ä¸€æ‹¬ã§è¿½åŠ  (ãƒã‚¹ã‚ˆã‚Šå¾Œã«è¿½åŠ ã™ã‚‹ã“ã¨ã§å‰é¢ã«è¡¨ç¤º)
                boardElement.append(...framePiecesDOM);
            }

            // --- ã‚°ãƒ©ãƒ•åˆæœŸåŒ– (åˆå›1å›ã®ã¿) ---
            function initAllCharts() {
                initChartA();
                initChartB();
                initChartC();
                initChartD();
            }

            // ã‚°ãƒ©ãƒ•A (æ£’ã‚°ãƒ©ãƒ•) ã®é™çš„è¦ç´ ã‚’åˆæœŸåŒ–
            function initChartA() {
                const svg = document.getElementById('chart-svg-A');
                const svgNS = "http://www.w3.org/2000/svg";
                const chartBottomY = 280;
                const barWidth = 40;
                
                // è»¸
                const axis = document.createElementNS(svgNS, 'line');
                axis.setAttribute('x1', '20');
                axis.setAttribute('y1', chartBottomY - 20);
                axis.setAttribute('x2', '180');
                axis.setAttribute('y2', chartBottomY - 20);
                axis.setAttribute('stroke', '#333');
                axis.setAttribute('stroke-width', '2');
                svg.appendChild(axis);

                // --- é …ç›®1: ã‚Šã‚“ã” ---
                const xApple = 60;
                // ç›®æ¨™ã®æ˜Ÿ (ç‚¹ç·š) - loadStageã§ä½ç½®æ›´æ–°
                const targetStarApple = createStar(
                    'star-dashed star-dashed-apple',
                    xApple,
                    chartBottomY - 20 // åˆæœŸY
                );
                targetStarApple.id = 'target-star-A-apple';
                // svg.appendChild(targetStarApple); <-- æç”»é †åºåˆ¶å¾¡ã®ãŸã‚å¾Œã§è¿½åŠ 

                // æ£’
                const barApple = document.createElementNS(svgNS, 'rect');
                barApple.setAttribute('id', 'bar-apple');
                barApple.setAttribute('class', 'bar-apple'); /* bar -> bar-apple */
                barApple.setAttribute('x', xApple - barWidth / 2);
                barApple.setAttribute('width', barWidth);
                barApple.setAttribute('rx', '4');
                // svg.appendChild(barApple); // y, heightã¯updateChartã§è¨­å®š <-- å…ˆã«è¿½åŠ ã—ãªã„
                
                // ç¾åœ¨ã®æ˜Ÿ (å®Ÿç·š)
                const currentStarApple = createStar(
                    'star star-solid-apple',
                    xApple,
                    chartBottomY - 20 // åˆæœŸY
                );
                currentStarApple.setAttribute('id', 'star-apple');
                // svg.appendChild(currentStarApple); <-- æç”»é †åºåˆ¶å¾¡ã®ãŸã‚å¾Œã§è¿½åŠ 
                
                // ã‚¢ã‚¤ã‚³ãƒ³
                const iconApple = document.createElementNS(svgNS, 'text');
                iconApple.setAttribute('class', 'chart-icon');
                iconApple.setAttribute('x', xApple);
                iconApple.setAttribute('y', chartBottomY + 5);
                iconApple.setAttribute('text-anchor', 'middle');
                iconApple.textContent = 'ğŸ';
                // svg.appendChild(iconApple); <-- å…ˆã«è¿½åŠ ã—ãªã„

                // --- é …ç›®2: ã¶ã©ã† ---
                const xGrape = 140;
                // ç›®æ¨™ã®æ˜Ÿ (ç‚¹ç·š) - loadStageã§ä½ç½®æ›´æ–°
                const targetStarGrape = createStar(
                    'star-dashed star-dashed-grape',
                    xGrape,
                    chartBottomY - 20 // åˆæœŸY
                );
                targetStarGrape.id = 'target-star-A-grape';
                // svg.appendChild(targetStarGrape); <-- æç”»é †åºåˆ¶å¾¡ã®ãŸã‚å¾Œã§è¿½åŠ 
                
                // æ£’
                const barGrape = document.createElementNS(svgNS, 'rect');
                barGrape.setAttribute('id', 'bar-grape');
                barGrape.setAttribute('class', 'bar-grape'); /* bar -> bar-grape */
                barGrape.setAttribute('x', xGrape - barWidth / 2);
                barGrape.setAttribute('width', barWidth);
                barGrape.setAttribute('rx', '4');
                // svg.appendChild(barGrape); // y, heightã¯updateChartã§è¨­å®š <-- å…ˆã«è¿½åŠ ã—ãªã„

                // ç¾åœ¨ã®æ˜Ÿ (å®Ÿç·š)
                const currentStarGrape = createStar(
                    'star star-solid-grape',
                    xGrape,
                    chartBottomY - 20 // åˆæœŸY
                );
                currentStarGrape.setAttribute('id', 'star-grape');
                // svg.appendChild(currentStarGrape); <-- æç”»é †åºåˆ¶å¾¡ã®ãŸã‚å¾Œã§è¿½åŠ 

                // ã‚¢ã‚¤ã‚³ãƒ³
                const iconGrape = document.createElementNS(svgNS, 'text');
                iconGrape.setAttribute('class', 'chart-icon');
                iconGrape.setAttribute('x', xGrape);
                iconGrape.setAttribute('y', chartBottomY + 5);
                iconGrape.setAttribute('text-anchor', 'middle');
                iconGrape.textContent = 'ğŸ‡';
                // svg.appendChild(iconGrape); <-- å…ˆã«è¿½åŠ ã—ãªã„

                // --- æç”»é †åºåˆ¶å¾¡ ---
                // æ£’ã‚’å…ˆã«è¿½åŠ 
                svg.appendChild(barApple);
                svg.appendChild(barGrape);
                // æ˜Ÿ (ç›®æ¨™ãƒ»ç¾åœ¨) ã‚’è¿½åŠ 
                svg.appendChild(targetStarApple);
                svg.appendChild(currentStarApple);
                svg.appendChild(targetStarGrape);
                svg.appendChild(currentStarGrape);
                // ã‚¢ã‚¤ã‚³ãƒ³ã‚’æœ€å¾Œã«è¿½åŠ 
                svg.appendChild(iconApple);
                svg.appendChild(iconGrape);
            }

            // ã‚°ãƒ©ãƒ•B (æ•£å¸ƒå›³) ã®é™çš„è¦ç´ ã‚’åˆæœŸåŒ–
            function initChartB() {
                const svg = document.getElementById('chart-svg-B');
                const svgNS = "http://www.w3.org/2000/svg";
                const maxCount = 7; // è»¸ã®æœ€å¤§å€¤ (å›ºå®š)
                const origin = { x: 40, y: 260 };
                const chartWidth = 150;
                const chartHeight = 220;

                // X/Yã‚¹ã‚±ãƒ¼ãƒ«é–¢æ•°
                const getX = (count) => origin.x + (count * (chartWidth / maxCount));
                const getY = (count) => origin.y - (count * (chartHeight / maxCount));

                // Yè»¸ (ã‚Šã‚“ã”)
                const yAxis = document.createElementNS(svgNS, 'line');
                yAxis.setAttribute('class', 'axis');
                yAxis.setAttribute('x1', origin.x);
                yAxis.setAttribute('y1', origin.y);
                yAxis.setAttribute('x2', origin.x);
                yAxis.setAttribute('y2', origin.y - chartHeight - 10);
                svg.appendChild(yAxis);
                
                const yIcon = document.createElementNS(svgNS, 'text');
                yIcon.setAttribute('class', 'chart-icon');
                yIcon.setAttribute('x', origin.x - 20);
                yIcon.setAttribute('y', origin.y - chartHeight);
                yIcon.setAttribute('text-anchor', 'middle');
                yIcon.textContent = 'ğŸ';
                svg.appendChild(yIcon);

                // Xè»¸ (ã¶ã©ã†)
                const xAxis = document.createElementNS(svgNS, 'line');
                xAxis.setAttribute('class', 'axis');
                xAxis.setAttribute('x1', origin.x);
                xAxis.setAttribute('y1', origin.y);
                xAxis.setAttribute('x2', origin.x + chartWidth + 10);
                xAxis.setAttribute('y2', origin.y);
                svg.appendChild(xAxis);
                
                const xIcon = document.createElementNS(svgNS, 'text');
                xIcon.setAttribute('class', 'chart-icon');
                xIcon.setAttribute('x', origin.x + chartWidth);
                xIcon.setAttribute('y', origin.y + 25);
                xIcon.setAttribute('text-anchor', 'middle');
                xIcon.textContent = 'ğŸ‡';
                svg.appendChild(xIcon);

                // ç›®æ¨™ã®æ˜Ÿ (ç‚¹ç·š) - loadStageã§ä½ç½®æ›´æ–°
                const targetStar = createStar(
                    'star-dashed star-dashed-apple', // æš«å®šã§ã‚Šã‚“ã”ã®è‰²
                    getX(0),
                    getY(0)
                );
                targetStar.id = 'target-star-B';
                // svg.appendChild(targetStar); <-- æç”»é †åºåˆ¶å¾¡ã®ãŸã‚å¾Œã§è¿½åŠ 
                
                // ã‚¬ã‚¤ãƒ‰ç·š (ç‚¹ç·š) - updateChartã§æ›´æ–°
                const lineX = document.createElementNS(svgNS, 'line');
                lineX.setAttribute('id', 'guide-line-B-x');
                lineX.setAttribute('class', 'guide-line');
                svg.appendChild(lineX);
                const lineY = document.createElementNS(svgNS, 'line');
                lineY.setAttribute('id', 'guide-line-B-y');
                lineY.setAttribute('class', 'guide-line');
                svg.appendChild(lineY);

                // ç¾åœ¨ã®æ˜Ÿ (å®Ÿç·š) - updateChartã§ä½ç½®æ›´æ–°
                const currentStar = createStar(
                    'star star-solid-apple', // æš«å®šã§ã‚Šã‚“ã”ã®è‰²
                    getX(0),
                    getY(0)
                );
                currentStar.id = 'star-B';
                // svg.appendChild(currentStar); <-- æç”»é †åºåˆ¶å¾¡ã®ãŸã‚å¾Œã§è¿½åŠ 
                
                // --- æç”»é †åºåˆ¶å¾¡ ---
                svg.appendChild(targetStar);
                svg.appendChild(currentStar);
            }

            // ã‚°ãƒ©ãƒ•C (å††ã‚°ãƒ©ãƒ•) ã®é™çš„è¦ç´ ã‚’åˆæœŸåŒ–
            function initChartC() {
                const svg = document.getElementById('chart-svg-C');
                const svgNS = "http://www.w3.org/2000/svg";
                const cx = 100; // ä¸­å¿ƒX
                const cy = 150; // ä¸­å¿ƒY
                const r = 80;  // åŠå¾„

                // ç›®æ¨™ã®æ˜Ÿ (ç‚¹ç·š) - loadStageã§ä½ç½®æ›´æ–°
                // 2ç¨®é¡ (apple/grapeå¢ƒç•Œ, grape/kiwiå¢ƒç•Œ) ã«å¤‰æ›´
                const targetStarApple = createStar(
                    'star-dashed star-dashed-apple',
                    cx, cy - r // åˆæœŸä½ç½® (12æ™‚)
                );
                targetStarApple.id = 'target-star-C-apple';
                // svg.appendChild(targetStar); <-- å¾Œã§è¿½åŠ 

                const targetStarGrape = createStar(
                    'star-dashed star-dashed-grape',
                    cx, cy - r // åˆæœŸä½ç½® (12æ™‚)
                );
                targetStarGrape.id = 'target-star-C-grape';
                targetStarGrape.style.display = 'none'; // 2ç¨®é¡ã®å ´åˆã¯éè¡¨ç¤º
                // svg.appendChild(targetStarGrape); <-- å¾Œã§è¿½åŠ 

                // ã‚­ã‚¦ã‚¤ã®ã‚¹ãƒ©ã‚¤ã‚¹ (ä¸€ç•ªå¥¥)
                const sliceKiwi = document.createElementNS(svgNS, 'path');
                sliceKiwi.id = 'pie-kiwi';
                sliceKiwi.setAttribute('class', 'pie-slice-kiwi');
                svg.appendChild(sliceKiwi);

                // ã¶ã©ã†ã®ã‚¹ãƒ©ã‚¤ã‚¹
                const sliceGrape = document.createElementNS(svgNS, 'path');
                sliceGrape.id = 'pie-grape';
                sliceGrape.setAttribute('class', 'pie-slice-grape');
                svg.appendChild(sliceGrape);

                // ã‚Šã‚“ã”ã®ã‚¹ãƒ©ã‚¤ã‚¹ (ä¸€ç•ªæ‰‹å‰)
                const sliceApple = document.createElementNS(svgNS, 'path');
                sliceApple.id = 'pie-apple';
                sliceApple.setAttribute('class', 'pie-slice-apple');
                svg.appendChild(sliceApple);
                
                // ã‚¢ã‚¤ã‚³ãƒ³ (å††ã®å¤–å´ã€ä¸Šæ–¹)
                const iconApple = document.createElementNS(svgNS, 'text');
                iconApple.setAttribute('class', 'chart-icon');
                iconApple.setAttribute('x', cx - r); /* cx - r/2.5 -> cx - r */
                iconApple.setAttribute('y', cy - r - 10); /* cy -> cy - r - 10 */
                iconApple.setAttribute('text-anchor', 'middle');
                iconApple.textContent = 'ğŸ';
                svg.appendChild(iconApple);
                
                const iconGrape = document.createElementNS(svgNS, 'text');
                iconGrape.setAttribute('class', 'chart-icon');
                iconGrape.setAttribute('x', cx + r); /* cx + r/2.5 -> cx + r */
                iconGrape.setAttribute('y', cy - r - 10); /* cy -> cy - r - 10 */
                iconGrape.setAttribute('text-anchor', 'middle');
                iconGrape.textContent = 'ğŸ‡';
                svg.appendChild(iconGrape);

                const iconKiwi = document.createElementNS(svgNS, 'text');
                iconKiwi.id = 'icon-C-kiwi';
                iconKiwi.setAttribute('class', 'chart-icon');
                iconKiwi.setAttribute('x', cx); // ä¸­å¤®ä¸Š
                iconKiwi.setAttribute('y', cy - r - 10);
                iconKiwi.setAttribute('text-anchor', 'middle');
                iconKiwi.textContent = 'ğŸ¥';
                iconKiwi.style.display = 'none'; // 2ç¨®é¡ã®å ´åˆã¯éè¡¨ç¤º
                svg.appendChild(iconKiwi);


                // ç¾åœ¨ã®æ˜Ÿ (å®Ÿç·š) - updateChartã§ä½ç½®æ›´æ–°
                const currentStarApple = createStar(
                    'star star-solid-apple',
                    cx, cy - r // åˆæœŸä½ç½® (12æ™‚)
                );
                currentStarApple.id = 'star-C-apple';
                // svg.appendChild(currentStar); <-- å¾Œã§è¿½åŠ 

                const currentStarGrape = createStar(
                    'star star-solid-grape',
                    cx, cy - r // åˆæœŸä½ç½® (12æ™‚)
                );
                currentStarGrape.id = 'star-C-grape';
                currentStarGrape.style.display = 'none'; // 2ç¨®é¡ã®å ´åˆã¯éè¡¨ç¤º
                // svg.appendChild(currentStarGrape); <-- å¾Œã§è¿½åŠ 
                
                // --- æç”»é †åºåˆ¶å¾¡ ---
                // æ˜Ÿã‚’ã‚¹ãƒ©ã‚¤ã‚¹ã‚ˆã‚Šå¾Œ (æ‰‹å‰) ã«è¿½åŠ 
                svg.appendChild(targetStarApple);
                svg.appendChild(targetStarGrape);
                svg.appendChild(currentStarApple);
                svg.appendChild(currentStarGrape);
            }

            // ã‚°ãƒ©ãƒ•D (å¸¯ã‚°ãƒ©ãƒ•) ã®é™çš„è¦ç´ ã‚’åˆæœŸåŒ– (HTMLå´ã§ã»ã¼å®Œäº†)
            function initChartD() {
                // JSã§åˆæœŸåŒ–ã™ã‚‹é™çš„è¦ç´ ã¯ç‰¹ã«ãªã—
                // ç›®æ¨™ã®æ˜Ÿã¯ loadStage (updateChartTargets) ã§æ›´æ–°
            }
            
            // ã‚°ãƒ©ãƒ•ã®ã€Œç›®æ¨™ã€ã‚’æ›´æ–° (ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«å‘¼ã°ã‚Œã‚‹)
            function updateChartTargets(graphType, targets) {
                const svgNS = "http://www.w3.org/2000/svg";
                
                switch (graphType) {
                    case 'A': {
                        const maxCount = Math.max(5, targets.apple, targets.grape) + 1;
                        const chartHeight = 250;
                        const chartBottomY = 280;
                        const getY = (count) => chartBottomY - 20 - (count * (chartHeight / maxCount));
                        
                        document.getElementById('target-star-A-apple').setAttribute('transform', `translate(48, ${getY(targets.apple) - 12}) scale(1.2)`);
                        document.getElementById('target-star-A-grape').setAttribute('transform', `translate(128, ${getY(targets.grape) - 12}) scale(1.2)`);
                        break;
                    }
                    case 'B': {
                        const maxCount = 7;
                        const origin = { x: 40, y: 260 };
                        const chartWidth = 150;
                        const chartHeight = 220;
                        const getX = (count) => origin.x + (count * (chartWidth / maxCount));
                        const getY = (count) => origin.y - (count * (chartHeight / maxCount));

                        const tx = getX(targets.grape);
                        const ty = getY(targets.apple);
                        
                        document.getElementById('target-star-B').setAttribute('transform', `translate(${tx - 12}, ${ty - 12}) scale(1.2)`);
                        break;
                    }
                    case 'C': {
                        const cx = 100, cy = 150, r = 80;
                        const total = (targets.apple || 0) + (targets.grape || 0) + (targets.kiwi || 0);
                        const hasKiwi = (targets.kiwi || 0) > 0;
                        
                        // 3ç¨®é¡ã‹2ç¨®é¡ã‹ã§ã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
                        // 2ç¨®é¡ã®å ´åˆ: å·¦: ğŸ (x=20), å³: ğŸ‡ (x=180)
                        // 3ç¨®é¡ã®å ´åˆ: å·¦: ğŸ (x=20), ä¸­: ğŸ¥ (x=100), å³: ğŸ‡ (x=180)
                        document.getElementById('icon-C-kiwi').style.display = hasKiwi ? 'block' : 'none'; // ğŸ¥ (ä¸­)
                        document.querySelector('#chart-svg-C .chart-icon[x="20"]').style.display = 'block'; // ğŸ (å·¦)
                        document.querySelector('#chart-svg-C .chart-icon[x="180"]').style.display = 'block'; // ğŸ‡ (å³)


                        // æ˜Ÿ1 (Apple)
                        const ratioApple = (total > 0) ? ((targets.apple || 0) / total) : 0;
                        const angleRadApple = (ratioApple * 2 * Math.PI) - (Math.PI / 2);
                        const txApple = cx + r * Math.cos(angleRadApple);
                        const tyApple = cy + r * Math.sin(angleRadApple);
                        document.getElementById('target-star-C-apple').setAttribute('transform', `translate(${txApple - 12}, ${tyApple - 12}) scale(1.2)`);
                        
                        // æ˜Ÿ2 (Grape) - 3ç¨®é¡ã®å ´åˆã®ã¿
                        const starGrape = document.getElementById('target-star-C-grape');
                        if (hasKiwi) {
                            const ratioGrape = (total > 0) ? (((targets.apple || 0) + (targets.grape || 0)) / total) : 0;
                            const angleRadGrape = (ratioGrape * 2 * Math.PI) - (Math.PI / 2);
                            const txGrape = cx + r * Math.cos(angleRadGrape);
                            const tyGrape = cy + r * Math.sin(angleRadGrape);
                            starGrape.setAttribute('transform', `translate(${txGrape - 12}, ${tyGrape - 12}) scale(1.2)`);
                            starGrape.style.display = 'block';
                        } else {
                            starGrape.style.display = 'none';
                        }
                        
                        break;
                    }
                    case 'D': {
                        const total = (targets.apple || 0) + (targets.grape || 0) + (targets.kiwi || 0);
                        const hasKiwi = (targets.kiwi || 0) > 0;

                        // 3ç¨®é¡ã‹2ç¨®é¡ã‹ã§ã‚¢ã‚¤ã‚³ãƒ³ãƒ»ã‚¹ãƒ©ã‚¤ã‚¹ãƒ»æ˜Ÿã®è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
                        document.getElementById('bar-D-kiwi').style.display = hasKiwi ? 'block' : 'none';
                        document.getElementById('bar-D-icons').classList.toggle('three-fruits', hasKiwi);
                        document.querySelector('#bar-D-icons .icon-kiwi').style.display = hasKiwi ? 'inline' : 'none';
                        
                        // æ˜Ÿ1 (Apple)
                        const ratioApple = (total > 0) ? (((targets.apple || 0) / total) * 100) : 0;
                        document.getElementById('star-D-target-apple').style.left = `${ratioApple}%`;
                        
                        // æ˜Ÿ2 (Grape) - 3ç¨®é¡ã®å ´åˆã®ã¿
                        const starGrapeTarget = document.getElementById('star-D-target-grape');
                        const starGrapeCurrent = document.getElementById('star-D-current-grape');
                        if (hasKiwi) {
                            const ratioGrape = (total > 0) ? ((((targets.apple || 0) + (targets.grape || 0)) / total) * 100) : 0;
                            starGrapeTarget.style.left = `${ratioGrape}%`;
                            starGrapeTarget.style.display = 'block';
                            starGrapeCurrent.style.display = 'block';
                        } else {
                            starGrapeTarget.style.display = 'none';
                            starGrapeCurrent.style.display = 'none';
                        }
                        
                        break;
                    }
                }
            }
            
            // æ˜Ÿã®SVGè¦ç´ ã‚’ä½œæˆã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
            function createStar(className, cx, cy) {
                const svgNS = "http://www.w3.org/2000/svg";
                const g = document.createElementNS(svgNS, 'g');
                g.setAttribute('class', className);
                
                const path = document.createElementNS(svgNS, 'path');
                path.setAttribute('d', STAR_PATH_D);
                
                g.appendChild(path);
                // åˆæœŸä½ç½®ã¨ã‚¹ã‚±ãƒ¼ãƒ«ã‚’è¨­å®š
                g.setAttribute('transform', `translate(${cx - 12}, ${cy - 12}) scale(1.2)`);
                return g;
            }

            // --- 3. ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ ---

            // ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã‚’æ›´æ–° (ã‚«ã‚¦ãƒ³ãƒˆè¨ˆç®— -> ã‚°ãƒ©ãƒ•æ›´æ–° -> å‹åˆ©åˆ¤å®š)
            function updateGame(animate = true) {
                calculateCounts();
                updateChart(animate); // å†…éƒ¨ã§ã‚°ãƒ©ãƒ•ã‚¿ã‚¤ãƒ—ã‚’åˆ‡ã‚Šæ›¿ãˆ
                checkWin();
            }

            // æ å†…ã®æœç‰©ã‚’æ•°ãˆã‚‹
            function calculateCounts() {
                const counts = { apple: 0, grape: 0, kiwi: 0 }; // ã‚­ã‚¦ã‚¤è¿½åŠ 
                const occupiedCells = new Set(); // æ ãŒé‡ãªã£ãŸå ´åˆã«äºŒé‡ã‚«ã‚¦ãƒ³ãƒˆã—ãªã„ã‚ˆã†
                
                frames.forEach(frame => {
                    const anchor = frame.anchor;
                    frame.pieces.forEach(offset => {
                        const r = anchor.r + offset.r;
                        const c = anchor.c + offset.c;
                        
                        // ç›¤é¢å†…ã‹ãƒã‚§ãƒƒã‚¯
                        if (r < 0 || r >= BOARD_ROWS || c < 0 || c >= BOARD_COLS) {
                            return;
                        }

                        const cellKey = `${r},${c}`;
                        if (occupiedCells.has(cellKey)) {
                            return; // ã“ã®ãƒã‚¹ã¯æ—¢ã«ã‚«ã‚¦ãƒ³ãƒˆæ¸ˆã¿
                        }
                        occupiedCells.add(cellKey);
                        
                        const fruit = currentStage.fruits[r][c]; // ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã®æœç‰©ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å‚ç…§
                        if (fruit === 'a') {
                            counts.apple++;
                        } else if (fruit === 'g') {
                            counts.grape++;
                        } else if (fruit === 'k') { // ã‚­ã‚¦ã‚¤è¿½åŠ 
                            counts.kiwi++;
                        }
                    });
                });
                
                currentCounts = counts;
            }

            // ã‚°ãƒ©ãƒ•(æ£’ã¨æ˜Ÿ)ã‚’æ›´æ–° (ã‚°ãƒ©ãƒ•ç¨®ã«å¿œã˜ã¦åˆ†å²)
            function updateChart(animate) {
                if (!currentStage) return;
                
                const graphType = currentStage.graphType;
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«æ–‡å­—åˆ— (transition: none; ã¾ãŸã¯ç©º)
                // updateChartA ä»¥å¤–ã§ã¯ transitionStyle ã‚’ä½¿ã‚ãšã«å€‹åˆ¥ã«è¨­å®š
                
                switch (graphType) {
                    case 'A':
                        updateChartA(animate);
                        break;
                    case 'B':
                        updateChartB(animate);
                        break;
                    case 'C':
                        updateChartC(animate);
                        break;
                    case 'D':
                        updateChartD(animate);
                        break;
                }
            }
            
            // ã‚°ãƒ©ãƒ•A (æ£’ã‚°ãƒ©ãƒ•) ã®æ›´æ–°
            function updateChartA(animate) {
                const transitionStyle = animate ? '' : 'transition: none;';
                
                const targets = currentStage.targets;
                const maxCount = Math.max(5, targets.apple, targets.grape) + 1;
                const chartHeight = 250;
                const chartBottomY = 280;
                
                // Yè»¸ã‚¹ã‚±ãƒ¼ãƒ«é–¢æ•°
                const getY = (count) => chartBottomY - 20 - (count * (chartHeight / maxCount));
                const getH = (count) => (count * (chartHeight / maxCount));

                // ã‚Šã‚“ã”ã®æ£’ã¨æ˜Ÿ
                const appleCount = currentCounts.apple;
                const yApple = getY(appleCount);
                const hApple = getH(appleCount);
                
                const barApple = document.getElementById('bar-apple');
                barApple.setAttribute('y', yApple);
                barApple.setAttribute('height', hApple);
                
                const starApple = document.getElementById('star-apple');
                starApple.setAttribute('transform', `translate(48, ${yApple - 12}) scale(1.2)`);
                
                barApple.style.cssText = transitionStyle;
                starApple.style.cssText = transitionStyle;

                // ã¶ã©ã†ã®æ£’ã¨æ˜Ÿ
                const grapeCount = currentCounts.grape;
                const yGrape = getY(grapeCount);
                const hGrape = getH(grapeCount);
                
                const barGrape = document.getElementById('bar-grape');
                barGrape.setAttribute('y', yGrape);
                barGrape.setAttribute('height', hGrape);
                
                const starGrape = document.getElementById('star-grape');
                starGrape.setAttribute('transform', `translate(128, ${yGrape - 12}) scale(1.2)`);
                
                barGrape.style.cssText = transitionStyle;
                starGrape.style.cssText = transitionStyle;
            }
            
            // ã‚°ãƒ©ãƒ•B (æ•£å¸ƒå›³) ã®æ›´æ–°
            function updateChartB(animate) {
                const transitionStyle = animate ? '' : 'transition: none;';
                
                const maxCount = 7;
                const origin = { x: 40, y: 260 };
                const chartWidth = 150;
                const chartHeight = 220;
                const getX = (count) => origin.x + (count * (chartWidth / maxCount));
                const getY = (count) => origin.y - (count * (chartHeight / maxCount));

                const cx = getX(currentCounts.grape);
                const cy = getY(currentCounts.apple);

                // ç¾åœ¨ã®æ˜Ÿ
                const star = document.getElementById('star-B');
                star.setAttribute('transform', `translate(${cx - 12}, ${cy - 12}) scale(1.2)`);
                star.style.cssText = transitionStyle;
                
                // ã‚¬ã‚¤ãƒ‰ç·š
                const lineX = document.getElementById('guide-line-B-x');
                lineX.setAttribute('x1', origin.x);
                lineX.setAttribute('y1', cy);
                lineX.setAttribute('x2', cx);
                lineX.setAttribute('y2', cy);
                lineX.style.cssText = transitionStyle;
                
                const lineY = document.getElementById('guide-line-B-y');
                lineY.setAttribute('x1', cx);
                lineY.setAttribute('y1', origin.y);
                lineY.setAttribute('x2', cx);
                lineY.setAttribute('y2', cy);
                lineY.style.cssText = transitionStyle;
            }
            
            // ã‚°ãƒ©ãƒ•C (å††ã‚°ãƒ©ãƒ•) ã®æ›´æ–°
            function updateChartC(animate) {
                const transitionStyle = animate ? '' : 'transition: none;';
                
                const cx = 100, cy = 150, r = 80;
                const total = currentCounts.apple + currentCounts.grape + currentCounts.kiwi;
                const hasKiwi = (currentStage.targets.kiwi || 0) > 0 || currentCounts.kiwi > 0;
                
                const ratioApple = (total > 0) ? (currentCounts.apple / total) : 0;
                const ratioGrape = (total > 0) ? (currentCounts.grape / total) : 0;
                // ratioKiwi ã¯æ®‹ã‚Š

                // è§’åº¦ (0-1)
                const angleRatioApple = Math.max(0, Math.min(1, ratioApple));
                const angleRatioGrape = Math.max(0, Math.min(1, ratioApple + ratioGrape));

                // åº§æ¨™è¨ˆç®—ç”¨ã®è§’åº¦ (ãƒ©ã‚¸ã‚¢ãƒ³ã€12æ™‚æ–¹å‘ãŒ -PI/2)
                const angleRadApple = (angleRatioApple * 2 * Math.PI) - (Math.PI / 2);
                const angleRadGrape = (angleRatioGrape * 2 * Math.PI) - (Math.PI / 2);

                // å††å¼§ã‚’æç”»ã™ã‚‹SVGãƒ‘ã‚¹ (då±æ€§) ã‚’è¨ˆç®—
                const getArcPath = (startRatio, endRatio) => {
                    // å·®ãŒã»ã¼0ãªã‚‰æç”»ã—ãªã„
                    if (Math.abs(endRatio - startRatio) < 0.0001) return "";
                    // å·®ãŒã»ã¼1ãªã‚‰å††ã‚’æç”»
                    if (Math.abs(endRatio - startRatio) >= 0.9999) {
                        // ã»ã¼å††å…¨ä½“ã®å ´åˆã€A(arc)ãŒã†ã¾ãæç”»ã§ããªã„ã®ã§ã€2ã¤ã®åŠå††ã§æç”»
                        const midRad = (startRatio + (endRatio - startRatio) / 2) * 2 * Math.PI - (Math.PI / 2); // 12æ™‚åŸºæº–
                        const mx = cx + r * Math.cos(midRad);
                        const my = cy + r * Math.sin(midRad);
                        const endRad = endRatio * 2 * Math.PI - (Math.PI / 2); // 12æ™‚åŸºæº–
                        const ex = cx + r * Math.cos(endRad);
                        const ey = cy + r * Math.sin(endRad);
                        const startRad = startRatio * 2 * Math.PI - (Math.PI / 2); // 12æ™‚åŸºæº–
                        const sx = cx + r * Math.cos(startRad);
                        const sy = cy + r * Math.sin(startRad);
                        return `M ${cx} ${cy} L ${sx} ${sy} A ${r} ${r} 0 0 1 ${mx} ${my} A ${r} ${r} 0 0 1 ${ex} ${ey} Z`;
                    }
                    
                    const startRad = startRatio * 2 * Math.PI - (Math.PI / 2); // 12æ™‚åŸºæº–
                    const endRad = endRatio * 2 * Math.PI - (Math.PI / 2); // 12æ™‚åŸºæº–
                    const sx = cx + r * Math.cos(startRad);
                    const sy = cy + r * Math.sin(startRad);
                    const ex = cx + r * Math.cos(endRad);
                    const ey = cy + r * Math.sin(endRad);
                    const largeArcFlag = (endRatio - startRatio) > 0.5 ? 1 : 0;
                    return `M ${cx} ${cy} L ${sx} ${sy} A ${r} ${r} 0 ${largeArcFlag} 1 ${ex} ${ey} Z`;
                };

                const applePath = (total > 0) ? getArcPath(0, angleRatioApple) : "";
                const grapePath = (total > 0) ? getArcPath(angleRatioApple, angleRatioGrape) : "";
                const kiwiPath = (total > 0 && hasKiwi) ? getArcPath(angleRatioGrape, 1) : "";

                const sliceApple = document.getElementById('pie-apple');
                const sliceGrape = document.getElementById('pie-grape');
                const sliceKiwi = document.getElementById('pie-kiwi');
                
                sliceApple.setAttribute('d', applePath);
                sliceGrape.setAttribute('d', grapePath);
                sliceKiwi.setAttribute('d', kiwiPath);

                // æ˜Ÿã®ä½ç½® (æ˜Ÿã¯ transform ã§ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹ã®ã§OK)
                // æ˜Ÿ1 (Apple)
                const starXApple = cx + r * Math.cos(angleRadApple);
                const starYApple = cy + r * Math.sin(angleRadApple);
                const starApple = document.getElementById('star-C-apple');
                starApple.setAttribute('transform', `translate(${starXApple - 12}, ${starYApple - 12}) scale(1.2)`);
                starApple.style.cssText = transitionStyle;
                
                // æ˜Ÿ2 (Grape)
                const starGrape = document.getElementById('star-C-grape');
                if (hasKiwi) {
                    const starXGrape = cx + r * Math.cos(angleRadGrape);
                    const starYGrape = cy + r * Math.sin(angleRadGrape);
                    starGrape.setAttribute('transform', `translate(${starXGrape - 12}, ${starYGrape - 12}) scale(1.2)`);
                    starGrape.style.cssText = transitionStyle;
                    starGrape.style.display = 'block';
                } else {
                    starGrape.style.display = 'none';
                }
            }

            // ã‚°ãƒ©ãƒ•D (å¸¯ã‚°ãƒ©ãƒ•) ã®æ›´æ–°
            function updateChartD(animate) {
                const total = currentCounts.apple + currentCounts.grape + currentCounts.kiwi;
                const hasKiwi = (currentStage.targets.kiwi || 0) > 0 || currentCounts.kiwi > 0;
                
                const ratioApple = (total > 0) ? (currentCounts.apple / total) : 0;
                const ratioGrape = (total > 0) ? (currentCounts.grape / total) : 0;
                const ratioKiwi = (total > 0) ? (currentCounts.kiwi / total) : 0;

                const percentApple = ratioApple * 100;
                const percentGrape = ratioGrape * 100;
                const percentKiwi = ratioKiwi * 100;

                const barApple = document.getElementById('bar-D-apple');
                const barGrape = document.getElementById('bar-D-grape');
                const barKiwi = document.getElementById('bar-D-kiwi');
                const starApple = document.getElementById('star-D-current-apple');
                const starGrape = document.getElementById('star-D-current-grape');
                
                barApple.style.width = `${percentApple}%`;
                barGrape.style.width = `${percentGrape}%`;
                barKiwi.style.width = `${percentKiwi}%`;
                starApple.style.left = `${percentApple}%`;
                
                barApple.style.transition = animate ? 'width 0.3s ease-in-out' : 'none';
                barGrape.style.transition = animate ? 'width 0.3s ease-in-out' : 'none';
                barKiwi.style.transition = animate ? 'width 0.3s ease-in-out' : 'none';
                starApple.style.transition = animate ? 'left 0.3s ease-in-out' : 'none';

                if (hasKiwi) {
                    const percentAppleGrape = (ratioApple + ratioGrape) * 100;
                    starGrape.style.left = `${percentAppleGrape}%`;
                    starGrape.style.transition = animate ? 'left 0.3s ease-in-out' : 'none';
                    starGrape.style.display = 'block';
                } else {
                    starGrape.style.display = 'none';
                }
            }


            // å‹åˆ©æ¡ä»¶ã‚’ãƒã‚§ãƒƒã‚¯
            function checkWin() {
                if (!currentStage) return; // ã‚¹ãƒ†ãƒ¼ã‚¸ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„
                
                const targets = currentStage.targets;
                const graphType = currentStage.graphType;
                let isWin = false;

                if (graphType === 'A' || graphType === 'B') {
                    // ã‚°ãƒ©ãƒ•A, B: å€‹æ•°ãŒå®Œå…¨ã«ä¸€è‡´
                    isWin = (currentCounts.apple === targets.apple && 
                             currentCounts.grape === targets.grape);
                } else {
                    // ã‚°ãƒ©ãƒ•C, D: å‰²åˆã§åˆ¤å®š
                    const targetTotal = (targets.apple || 0) + (targets.grape || 0) + (targets.kiwi || 0);
                    const hasKiwiTarget = (targets.kiwi || 0) > 0;
                    
                    const targetRatioApple = (targetTotal > 0) ? ((targets.apple || 0) / targetTotal) : 0;
                    const targetRatioGrape = (targetTotal > 0) ? ((targets.grape || 0) / targetTotal) : 0;
                    
                    const currentTotal = currentCounts.apple + currentCounts.grape + currentCounts.kiwi;
                    const currentRatioApple = (currentTotal > 0) ? (currentCounts.apple / currentTotal) : 0;
                    const currentRatioGrape = (currentTotal > 0) ? (currentCounts.grape / currentTotal) : 0;

                    // åˆè¨ˆãŒ0ã®å ´åˆã¯ã‚¯ãƒªã‚¢ã¨ã—ãªã„
                    if (currentTotal === 0 && targetTotal > 0) {
                        isWin = false;
                    } 
                    // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãŒ0:0:0ã®å ´åˆã€ç¾åœ¨ã‚‚0:0:0ãªã‚‰ã‚¯ãƒªã‚¢
                    else if (targetTotal === 0 && currentTotal === 0) {
                        isWin = true;
                    }
                    // å‰²åˆãŒä¸€è‡´ (æµ®å‹•å°æ•°ç‚¹æ•°ã®ãŸã‚é–¾å€¤ã§æ¯”è¼ƒ)
                    else {
                        const appleMatch = Math.abs(currentRatioApple - targetRatioApple) < 0.001;
                        const grapeMatch = Math.abs(currentRatioGrape - targetRatioGrape) < 0.001;
                        
                        if (hasKiwiTarget) {
                            // 3ç¨®é¡ã®å ´åˆã€apple ã¨ grape ã®ä¸¡æ–¹ã®å‰²åˆãŒä¸€è‡´
                            // (kiwiã¯è‡ªå‹•çš„ã«ä¸€è‡´ã™ã‚‹)
                            isWin = appleMatch && grapeMatch;
                        } else {
                            // 2ç¨®é¡ã®å ´åˆã€apple ã®å‰²åˆãŒä¸€è‡´ (grapeã‚‚è‡ªå‹•çš„ã«ä¸€è‡´ã™ã‚‹)
                            isWin = appleMatch;
                        }
                    }
                }

                if (isWin) {
                    winMessageElement.classList.remove('opacity-0', 'scale-95', 'pointer-events-none');
                    winMessageElement.classList.add('opacity-100', 'scale-100');
                } else {
                    winMessageElement.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
                    winMessageElement.classList.remove('opacity-100', 'scale-100');
                }
            }
            
            // æ ã®DOMä½ç½®ã‚’æ›´æ–°
            function updateFramePosition(frame, newAnchor) {
                frame.anchor = newAnchor;
                frame.domElements.forEach((el, index) => {
                    const offset = frame.pieces[index];
                    const newRow = newAnchor.r + offset.r + 1;
                    const newCol = newAnchor.c + offset.c + 1;
                    el.style.gridRow = newRow;
                    el.style.gridColumn = newCol;
                });
            }

            // --- 4. ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆ ---
            
            function handleDragStart(e) {
                // æ ãŒç§»å‹•ä¸­ãªã‚‰ä½•ã‚‚ã—ãªã„ (äºŒé‡ãƒ‰ãƒ©ãƒƒã‚°é˜²æ­¢)
                if (isDragging) return;
                
                const frameId = parseInt(e.currentTarget.dataset.frameId, 10);
                activeFrame = frames.find(f => f.id === frameId);
                if (!activeFrame) return;

                // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
                isDragging = true;
                dragStartGrid = { ...activeFrame.anchor };
                lastDragGrid = { ...activeFrame.anchor };
                
                const pos = getEventPosition(e);
                dragStartPos = pos;
                
                activeFrame.domElements.forEach(el => el.classList.add('dragging'));

                // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
                window.addEventListener('mousemove', handleDragMove);
                window.addEventListener('mouseup', handleDragEnd);
                window.addEventListener('touchmove', handleDragMove, { passive: false });
                window.addEventListener('touchend', handleDragEnd);
                
                // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç„¡åŠ¹åŒ–
                if (e.type === 'touchstart') {
                    e.preventDefault();
                }
            }

            function handleDragMove(e) {
                if (!isDragging || !activeFrame) return;

                e.preventDefault(); // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚„é¸æŠã‚’é˜²æ­¢

                const pos = getEventPosition(e);
                
                // ãƒã‚¹ã®ã‚µã‚¤ã‚ºã‚’å–å¾— (ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ)
                const cellRect = boardElement.children[0].getBoundingClientRect();
                const cellWidth = cellRect.width;
                const cellHeight = cellRect.height;
                
                // ç§»å‹•é‡ã‚’è¨ˆç®—
                const deltaX = pos.x - dragStartPos.x;
                const deltaY = pos.y - dragStartPos.y;
                
                // ç§»å‹•é‡ã‚’ãƒã‚¹å˜ä½ã«å¤‰æ›
                const gridDeltaC = Math.round(deltaX / cellWidth);
                const gridDeltaR = Math.round(deltaY / cellHeight);
                
                // æ–°ã—ã„ã‚°ãƒªãƒƒãƒ‰ä½ç½®
                let newR = dragStartGrid.r + gridDeltaR;
                let newC = dragStartGrid.c + gridDeltaC;
                
                // 1ãƒã‚¹ãšã¤å‹•ã‹ã™ (å‰å›ã®ä½ç½®ã¨ç•°ãªã‚‹å ´åˆã®ã¿)
                if (newR !== lastDragGrid.r || newC !== lastDragGrid.c) {
                    
                    // 1ãƒã‚¹ä»¥ä¸Šé›¢ã‚Œã¦ã„ãŸã‚‰ã€1ãƒã‚¹ã«åˆ¶é™ã™ã‚‹
                    if (Math.abs(newR - lastDragGrid.r) > 1) {
                        newR = lastDragGrid.r + Math.sign(newR - lastDragGrid.r);
                    }
                    if (Math.abs(newC - lastDragGrid.c) > 1) {
                        newC = lastDragGrid.c + Math.sign(newC - lastDragGrid.c);
                    }
                    
                    // ç›¤é¢å†…ã‹ãƒã‚§ãƒƒã‚¯
                    if (isValidPosition(activeFrame, newR, newC)) {
                        // æ ã®ä½ç½®ã‚’æ›´æ–° (DOM)
                        updateFramePosition(activeFrame, { r: newR, c: newC });
                        
                        // ä½ç½®ã‚’æ›´æ–°
                        lastDragGrid = { r: newR, c: newC };
                        
                        // ã‚¹ã‚³ã‚¢ã¨ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°
                        updateGame(true); // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚ã‚Š
                    } else {
                        // æ å¤–ã«å‡ºã‚ˆã†ã¨ã—ãŸã‚‰ã€å…ƒã®ä½ç½®ã«æˆ»ã™ (ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ä½ç½®ã§ã¯ãªãã€å‰å›æœ‰åŠ¹ã ã£ãŸä½ç½®)
                        // ãŸã ã—ã€ãƒ‰ãƒ©ãƒƒã‚°è‡ªä½“ã¯ç¶™ç¶š
                        newR = lastDragGrid.r;
                        newC = lastDragGrid.c;
                    }
                }
                
                // DOMè¦ç´ ã®transformã‚’æ›´æ–° (è¦–è¦šçš„ãªè¿½å¾“)
                // (ã‚°ãƒªãƒƒãƒ‰ç§»å‹•ãŒ1ãƒã‚¹å˜ä½ãªã®ã§ã€ã“ã‚Œã¯ä¸è¦ã‹ã‚‚ã—ã‚Œãªã„)
                /*
                activeFrame.domElements.forEach(el => {
                    // ã‚°ãƒªãƒƒãƒ‰ä½ç½®ã‹ã‚‰ã®å·®åˆ†ã‚’è¨ˆç®—
                    const visualDeltaX = deltaX - (gridDeltaC * cellWidth);
                    const visualDeltaY = deltaY - (gridDeltaR * cellHeight);
                    el.style.transform = `translate(${visualDeltaX}px, ${visualDeltaY}px) scale(1.05)`;
                });
                */
            }

            function handleDragEnd(e) {
                if (!isDragging || !activeFrame) return;
                
                // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†
                isDragging = false;
                
                activeFrame.domElements.forEach(el => {
                    el.classList.remove('dragging');
                    el.style.transform = ''; // è¦–è¦šçš„ãªtransformã‚’ãƒªã‚»ãƒƒãƒˆ
                });
                
                // æœ€çµ‚çš„ãªã‚¢ãƒ³ã‚«ãƒ¼ä½ç½®ã‚’ç¢ºå®š
                activeFrame.anchor = { ...lastDragGrid };
                updateFramePosition(activeFrame, activeFrame.anchor); // å¿µã®ãŸã‚å†é…ç½®
                
                activeFrame = null;
                
                // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªãƒªã‚¹ãƒŠãƒ¼ã‚’è§£é™¤
                window.removeEventListener('mousemove', handleDragMove);
                window.removeEventListener('mouseup', handleDragEnd);
                window.removeEventListener('touchmove', handleDragMove);
                window.removeEventListener('touchend', handleDragEnd);
                
                // æœ€çµ‚çš„ãªã‚¹ã‚³ã‚¢æ›´æ–°ã¨å‹åˆ©åˆ¤å®š
                updateGame(true);
            }

            // æ ãŒç›¤é¢å†…ã«åã¾ã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            function isValidPosition(frame, newR, newC) {
                for (const offset of frame.pieces) {
                    const r = newR + offset.r;
                    const c = newC + offset.c;
                    
                    if (r < 0 || r >= BOARD_ROWS || c < 0 || c >= BOARD_COLS) {
                        return false;
                    }
                }
                return true;
            }

            // mousedown/touchstart, mousemove/touchmove ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰åº§æ¨™ã‚’å–å¾—
            function getEventPosition(e) {
                if (e.touches && e.touches.length > 0) {
                    // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆ
                    return { x: e.touches[0].clientX, y: e.touches[0].clientY };
                } else {
                    // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆ
                    return { x: e.clientX, y: e.clientY };
                }
            }

            // --- 5. ã‚²ãƒ¼ãƒ é–‹å§‹ ---
            initApp();

        });
    </script>

</body>
</html>