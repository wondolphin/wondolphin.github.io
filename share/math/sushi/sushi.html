<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—©é£Ÿã„ã‚¯ã‚¤ã‚º</title>
    <!-- Tailwind CSS CDN --><script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Interãƒ•ã‚©ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Noto+Sans+JP:wght@400;700&display=swap');
        
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            /* çš¿ã®åŸºæœ¬ã‚µã‚¤ã‚ºã€‚ç”»åƒã®ã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦èª¿æ•´ã—ã¦ãã ã•ã„ */
            --plate-width: 3rem; /* 48px (p-4 -> p-2) */
            --plate-height: 0.5rem; /* 8px */
            --plate-margin: -1px; /* çš¿ãŒé‡ãªã‚‹ã‚ˆã†ã«èª¿æ•´ */
            
            /* 1ã‚¹ã‚¿ãƒƒã‚¯ã‚ãŸã‚Šã®æœ€å¤§çš¿æšæ•°ï¼ˆJSã«ã‚ˆã‚Šå‹•çš„ã«è¨­å®šã•ã‚Œã‚‹ï¼‰ */
            --center-max-plates: 30;
            --counter-max-plates: 30;
        }

        /* çš¿ã®ç”»åƒ */
        .plate-img {
            width: var(--plate-width);
            height: var(--plate-height);
            object-fit: cover;
            margin-bottom: var(--plate-margin);
            transition: opacity 0.2s ease-out, height 0.2s ease-out, margin-bottom 0.2s ease-out, content 0.2s ease-out;
            /* ã‚¢ãƒ‰ãƒãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰ç”¨ã«ã€srcã®å¤‰æ›´ã‚’é«˜é€ŸåŒ– */
            content-visibility: auto;
        }

        /* çš¿ã®ã‚¹ãƒšãƒ¼ã‚µãƒ¼ï¼ˆé«˜ã•ã‚’åˆã‚ã›ã‚‹ãŸã‚ï¼‰ */
        .plate-spacer {
            width: var(--plate-width);
            height: var(--plate-height);
            margin-bottom: var(--plate-margin);
            opacity: 0;
            pointer-events: none;
        }

        /* ã‚¹ã‚¿ãƒƒã‚¯ã®é«˜ã•ï¼ˆä¸­å¤®ï¼‰ */
        .center-stack-wrapper {
             height: calc((var(--plate-height) + var(--plate-margin)) * var(--center-max-plates));
             overflow: hidden;
        }
        
        /* ã‚¹ã‚¿ãƒƒã‚¯ã®é«˜ã•ï¼ˆã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ï¼‰ */
        .counter-stack-wrapper {
             height: calc((var(--plate-height) + var(--plate-margin)) * var(--counter-max-plates));
             overflow: hidden;
        }


        /* ä¸­å¤®ã®é£Ÿã¹ã‚‰ã‚Œã‚‹çš¿ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ï¼‰ */
        .plate-center-wrapper {
            display: flex;
            flex-direction: column-reverse; /* ä¸‹ã‹ã‚‰ç©ã‚€ï¼ˆDOMã®æœ€å¾ŒãŒä¸€ç•ªä¸Šï¼‰ */
            justify-content: flex-start; /* ä¸Šæƒãˆ */
        }
        
        .plate-center-wrapper .plate-img.eaten {
            opacity: 0;
            height: 0; /* é«˜ã•ã‚’0ã«ã™ã‚‹ */
            margin-bottom: 0; /* ãƒãƒ¼ã‚¸ãƒ³ã‚‚0ã«ã™ã‚‹ */
            padding: 0;
            border: 0;
        }


        /* å·¦å³ã®çš¿ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã®ãƒ©ãƒƒãƒ‘ãƒ¼ */
        .char-plate-counter-wrapper {
            display: flex;
            flex-direction: column-reverse; /* ä¸‹ã‹ã‚‰ä¸Šã¸ç©ã‚€ */
        }


        /* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®æŒ¯å‹•ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .vibrate {
            animation: vibrate 0.3s linear infinite; /* 0.1s -> 0.3s */
        }
        @keyframes vibrate {
            0% { transform: translate(0, 0); }
            25% { transform: translate(-1px, 1px); }
            50% { transform: translate(1px, -1px); }
            75% { transform: translate(-1px, -1px); }
            100% { transform: translate(1px, 1px); }
        }

        /* å¹ãå‡ºã— */
        .speech-bubble {
            position: relative;
            background: white;
            border-radius: .4em;
            padding: 0.75rem; /* padding: 1rem -> 0.75rem */
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            min-height: 80px; /* 2è¡Œåˆ†ã®é«˜ã•ã‚’ç¢ºä¿ */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center; /* ä¸­å¤®æƒãˆ */
        }
        /* å¹ãå‡ºã—ã®ä¸‰è§’éƒ¨åˆ† */
        .speech-bubble:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 0;
            border: 15px solid transparent;
            border-top-color: white;
            border-bottom: 0;
            margin-left: -15px;
            margin-bottom: -15px;
        }
        .speech-bubble .question-mark {
            color: #ef4444; /* red-500 */
            font-size: 1.5rem; /* text-2xl */
            line-height: 2rem;
        }

        /* é¸æŠè‚¢ã®çš¿ã‚¹ã‚¿ãƒƒã‚¯ï¼ˆé«˜ã•å›ºå®šï¼‰ */
        .option-stack {
            display: flex;
            flex-direction: column-reverse; /* ä¸‹ã‹ã‚‰ç©ã‚€ */
            height: calc((var(--plate-height) + var(--plate-margin)) * var(--counter-max-plates));
            overflow: hidden;
        }

        /* ã‚¢ãƒ‰ãƒãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰ã®é¸æŠè‚¢ãƒœã‚¿ãƒ³ */
        .advance-option-btn {
            font-size: 2.25rem; /* text-4xl */
            font-weight: 700; /* font-bold */
            width: 8rem; /* w-32 */
            height: 6rem; /* h-24 */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
    </style>
</head>
<body class="bg-yellow-100 min-h-screen flex flex-col items-center justify-center p-4">

    <!-- ãƒ¢ãƒ¼ãƒ‰é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="mode-select-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
        <div class="bg-white p-12 rounded-lg shadow-2xl text-center">
            <h2 class="text-3xl font-bold mb-8">ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
            <div class="flex gap-8">
                <button id="select-normal-mode" class="bg-blue-500 text-white font-bold py-4 px-8 rounded-lg transition hover:bg-blue-600 text-2xl">ãƒãƒ¼ãƒãƒ«ãƒ¢ãƒ¼ãƒ‰</button>
                <button id="select-advanced-mode" class="bg-green-500 text-white font-bold py-4 px-8 rounded-lg transition hover:bg-green-600 text-2xl">ã‚¢ãƒ‰ãƒãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰</button>
            </div>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã®ã‚²ãƒ¼ãƒ ç”»é¢ï¼ˆåˆæœŸçŠ¶æ…‹ã§ã¯éè¡¨ç¤ºï¼‰ -->
    <div id="game-wrapper" class="hidden">
        <!-- å•é¡Œé¸æŠUI -->
        <div id="quiz-select-container" class="flex justify-center gap-2 mb-4">
            <!-- JSã§ãƒœã‚¿ãƒ³ãŒç”Ÿæˆã•ã‚Œã¾ã™ -->
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ã®ã‚²ãƒ¼ãƒ ç”»é¢ --><div id="game-container" class="w-full max-w-4xl mx-auto">
            
            <!-- 1. ã‚²ãƒ¼ãƒ ã‚·ãƒ¼ãƒ³ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ã®ä¸Šï¼‰ --><div class="relative w-full">
                <!-- ãƒ†ãƒ¼ãƒ–ãƒ« --><div class="absolute bottom-0 left-0 w-full h-32 bg-yellow-800 rounded-t-lg shadow-inner"></div>
                
                <!-- è¦ç´ ã®é…ç½®ã‚³ãƒ³ãƒ†ãƒŠ --><div class="relative flex justify-around items-end h-[250px] px-4 z-10"> <!-- h-[220px] -> h-[250px] -->

                    <!-- ã‚­ãƒ£ãƒ©1 (å·¦) ã®çš¿ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ --><div id="char1-stacks-container" class="flex gap-2">
                        <!-- JSã§ã‚¹ã‚¿ãƒƒã‚¯ãŒç”Ÿæˆã•ã‚Œã¾ã™ --></div>

                    <!-- ã‚­ãƒ£ãƒ©1 (å·¦) ã¨å¹ãå‡ºã— --><div class="flex flex-col items-center">
                        <div id="char1-bubble" class="speech-bubble mb-3">
                            <div id="char1-delay" class="text-xl font-bold text-gray-500"></div>
                            <div id="char1-speed" class="text-xl font-bold"></div>
                        </div>
                        <img id="char1" src="character1.png" alt="ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼1" class="w-24 h-24 object-contain shadow-lg">
                    </div>

                    <!-- ä¸­å¤®ã®çš¿ --><div id="center-stacks-container" class="flex gap-4">
                        <!-- JSã§ã‚¹ã‚¿ãƒƒã‚¯ãŒç”Ÿæˆã•ã‚Œã¾ã™ --></div>

                    <!-- ã‚­ãƒ£ãƒ©2 (å³) ã¨å¹ãå‡ºã— --><div class="flex flex-col items-center">
                        <div id="char2-bubble" class="speech-bubble mb-3">
                            <div id="char2-delay" class="text-xl font-bold text-gray-500"></div>
                            <div id="char2-speed" class="text-xl font-bold"></div>
                        </div>
                        <img id="char2" src="character2.png" alt="ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼2" class="w-24 h-24 object-contain shadow-lg">
                    </div>

                    <!-- ã‚­ãƒ£ãƒ©2 (å³) ã®çš¿ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ --><div id="char2-stacks-container" class="flex gap-2">
                        <!-- JSã§ã‚¹ã‚¿ãƒƒã‚¯ãŒç”Ÿæˆã•ã‚Œã¾ã™ --></div>

                </div>
            </div>

            <!-- 2. é¸æŠè‚¢ãƒœã‚¿ãƒ³ --><div id="options-container" class="flex justify-center gap-4 sm:gap-8 mt-8 flex-wrap">
                <!-- é¸æŠè‚¢ 1 --><button data-value="18" class="option-btn bg-white border-4 border-green-600 rounded-lg shadow-md p-2 flex flex-col sm:flex-row items-center gap-2 transform transition hover:scale-105 focus:outline-none focus:ring-4 focus:ring-green-400">
                    <div class="normal-option-content flex flex-col sm:flex-row items-center gap-2">
                        <img src="character2.png" alt="ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼2" class="w-12 h-12 object-contain">
                        <div id="option-1-stacks-container" class="flex gap-2">
                            <!-- JSã§ã‚¹ã‚¿ãƒƒã‚¯ãŒç”Ÿæˆã•ã‚Œã¾ã™ -->
                        </div>
                        <span class="option-label font-bold text-lg sm:hidden">18æš</span>
                    </div>
                    <div class="advanced-option-content hidden advance-option-btn">
                        <!-- JSã§æ•°å€¤ãŒè¨­å®šã•ã‚Œã¾ã™ -->
                    </div>
                </button>
                
                <!-- é¸æŠè‚¢ 2 --><button data-value="32" class="option-btn bg-white border-4 border-green-600 rounded-lg shadow-md p-2 flex flex-col sm:flex-row items-center gap-2 transform transition hover:scale-105 focus:outline-none focus:ring-4 focus:ring-green-400">
                    <div class="normal-option-content flex flex-col sm:flex-row items-center gap-2">
                        <img src="character2.png" alt="ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼2" class="w-12 h-12 object-contain">
                        <div id="option-2-stacks-container" class="flex gap-2">
                            <!-- JSã§ã‚¹ã‚¿ãƒƒã‚¯ãŒç”Ÿæˆã•ã‚Œã¾ã™ -->
                        </div>
                        <span class="option-label font-bold text-lg sm:hidden">32æš</span>
                    </div>
                    <div class="advanced-option-content hidden advance-option-btn">
                        <!-- JSã§æ•°å€¤ãŒè¨­å®šã•ã‚Œã¾ã™ -->
                    </div>
                </button>

                <!-- é¸æŠè‚¢ 3 --><button data-value="42" class="option-btn bg-white border-4 border-green-600 rounded-lg shadow-md p-2 flex flex-col sm:flex-row items-center gap-2 transform transition hover:scale-105 focus:outline-none focus:ring-4 focus:ring-green-400">
                    <div class="normal-option-content flex flex-col sm:flex-row items-center gap-2">
                        <img src="character2.png" alt="ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼2" class="w-12 h-12 object-contain">
                        <div id="option-3-stacks-container" class="flex gap-2">
                            <!-- JSã§ã‚¹ã‚¿ãƒƒã‚¯ãŒç”Ÿæˆã•ã‚Œã¾ã™ -->
                        </div>
                        <span class="option-label font-bold text-lg sm:hidden">42æš</span>
                    </div>
                    <div class="advanced-option-content hidden advance-option-btn">
                        <!-- JSã§æ•°å€¤ãŒè¨­å®šã•ã‚Œã¾ã™ -->
                    </div>
                </button>
            </div>

        </div>
    </div>

    <!-- çµæœè¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ« --><div id="result-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-2xl text-center">
            <h2 id="result-title" class="text-4xl font-bold mb-4"></h2>
            <p id="result-message" class="text-lg mb-6"></p>
            <button id="reset-button" class="bg-blue-500 text-white font-bold py-2 px-6 rounded-lg transition hover:bg-blue-600">ã‚‚ã†ä¸€åº¦</button>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- å®šæ•° ---
            const ANIMATION_INTERVAL_MS = 250; // 0.25ç§’ã”ã¨

            // --- ãƒ¢ãƒ¼ãƒ‰åˆ¥å•é¡Œãƒ‡ãƒ¼ã‚¿ ---

            // ãƒãƒ¼ãƒãƒ«ãƒ¢ãƒ¼ãƒ‰: æœ€çµ‚çš„ã«ã‚­ãƒ£ãƒ©2ãŒä½•æšé£Ÿã¹ãŸã‹ã‚’å½“ã¦ã‚‹
            const normalQuizData = [
                {
                    id: 0,
                    title: "å•é¡Œ 1",
                    centerStacks: 2, centerMaxPlates: 24,
                    counterStacks: 2, counterMaxPlates: 24,
                    char1: { speed: 2, delay: 0, speechDelayText: "", speechSpeedText: "ğŸ½ï¸ 2ãšã¤!" },
                    char2: { speed: 4, delay: 0, speechDelayText: "", speechSpeedText: "ğŸ½ï¸ 4ãšã¤!" },
                    centerPlates: 48,
                    initialPlates: { char1: 0, char2: 0 },
                    options: [18, 32, 42]
                    // æ­£è§£: 32
                },
                {
                    id: 1,
                    title: "å•é¡Œ 2",
                    centerStacks: 2, centerMaxPlates: 30,
                    counterStacks: 2, counterMaxPlates: 30,
                    char1: { speed: 3, delay: 0, speechDelayText: "", speechSpeedText: "ğŸ½ï¸ 3ãšã¤!" },
                    char2: { speed: 3, delay: 2, speechDelayText: "â³ 2ã³ã‚‡ã†", speechSpeedText: "ğŸ½ï¸ 3ãšã¤!" },
                    centerPlates: 60,
                    initialPlates: { char1: 0, char2: 0 },
                    options: [30, 33, 27]
                    // æ­£è§£: 27
                },
                {
                    id: 2,
                    title: "å•é¡Œ 3",
                    centerStacks: 2, centerMaxPlates: 21,
                    counterStacks: 3, counterMaxPlates: 21,
                    char1: { speed: 2, delay: 0, speechDelayText: "", speechSpeedText: "ğŸ½ï¸ 2ãšã¤!" },
                    char2: { speed: 5, delay: 0, speechDelayText: "", speechSpeedText: "ğŸ½ï¸ 5ãšã¤!" },
                    centerPlates: 42,
                    initialPlates: { char1: 10, char2: 10 },
                    options: [30, 40, 50]
                    // æ­£è§£: 40
                }
            ];

            // ã‚¢ãƒ‰ãƒãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰: ã€Œï¼Ÿã€ã«å…¥ã‚‹æ•°å€¤ã‚’å½“ã¦ã‚‹
            // ä¸¡ã‚­ãƒ£ãƒ©ãŒç›®æ¨™æšæ•° (targetPlates) ã´ã£ãŸã‚Šã«ãªã‚Œã°æ­£è§£
            const advancedQuizData = [
                {
                    id: 0,
                    title: "å•é¡Œ 1",
                    centerStacks: 2, centerMaxPlates: 24,
                    counterStacks: 2, counterMaxPlates: 24,
                    // char1: 12æš, char2: 36æš ãŒç›®æ¨™
                    targetPlates: { char1: 12, char2: 36 },
                    // char2ã®é€Ÿåº¦ãŒã€Œï¼Ÿã€
                    questionMark: 'char2.speed', // 'charN.speed' or 'charN.delay'
                    char1: { speed: 2, delay: 0, speechDelayText: "", speechSpeedText: "ğŸ½ï¸ 2ãšã¤!" },
                    char2: { speed: '?', delay: 0, speechDelayText: "", speechSpeedText: "ğŸ½ï¸ ï¼Ÿãšã¤!" },
                    centerPlates: 48,
                    initialPlates: { char1: 0, char2: 0 },
                    options: [4, 6, 8],
                    correctOptionValue: 6 // (48çš¿ / (2+6)çš¿/ç§’) = 6ç§’ã€‚ char1: 2*6=12æš, char2: 6*6=36æš
                },
                {
                    // å•é¡Œ2ã®å†è¨­å®šï¼ˆæ­£è§£ãŒ5ã«ãªã‚‹ã‚ˆã†ã«ï¼‰
                    id: 1,
                    title: "å•é¡Œ 2",
                    centerStacks: 2, centerMaxPlates: 30,
                    counterStacks: 2, counterMaxPlates: 30,
                    targetPlates: { char1: 30, char2: 30 },
                    questionMark: 'char1.speed',
                    char1: { speed: '?', delay: 0, speechDelayText: "", speechSpeedText: "ğŸ½ï¸ ï¼Ÿãšã¤!" },
                    char2: { speed: 5, delay: 0, speechDelayText: "", speechSpeedText: "ğŸ½ï¸ 5ãšã¤!" },
                    centerPlates: 60,
                    initialPlates: { char1: 0, char2: 0 },
                    options: [3, 4, 5],
                    correctOptionValue: 5 // (60çš¿ / (5+5)çš¿/ç§’) = 6ç§’ã€‚ char1: 5*6=30æš, char2: 5*6=30æš
                },
                {
                    // ã‚¢ãƒ‰ãƒãƒ³ã‚¹å•é¡Œ3 (delay) - æœ€çµ‚
                    id: 2,
                    title: "å•é¡Œ 3",
                    centerStacks: 2, centerMaxPlates: 20,
                    counterStacks: 2, counterMaxPlates: 20,
                    targetPlates: { char1: 10, char2: 30 }, 
                    questionMark: 'char1.delay',
                    char1: { speed: 2, delay: '?', speechDelayText: "â³ ï¼Ÿã³ã‚‡ã†", speechSpeedText: "ğŸ½ï¸ 2ãšã¤!" },
                    char2: { speed: 5, delay: 0, speechDelayText: "", speechSpeedText: "ğŸ½ï¸ 5ãšã¤!" },
                    centerPlates: 40,
                    initialPlates: { char1: 0, char2: 0 },
                    options: [1, 2, 3],
                    correctOptionValue: 1 // (ä¸Šè¨˜è¨ˆç®—å‚ç…§)
                }
            ];
            
            let currentGameMode = 'normal'; // 'normal' or 'advanced'
            let quizData = normalQuizData; // ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰ã®ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿
            let currentQuizId = 0;

            // --- å‹•çš„å¤‰æ•° ---
            let CENTER_MAX_PLATES = 30;
            let COUNTER_MAX_PLATES = 30;

            // --- DOMè¦ç´  ---
            const modeSelectModal = document.getElementById('mode-select-modal');
            const gameWrapper = document.getElementById('game-wrapper');
            const selectNormalModeBtn = document.getElementById('select-normal-mode');
            const selectAdvancedModeBtn = document.getElementById('select-advanced-mode');
            
            const centerStacksContainer = document.getElementById('center-stacks-container');
            const char1StacksContainer = document.getElementById('char1-stacks-container');
            const char2StacksContainer = document.getElementById('char2-stacks-container');
            const optionContainers = [
                document.getElementById('option-1-stacks-container'),
                document.getElementById('option-2-stacks-container'),
                document.getElementById('option-3-stacks-container')
            ];
            
            // ã‚¹ã‚¿ãƒƒã‚¯ã®DOMé…åˆ—ï¼ˆå‹•çš„ã«ç”Ÿæˆï¼‰
            let centerStacks = [];
            let char1Stacks = [];
            let char2Stacks = [];
            let optionStackElements = [[], [], []];

            const char1 = document.getElementById('char1');
            const char2 = document.getElementById('char2');
            
            // å¹ãå‡ºã—ã®è¦ç´ 
            const char1BubbleDelay = document.getElementById('char1-delay');
            const char1BubbleSpeed = document.getElementById('char1-speed');
            const char2BubbleDelay = document.getElementById('char2-delay');
            const char2BubbleSpeed = document.getElementById('char2-speed');
            
            const optionButtons = document.querySelectorAll('.option-btn');
            const quizSelectContainer = document.getElementById('quiz-select-container');
            const resultModal = document.getElementById('result-modal');
            const resultTitle = document.getElementById('result-title');
            const resultMessage = document.getElementById('result-message');
            const resetButton = document.getElementById('reset-button');

            // --- çŠ¶æ…‹ ---
            let gameInProgress = false;
            let animationStep = 0; // 0.25ç§’ã”ã¨ã®ã‚¹ãƒ†ãƒƒãƒ—æ•°
            let animationInterval = null;
            let finalCounts = { char1: 0, char2: 0 }; // æœ€çµ‚çµæœæ ¼ç´ç”¨

            // --- é–¢æ•° ---

            /**
             * çš¿ã®DOMè¦ç´ ã‚’ä½œæˆã™ã‚‹
             * @param {string} type - 'plate', 'invisible', 'empty', 'spacer', 'quota'
             */
            function createPlateElement(type) {
                if (type === 'spacer') {
                    const spacer = document.createElement('div');
                    spacer.className = 'plate-spacer';
                    return spacer;
                }
                
                const img = document.createElement('img');
                img.className = 'plate-img';
                if (type === 'plate') {
                    img.src = 'plate.png';
                    img.alt = 'çš¿';
                } else if (type === 'invisible') {
                    img.src = 'plate_invisible.png';
                    img.alt = 'çš¿ã®ã‚·ãƒ«ã‚¨ãƒƒãƒˆ';
                } else if (type === 'empty') {
                    img.src = 'plate_empty.png';
                    img.alt = 'ä½¿ç”¨æ¸ˆã¿ã®çš¿';
                } else if (type === 'quota') {
                    img.src = 'plate_quota.png';
                    img.alt = 'ç›®æ¨™ã®çš¿';
                }
                return img;
            }

            /**
             * ä¸­å¤®ã®çš¿ã®å±±ã‚’ä½œæˆã™ã‚‹ (æœ€å¤§æšæ•°ã¾ã§ã‚¹ãƒšãƒ¼ã‚µãƒ¼ã§åŸ‹ã‚ã‚‹)
             */
            function createCenterStack(container, count) {
                container.innerHTML = ''; // åˆæœŸåŒ–
                for (let i = 0; i < CENTER_MAX_PLATES; i++) {
                    if (i < (CENTER_MAX_PLATES - count)) {
                        container.appendChild(createPlateElement('spacer')); // å…ˆã«ã‚¹ãƒšãƒ¼ã‚µãƒ¼
                    } else {
                        container.appendChild(createPlateElement('plate')); // å¾Œã§çš¿
                    }
                }
            }
            
            /**
             * å·¦å³ã®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼çš¿ã®å±±ã‚’ä½œæˆã™ã‚‹ (ã‚¢ãƒ‰ãƒãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ)
             * @param {HTMLElement} container - çš¿ã‚’è¿½åŠ ã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠ
             * @param {number} emptyCount - é£Ÿã¹ãŸçš¿ã®æšæ•° (initialPlates)
             * @param {number} targetCount - ç›®æ¨™æšæ•° (ã‚¢ãƒ‰ãƒãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰ç”¨)
             */
            function createCounterStack(container, emptyCount, targetCount) {
                container.innerHTML = ''; // åˆæœŸåŒ–
                for (let i = 0; i < COUNTER_MAX_PLATES; i++) {
                    // ä¸‹ã‹ã‚‰ç©ã‚€
                    if (i < emptyCount) {
                        container.appendChild(createPlateElement('empty'));
                    } else if (currentGameMode === 'advanced' && i < targetCount) {
                        // ã‚¢ãƒ‰ãƒãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰ã‹ã¤ã€åˆæœŸæšæ•°ã‚ˆã‚Šä¸Šã§ç›®æ¨™æšæ•°ä»¥ä¸‹ãªã‚‰ quota
                        container.appendChild(createPlateElement('quota'));
                    } else {
                        container.appendChild(createPlateElement('invisible'));
                    }
                }
            }

            /**
             * é¸æŠè‚¢ã®çš¿ã®å±±ã‚’ä½œæˆã™ã‚‹ (ãƒãƒ¼ãƒãƒ«ãƒ¢ãƒ¼ãƒ‰å°‚ç”¨)
             */
            function createOptionStack(container, emptyCount) {
                container.innerHTML = ''; // åˆæœŸåŒ–
                for (let i = 0; i < COUNTER_MAX_PLATES; i++) {
                    const type = (i < emptyCount) ? 'empty' : 'invisible';
                    container.appendChild(createPlateElement(type));
                }
            }
            
            /**
             * æ­£è§£ã‚’è¨ˆç®—ã™ã‚‹ (ãƒãƒ¼ãƒãƒ«/ã‚¢ãƒ‰ãƒãƒ³ã‚¹å…±é€š)
             * @param {object} quiz - quizDataã®è¦ç´ 
             * @param {object} [tempParams] - ã‚¢ãƒ‰ãƒãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰ã§é¸æŠã—ãŸä¸€æ™‚çš„ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
             * @returns {number} - ãƒãƒ¼ãƒãƒ«ãƒ¢ãƒ¼ãƒ‰: æ­£è§£ã®æšæ•°, ã‚¢ãƒ‰ãƒãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰: æ­£è§£ã®é¸æŠè‚¢ã®å€¤
             */
            function calculateCorrectAnswer(quiz, tempParams = {}) {
                
                // ã‚¢ãƒ‰ãƒãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€'?' ã®å€¤ã‚’ä¸€æ™‚çš„ã«è¨­å®šã—ã¦è¨ˆç®—ã™ã‚‹
                const char1 = { ...quiz.char1 };
                const char2 = { ...quiz.char2 };
                
                if (tempParams.key) {
                    const path = tempParams.key.split('.');
                    if (path[0] === 'char1') char1[path[1]] = tempParams.value;
                    if (path[0] === 'char2') char2[path[1]] = tempParams.value;
                }

                let platesLeft = quiz.centerPlates;
                let time = 0; // çµŒéç§’æ•°
                let char1Eaten = 0;
                let char2Eaten = 0;
                const delay1 = char1.delay;
                const delay2 = char2.delay;

                // delayãŒ'?'ã®ã¾ã¾è¨ˆç®—ã—ãªã„ã‚ˆã†ã«ã™ã‚‹
                if (typeof delay1 !== 'number' || typeof delay2 !== 'number') {
                    // ã‚¢ãƒ‰ãƒãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰ã®åˆæœŸåŒ–æ™‚ãªã©
                    finalCounts = { char1: quiz.initialPlates.char1, char2: quiz.initialPlates.char2 };
                    return (currentGameMode === 'normal') ? finalCounts.char2 : quiz.correctOptionValue;
                }

                const minDelay = Math.min(delay1, delay2);
                const maxDelay = Math.max(delay1, delay2);
                
                // 1. minDelayç§’ã‹ã‚‰maxDelayç§’ã¾ã§ (ç‰‡æ–¹ã ã‘é£Ÿã¹ã‚‹)
                time = minDelay;
                while (time < maxDelay && platesLeft > 0) {
                    let speed = 0;
                    if (delay1 === minDelay) {
                        speed = char1.speed;
                        if (platesLeft < speed) { char1Eaten += platesLeft; platesLeft = 0; }
                        else { platesLeft -= speed; char1Eaten += speed; }
                    } else {
                        speed = char2.speed;
                        if (platesLeft < speed) { char2Eaten += platesLeft; platesLeft = 0; }
                        else { platesLeft -= speed; char2Eaten += speed; }
                    }
                    time++;
                }
                
                // 2. maxDelayç§’ä»¥é™ (ä¸¡æ–¹é£Ÿã¹ã‚‹)
                if (platesLeft > 0) {
                    const totalSpeed = char1.speed + char2.speed;
                    if (totalSpeed > 0) {
                        while (platesLeft > 0) {
                            if (platesLeft < totalSpeed) {
                                char1Eaten += char1.speed * (platesLeft / totalSpeed);
                                char2Eaten += char2.speed * (platesLeft / totalSpeed);
                                platesLeft = 0;
                            } else {
                                platesLeft -= totalSpeed;
                                char1Eaten += char1.speed;
                                char2Eaten += char2.speed;
                            }
                        }
                    }
                }
                
                const finalChar1 = Math.round(char1Eaten) + quiz.initialPlates.char1;
                const finalChar2 = Math.round(char2Eaten) + quiz.initialPlates.char2;
                
                // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ã‚‚ä¿å­˜
                finalCounts = { char1: finalChar1, char2: finalChar2 };
                
                if (currentGameMode === 'normal') {
                    return finalChar2; // ãƒãƒ¼ãƒãƒ«: ã‚­ãƒ£ãƒ©2ã®æœ€çµ‚æšæ•°
                } else {
                    return quiz.correctOptionValue; // ã‚¢ãƒ‰ãƒãƒ³ã‚¹: æ­£è§£ã®é¸æŠè‚¢ã®å€¤
                }
            }

            /**
             * ã‚²ãƒ¼ãƒ ã®åˆæœŸåŒ– (å•é¡Œé¸æŠæ™‚ã«ã‚‚ä½¿ç”¨)
             */
            function initializeGame() {
                gameInProgress = false;
                animationStep = 0;
                if (animationInterval) {
                    clearInterval(animationInterval);
                    animationInterval = null;
                }

                const quiz = quizData[currentQuizId];
                
                // ã‚¢ãƒ‰ãƒãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰ç”¨ã®æ­£è§£è¨ˆç®—
                if (currentGameMode === 'advanced') {
                    // æ­£è§£ã®å€¤ã‚’ä½¿ã£ã¦ä¸€åº¦è¨ˆç®—ã—ã€finalCountsã‚’åˆæœŸåŒ–
                    calculateCorrectAnswer(quiz, { key: quiz.questionMark, value: quiz.correctOptionValue });
                    quiz.correctAnswer = quiz.correctOptionValue;
                } else {
                    // ãƒãƒ¼ãƒãƒ«ãƒ¢ãƒ¼ãƒ‰ç”¨ã®æ­£è§£è¨ˆç®—
                    quiz.correctAnswer = calculateCorrectAnswer(quiz);
                }
                
                // å¹ãå‡ºã—æ›´æ–°
                updateSpeechBubble('char1', quiz.char1);
                updateSpeechBubble('char2', quiz.char2);


                // ä¸­å¤®ã®çš¿
                let centerPlatesToDistribute = quiz.centerPlates;
                centerStacks.forEach(stack => {
                    const platesForThisStack = Math.min(CENTER_MAX_PLATES, centerPlatesToDistribute);
                    createCenterStack(stack, platesForThisStack);
                    centerPlatesToDistribute -= platesForThisStack;
                });
                
                // ã‚­ãƒ£ãƒ©1ã®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
                let char1PlatesToDistribute = quiz.initialPlates.char1;
                const target1 = (currentGameMode === 'advanced') ? quiz.targetPlates.char1 : 0;
                char1Stacks.forEach(stack => {
                    const platesForThisStack = Math.min(COUNTER_MAX_PLATES, char1PlatesToDistribute);
                    const targetForThisStack = Math.max(0, Math.min(COUNTER_MAX_PLATES, target1) - (stack.stackIndex * COUNTER_MAX_PLATES)); // è¤‡é›‘...
                    // ç°¡ç•¥åŒ–: targetCountã‚’ã‚¹ã‚¿ãƒƒã‚¯ã«æŒ¯ã‚Šåˆ†ã‘ã‚‹
                    let targetCount1 = target1;
                    char1Stacks.forEach(stack => {
                        const empty = Math.min(COUNTER_MAX_PLATES, quiz.initialPlates.char1 - (stack.stackIndex * COUNTER_MAX_PLATES));
                        const target = Math.min(COUNTER_MAX_PLATES, targetCount1 - (stack.stackIndex * COUNTER_MAX_PLATES));
                         createCounterStack(stack, empty, target);
                    });
                });
                
                // ã‚­ãƒ£ãƒ©2ã®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
                let targetCount2 = (currentGameMode === 'advanced') ? quiz.targetPlates.char2 : 0;
                char2Stacks.forEach((stack, index) => {
                    const empty = Math.max(0, quiz.initialPlates.char2 - (index * COUNTER_MAX_PLATES));
                    const target = Math.max(0, targetCount2 - (index * COUNTER_MAX_PLATES));
                    createCounterStack(stack, empty, target);
                });


                // é¸æŠè‚¢ã®è¡¨ç¤ºã‚’ãƒ¢ãƒ¼ãƒ‰ã«ã‚ˆã£ã¦åˆ‡ã‚Šæ›¿ãˆ
                optionButtons.forEach((btn, index) => {
                    const value = quiz.options[index];
                    btn.dataset.value = value;
                    
                    const normalContent = btn.querySelector('.normal-option-content');
                    const advancedContent = btn.querySelector('.advanced-option-content');

                    if (currentGameMode === 'normal') {
                        normalContent.classList.remove('hidden');
                        advancedContent.classList.add('hidden');
                        
                        let optionPlatesToDistribute = value;
                        optionStackElements[index].forEach((stack, stackIndex) => {
                            const platesForThisStack = Math.max(0, optionPlatesToDistribute - (stackIndex * COUNTER_MAX_PLATES));
                            createOptionStack(stack, Math.min(COUNTER_MAX_PLATES, platesForThisStack));
                        });
                        btn.querySelector('.option-label').textContent = `${value}æš`;
                    
                    } else { // Advanced Mode
                        normalContent.classList.add('hidden');
                        advancedContent.classList.remove('hidden');
                        advancedContent.textContent = value;
                    }
                });

                // ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹åŒ–
                optionButtons.forEach(btn => btn.disabled = false);
                resultModal.classList.add('hidden');
                char1.classList.remove('vibrate');
                char2.classList.remove('vibrate');
            }

            /**
             * å¹ãå‡ºã—ã®å†…å®¹ã‚’æ›´æ–° (ã‚¢ãƒ‰ãƒãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ)
             */
            function updateSpeechBubble(charId, charData) {
                const delayEl = (charId === 'char1') ? char1BubbleDelay : char2BubbleDelay;
                const speedEl = (charId === 'char1') ? char1BubbleSpeed : char2BubbleSpeed;
                
                // Delay
                if (charData.speechDelayText) {
                    if (charData.delay === '?') {
                        delayEl.innerHTML = `<span class="question-mark">â³ ï¼Ÿã³ã‚‡ã†</span>`;
                    } else {
                        delayEl.textContent = charData.speechDelayText;
                    }
                    delayEl.classList.remove('hidden');
                } else {
                    delayEl.classList.add('hidden');
                }

                // Speed
                if (charData.speechSpeedText) {
                     if (charData.speed === '?') {
                        speedEl.innerHTML = `<span class="question-mark">ğŸ½ï¸ ï¼Ÿãšã¤!</span>`;
                    } else {
                        speedEl.textContent = charData.speechSpeedText;
                    }
                    speedEl.classList.remove('hidden');
                } else {
                    speedEl.classList.add('hidden');
                }
            }
            
            /**
             * ã‚¹ã‚¿ãƒƒã‚¯ã‚’å‹•çš„ã«ç”Ÿæˆã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
             */
            function createDynamicStacks(container, count, idPrefix, cssClass) {
                container.innerHTML = '';
                const stacks = [];
                for (let i = 0; i < count; i++) {
                    const stack = document.createElement('div');
                    stack.id = `${idPrefix}${i+1}`;
                    stack.className = cssClass;
                    stack.stackIndex = i; // ã‚¹ã‚¿ãƒƒã‚¯ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä¿å­˜
                    container.appendChild(stack);
                    stacks.push(stack);
                }
                return stacks;
            }

            /**
             * ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®1ã‚¹ãƒ†ãƒƒãƒ—ã‚’å®Ÿè¡Œ
             */
            function runAnimationStep() {
                if (gameInProgress === false) return;
                
                animationStep++; // 1, 2, 3... (ã‚¹ãƒ†ãƒƒãƒ—ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼)
                
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã«ã€é¸æŠã•ã‚ŒãŸå€¤ã§ä¸Šæ›¸ãã•ã‚ŒãŸä¸€æ™‚çš„ãªã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã†
                const quiz = window.tempQuizData;
                const char1 = quiz.char1;
                const char2 = quiz.char2;
                
                // é…å»¶ï¼ˆç ‚æ™‚è¨ˆï¼‰ã®æ›´æ–° (ã‚¹ãƒ†ãƒƒãƒ—ãƒ™ãƒ¼ã‚¹)
                if (char1.delay > 0) {
                    const remainingDelaySteps = Math.max(0, char1.delay - animationStep); // æ®‹ã‚Šå¾…æ©Ÿã‚¹ãƒ†ãƒƒãƒ—
                    if (animationStep <= char1.delay) { // å¾…æ©Ÿä¸­
                        char1BubbleDelay.textContent = `â³ ${remainingDelaySteps}ã³ã‚‡ã†`;
                        char1BubbleDelay.classList.remove('hidden');
                    } else { // å¾…æ©Ÿçµ‚äº†
                        char1BubbleDelay.classList.add('hidden');
                    }
                }
                if (char2.delay > 0) {
                    const remainingDelaySteps = Math.max(0, char2.delay - animationStep); // æ®‹ã‚Šå¾…æ©Ÿã‚¹ãƒ†ãƒƒãƒ—
                    if (animationStep <= char2.delay) { // å¾…æ©Ÿä¸­
                        char2BubbleDelay.textContent = `â³ ${remainingDelaySteps}ã³ã‚‡ã†`;
                        char2BubbleDelay.classList.remove('hidden');
                    } else { // D å¾…æ©Ÿçµ‚äº†
                        char2BubbleDelay.classList.add('hidden');
                    }
                }

                // çµŒéã€Œã‚¹ãƒ†ãƒƒãƒ—ã€ã«åŸºã¥ã„ã¦ã€å„ã‚­ãƒ£ãƒ©ãŒã€Œä»Šã€é£Ÿã¹ãŸæšæ•°ã‚’è¨ˆç®—
                let char1TotalEaten = 0;
                if (animationStep > char1.delay) { 
                    char1TotalEaten = char1.speed * (animationStep - char1.delay); 
                }
                
                let char2TotalEaten = 0;
                if (animationStep > char2.delay) { 
                    char2TotalEaten = char2.speed * (animationStep - char2.delay);
                }

                const totalEaten = char1TotalEaten + char2TotalEaten;
                const platesToEat = Math.floor(totalEaten); // é£Ÿã¹ã‚‹ã¹ãåˆè¨ˆæšæ•°

                // 1. ä¸­å¤®ã®çš¿ã‚’æ¸›ã‚‰ã™
                const allCenterPlates = centerStacks.flatMap(stack => Array.from(stack.children)).filter(el => !el.classList.contains('plate-spacer'));
                for (let i = 0; i < platesToEat && i < allCenterPlates.length; i++) {
                    allCenterPlates[allCenterPlates.length - 1 - i].classList.add('eaten');
                }

                // 2. ã‚­ãƒ£ãƒ©1ã®çš¿ã‚’æ›´æ–° (ã‚¢ãƒ‰ãƒãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ)
                const char1PlatesToShow = quiz.initialPlates.char1 + Math.floor(char1TotalEaten);
                const allChar1Plates = char1Stacks.flatMap(stack => Array.from(stack.children));
                updateCounterPlates(allChar1Plates, char1PlatesToShow);

                // 3. ã‚­ãƒ£ãƒ©2ã®çš¿ã‚’æ›´æ–° (ã‚¢ãƒ‰ãƒãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ)
                const char2PlatesToShow = quiz.initialPlates.char2 + Math.floor(char2TotalEaten);
                const allChar2Plates = char2Stacks.flatMap(stack => Array.from(stack.children));
                updateCounterPlates(allChar2Plates, char2PlatesToShow);
                
                // 4. åœæ­¢åˆ¤å®š
                if (platesToEat >= quiz.centerPlates) {
                    stopAnimation();
                }
            }

            /**
             * ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã®çš¿ã®ç”»åƒï¼ˆempty/quota/invisibleï¼‰ã‚’æ›´æ–°ã™ã‚‹
             */
            function updateCounterPlates(plateElements, platesToShow) {
                 for (let i = 0; i < plateElements.length; i++) {
                    const plate = plateElements[i];
                    if (i < platesToShow) {
                        // é£Ÿã¹ãŸçš¿ã¯ empty.png
                        if (!plate.src.endsWith('plate_empty.png')) {
                            plate.src = 'plate_empty.png';
                        }
                    } else {
                        // ã¾ã é£Ÿã¹ã¦ãªã„çš¿
                        // quota (ç›®æ¨™) ãŒè¨­å®šã•ã‚Œã¦ã„ã‚Œã° quota.png
                        if (currentGameMode === 'advanced' && plate.src.endsWith('plate_quota.png')) {
                            // ãã®ã¾ã¾
                        } else {
                            // ãã‚Œä»¥å¤–ã¯ invisible.png
                            if (!plate.src.endsWith('plate_invisible.png')) {
                                plate.src = 'plate_invisible.png';
                            }
                        }
                    }
                }
            }


            /**
             * ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹
             */
            function startAnimation(selectedValue) {
                gameInProgress = true;
                animationStep = 0; // ã‚¹ãƒ†ãƒƒãƒ—ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
                optionButtons.forEach(btn => btn.disabled = true);

                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã«ã€é¸æŠã•ã‚ŒãŸå€¤ã§ä¸Šæ›¸ãã•ã‚ŒãŸä¸€æ™‚çš„ãªã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã†
                const quiz = JSON.parse(JSON.stringify(quizData[currentQuizId])); // Deep copy
                
                if (currentGameMode === 'advanced') {
                    const path = quiz.questionMark.split('.');
                    quiz[path[0]][path[1]] = selectedValue;
                    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œå‰ã«ã€ã“ã®é¸æŠè‚¢ã§ã®æœ€çµ‚çµæœã‚’è¨ˆç®—ã—ã¦ãŠã
                    calculateCorrectAnswer(quiz, { key: quiz.questionMark, value: selectedValue });
                } else {
                    // ãƒãƒ¼ãƒãƒ«ãƒ¢ãƒ¼ãƒ‰ã§ã‚‚ finalCounts ã‚’æ›´æ–°
                    calculateCorrectAnswer(quiz);
                }
                window.tempQuizData = quiz;


                // é…å»¶ãŒã‚ã‚‹ã‚­ãƒ£ãƒ©ã¯ã€é…å»¶ãŒçµ‚ã‚ã‚‹ã¾ã§æŒ¯å‹•ã•ã›ãªã„
                if (quiz.char1.delay === 0) {
                    char1.classList.add('vibrate');
                } else {
                    setTimeout(() => {
                        if (gameInProgress) char1.classList.add('vibrate');
                    }, quiz.char1.delay * ANIMATION_INTERVAL_MS);
                }
                if (quiz.char2.delay === 0) {
                    char2.classList.add('vibrate');
                } else {
                     setTimeout(() => {
                        if (gameInProgress) char2.classList.add('vibrate');
                    }, quiz.char2.delay * ANIMATION_INTERVAL_MS);
                }

                animationInterval = setInterval(runAnimationStep, ANIMATION_INTERVAL_MS);

                // åœæ­¢ã‚¿ã‚¤ãƒãƒ¼ (ä½™è£•ã‚’æŒã£ã¦30ç§’)
                setTimeout(() => {
                    if (gameInProgress) { // ã¾ã å‹•ã„ã¦ã„ãŸã‚‰å¼·åˆ¶åœæ­¢
                        stopAnimation(selectedValue);
                    }
                }, 30000);
            }

            /**
             * ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åœæ­¢ã—ã€çµæœã‚’åˆ¤å®š
             */
            function stopAnimation(selectedValue) {
                if (animationInterval) {
                    clearInterval(animationInterval);
                    animationInterval = null;
                }
                gameInProgress = false;

                // æŒ¯å‹•åœæ­¢
                char1.classList.remove('vibrate');
                char2.classList.remove('vibrate');

                // æœ€çµ‚çµæœã‚’å¼·åˆ¶çš„ã«åæ˜  (finalCounts ã¯ animationStartæ™‚ã«è¨ˆç®—æ¸ˆã¿)
                updatePlatesToFinalState();

                const finalSelectedValue = selectedValue || window.lastSelectedValue;

                // 0.5ç§’å¾…ã£ã¦ã‹ã‚‰çµæœã‚’è¡¨ç¤º
                setTimeout(() => {
                    checkAnswer(finalSelectedValue);
                }, 500);
            }
            
            /**
             * çš¿ã®çŠ¶æ…‹ã‚’æœ€çµ‚çµæœã«å¼·åˆ¶çš„ã«è¨­å®šã™ã‚‹
             */
            function updatePlatesToFinalState() {
                // finalCounts ã¯ animationStart ã¾ãŸã¯ calculateCorrectAnswer ã§è¨ˆç®—æ¸ˆã¿
                
                // 1. ä¸­å¤®ã®çš¿ (ã™ã¹ã¦ 'eaten')
                const allCenterPlates = centerStacks.flatMap(stack => Array.from(stack.children)).filter(el => !el.classList.contains('plate-spacer'));
                allCenterPlates.forEach(plate => plate.classList.add('eaten'));
                
                // 2. ã‚­ãƒ£ãƒ©1 (æœ€çµ‚æšæ•°)
                const allChar1Plates = char1Stacks.flatMap(stack => Array.from(stack.children));
                updateCounterPlates(allChar1Plates, finalCounts.char1);

                // 3. ã‚­ãƒ£ãƒ©2 (æœ€çµ‚æšæ•°)
                const allChar2Plates = char2Stacks.flatMap(stack => Array.from(stack.children));
                updateCounterPlates(allChar2Plates, finalCounts.char2);
            }

            /**
             * æ­£èª¤åˆ¤å®šã¨çµæœè¡¨ç¤º
             */
            function checkAnswer(selectedValue) {
                const quiz = quizData[currentQuizId];
                const correctAnswer = quiz.correctAnswer;
                
                if (parseInt(selectedValue, 10) === correctAnswer) {
                    resultTitle.textContent = 'æ­£è§£ï¼';
                    resultTitle.className = 'text-4xl font-bold mb-4 text-red-500';
                    
                    if (currentGameMode === 'normal') {
                        resultMessage.textContent = `çŒ«ï¼ˆã‚­ãƒ£ãƒ©2ï¼‰ãŒé£Ÿã¹ãŸãŠçš¿ã¯ ${correctAnswer} æšã§ã—ãŸï¼`;
                    } else {
                        resultMessage.textContent = `ã€Œï¼Ÿã€ã«å…¥ã‚‹æ•°å€¤ã¯ ${correctAnswer} ã§ã—ãŸï¼`;
                    }

                } else {
                    resultTitle.textContent = 'æ®‹å¿µï¼';
                    resultTitle.className = 'text-4xl font-bold mb-4 text-blue-500';
                    resultMessage.textContent = `æ­£è§£ã¯ ${correctAnswer} ã§ã—ãŸã€‚`;
                }
                resultModal.classList.remove('hidden');
            }

            /**
             * é¸æŠè‚¢ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†
             */
            function handleOptionClick(event) {
                if (gameInProgress) return;

                const selectedValue = parseInt(event.currentTarget.dataset.value, 10);
                window.lastSelectedValue = selectedValue; // åœæ­¢æ™‚ã«å‚ç…§ã™ã‚‹ãŸã‚

                // é¸æŠã—ãŸãƒœã‚¿ãƒ³ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                optionButtons.forEach(btn => btn.classList.remove('ring-4', 'ring-yellow-400'));
                event.currentTarget.classList.add('ring-4', 'ring-yellow-400');

                startAnimation(selectedValue);
            }
            
            /**
             * å•é¡Œé¸æŠå‡¦ç†
             */
            function selectQuiz(quizId) {
                currentQuizId = quizId;
                const quiz = quizData[currentQuizId];
                
                // CSSå¤‰æ•°ã‚’æ›´æ–°
                CENTER_MAX_PLATES = quiz.centerMaxPlates;
                COUNTER_MAX_PLATES = quiz.counterMaxPlates;
                document.documentElement.style.setProperty('--center-max-plates', CENTER_MAX_PLATES);
                document.documentElement.style.setProperty('--counter-max-plates', COUNTER_MAX_PLATES);

                // ã‚¹ã‚¿ãƒƒã‚¯ã‚’å‹•çš„ã«ç”Ÿæˆ
                centerStacks = createDynamicStacks(centerStacksContainer, quiz.centerStacks, 'center-stack-', 'plate-center-wrapper center-stack-wrapper');
                char1Stacks = createDynamicStacks(char1StacksContainer, quiz.counterStacks, 'char1-stack-', 'char-plate-counter-wrapper counter-stack-wrapper');
                char2Stacks = createDynamicStacks(char2StacksContainer, quiz.counterStacks, 'char2-stack-', 'char-plate-counter-wrapper counter-stack-wrapper');
                
                optionStackElements = [];
                optionContainers.forEach((optContainer, index) => {
                    optionStackElements.push(
                        createDynamicStacks(optContainer, quiz.counterStacks, `option-${index+1}-stack-`, 'option-stack')
                    );
                });
                
                initializeGame();
                
                // ãƒœã‚¿ãƒ³ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                document.querySelectorAll('.quiz-select-btn').forEach(btn => {
                    btn.classList.remove('bg-blue-700', 'ring-2', 'ring-blue-300');
                    btn.classList.add('bg-blue-500');
                });
                const selectedBtn = document.querySelector(`.quiz-select-btn[data-id="${quizId}"]`);
                selectedBtn.classList.remove('bg-blue-500');
                selectedBtn.classList.add('bg-blue-700', 'ring-2', 'ring-blue-300');
            }
            
            /**
             * ãƒ¢ãƒ¼ãƒ‰é¸æŠå¾Œã®åˆæœŸåŒ–å‡¦ç†
             */
            function loadModeAndStart(mode) {
                currentGameMode = mode;
                quizData = (mode === 'normal') ? normalQuizData : advancedQuizData;

                // ã‚²ãƒ¼ãƒ ç”»é¢ã‚’è¡¨ç¤º
                modeSelectModal.classList.add('hidden');
                gameWrapper.classList.remove('hidden');

                // å•é¡Œé¸æŠUIã®ç”Ÿæˆ
                quizSelectContainer.innerHTML = ''; // ã‚¯ãƒªã‚¢
                quizData.forEach(quiz => {
                    const button = document.createElement('button');
                    button.className = 'quiz-select-btn bg-blue-500 text-white font-bold py-2 px-4 rounded transition hover:bg-blue-600 focus:outline-none';
                    button.textContent = quiz.title;
                    button.dataset.id = quiz.id;
                    button.addEventListener('click', () => selectQuiz(quiz.id));
                    quizSelectContainer.appendChild(button);
                });
                
                // æœ€åˆã®å•é¡Œã‚’é¸æŠ
                selectQuiz(0);
            }


            // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
            optionButtons.forEach(button => {
                button.addEventListener('click', handleOptionClick);
            });

            resetButton.addEventListener('click', initializeGame);
            
            selectNormalModeBtn.addEventListener('click', () => loadModeAndStart('normal'));
            selectAdvancedModeBtn.addEventListener('click', () => loadModeAndStart('advanced'));

            // --- åˆæœŸåŒ–å®Ÿè¡Œ ---
            // (ãƒ¢ãƒ¼ãƒ‰é¸æŠå¾…ã¡)
        });
    </script>
</body>
</html>

