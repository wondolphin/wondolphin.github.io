<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>図形問題ゲーム</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 共通スタイル */
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
        }

        /* 問題モードタブボタン (パラメータ選択ボタン流用) */
        .tab-btn {
            padding-left: 1.5rem;
            padding-right: 1.5rem;
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            font-size: 1.125rem;
            line-height: 1.75rem;
            font-weight: 600;
            color: #374151;
            /* text-gray-700 */
            background-color: #ffffff;
            /* bg-white */
            border-width: 2px;
            border-color: #d1d5db;
            /* border-gray-300 */
            border-radius: 0.5rem;
            /* rounded-lg */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            /* shadow-sm */
            margin: 0.5rem;
            /* m-2 */
            cursor: pointer;
            transition-property: all;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 150ms;
        }

        .tab-btn:hover {
            background-color: #f9fafb;
            /* hover:bg-gray-50 */
            border-color: #60a5fa;
            /* hover:border-blue-400 */
        }

        .tab-btn.active {
            background-color: #3b82f6;
            color: #ffffff;
            border-color: #2563eb;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }

        /* カスタムセレクトボックス (ドロップダウン) */
        select#problemDropdown {
            /* @apply text-lg font-semibold py-2 px-4 border-2 border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500; */
            font-size: 1.0rem;
            line-height: 1.5rem;
            font-weight: 600;
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            padding-left: 0.75rem;
            padding-right: 2.0rem;
            /* 矢印の分 */
            border-width: 2px;
            border-color: #d1d5db;
            border-radius: 0.5rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.25em 1.25em;
            cursor: pointer;
            width: 100%;
            color: #374151;
        }

        select#problemDropdown:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            --tw-ring-color: #3b82f6;
            border-color: #3b82f6;
        }

        /* リロードボタン */
        .reload-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 42px;
            height: 42px;
            border-radius: 0.5rem;
            border: 2px solid #d1d5db;
            background-color: white;
            color: #4b5563;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .reload-btn:hover {
            background-color: #f3f4f6;
            border-color: #9ca3af;
            color: #1f2937;
        }

        .reload-btn:active {
            transform: scale(0.95);
        }
    </style>
</head>

<body class="font-sans bg-gray-100 h-screen w-screen overflow-hidden">

    <!-- 問題モード画面 -->
    <div id="problemModeScreen" class="h-screen flex flex-col overflow-hidden">

        <!-- 1. 上部エリア (高さ 75%) -->
        <div class="h-3/4 flex flex-row overflow-hidden">

            <!-- 1.1 左側: 問題選択 -->
            <div
                class="w-72 flex-shrink-0 bg-white shadow-xl p-6 m-4 mb-0 rounded-lg border border-gray-200 flex flex-col space-y-4">
                <h2 class="text-xl font-bold text-gray-800">問題モード</h2>

                <!-- 問題選択行 (ドロップダウン + リロードボタン) -->
                <div class="flex items-center space-x-2 w-full">
                    <div class="flex-grow relative">
                        <select id="problemDropdown" class="">
                            <!-- JSで動的に問題が挿入されます -->
                        </select>
                    </div>
                    <button id="reloadBtn" class="reload-btn" title="この問題をリロード">
                        <!-- SVG Refresh Icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                            stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
                        </svg>
                    </button>
                </div>

                <!-- 次の問題へボタン -->
                <button id="nextProblemBtn"
                    class="w-full px-4 py-2 bg-blue-100 text-blue-700 font-semibold rounded-lg border border-blue-200 hover:bg-blue-200 hover:border-blue-300 transition-colors disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-blue-100">
                    つぎの もんだいへ →
                </button>

            </div>

            <!-- 1.2 右側: キャンバスエリア -->
            <div class="flex-1 grid grid-cols-1 lg:grid-cols-2 gap-4 p-4 pb-0 bg-gray-200 overflow-y-auto">
                <!-- あなたの回答 -->
                <div
                    class="flex flex-col items-center justify-center p-4 bg-white rounded-lg shadow-inner border border-gray-300 h-full">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">あなたの回答</h3>
                    <div id="userCanvasContainer" class="w-full flex-1 flex items-center justify-center min-h-0">
                        <canvas id="userCanvas"></canvas>
                    </div>
                </div>
                <!-- 見本 -->
                <div
                    class="flex flex-col items-center justify-center p-4 bg-white rounded-lg shadow-inner border border-gray-300 h-full">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">見本</h3>
                    <div id="answerCanvasContainer" class="w-full flex-1 flex items-center justify-center min-h-0">
                        <canvas id="answerCanvas"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. 下部エリア: パラメータ設定 (高さ 25%) -->
        <div
            class="h-1/4 flex-shrink-0 bg-white shadow-xl p-6 m-4 rounded-lg border border-gray-200 flex flex-row items-start gap-6 overflow-y-hidden">
            <h2 id="problemTitle" class="text-xl font-bold text-gray-800 hidden">パラメータ設定</h2>

            <!-- 中央寄せ (justify-center) に変更 -->
            <div id="paramSelectionContainer"
                class="flex-1 flex flex-row flex-wrap justify-center gap-x-8 gap-y-4 h-full overflow-y-auto pr-4">
                <!-- JSで生成 -->
            </div>

            <button id="submitAnswerBtn"
                class="w-48 flex-shrink-0 h-full px-6 py-3 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700 transition-all duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed">
                OK
            </button>
        </div>

    </div>

    <!-- クリアメッセージ (モーダル) -->
    <div id="clearMessage" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-12 rounded-lg shadow-2xl transform transition-all scale-100">
            <span class="text-5xl font-bold text-yellow-500 drop-shadow-md">クリア！</span>
        </div>
    </div>

    <!-- 図形定義ファイル -->
    <script src="shape1.js"></script>
    <script src="shape2.js"></script>
    <script src="shape3.js"></script>
    <script src="shape4.js"></script>
    <script src="shape5.js"></script>
    <script src="shape6.js"></script>
    <script src="shape7.js"></script>
    <script src="shape8.js"></script>
    <script src="shape9.js"></script>
    <script src="shape10.js"></script>

    <!-- メインロジック -->
    <script>
        // --- グローバル変数・定数 ---
        window.shapeDefinitions = window.shapeDefinitions || {};
        const shapeDefs = window.shapeDefinitions;

        let currentProblemId = null;
        let currentShapeId = null;
        let userSelections = {};
        let currentUserParams = {};

        // ★ クリア済み問題のIDを保持するSet (リロードで消える)
        const clearedProblems = new Set();

        // ハイライト色
        const HL_L1 = '#ef4444';
        const HL_SIDE = '#22c55e';
        const HL_TRI_ROT = '#a855f7';
        const HL_COPY_ROT = '#f97316';
        const HL_POINT = '#eab308';
        const DEFAULT_STROKE_ICON = '#2563eb';

        // ボタンスタイル
        const paramBtnBase = 'px-4 py-2 border-2 border-transparent rounded-lg text-sm font-medium cursor-pointer transition-all duration-150 shadow-sm';
        const paramBtnSelected = 'bg-green-600 text-white border-green-700 shadow-md font-semibold';
        const paramBtnFixed = 'bg-gray-200 text-gray-600 cursor-not-allowed border-gray-300';
        const paramBtnUnselected = 'bg-green-50 text-green-800 border-green-200 hover:bg-green-100 hover:border-green-300';

        // --- 問題データ構造 ---
        const problemDatabase = [
            // --- Shape1 ---
            {
                id: '5-1',
                title: 'もんだい5',
                shapeId: 'shape5',
                answerParams: { l1: 100, l2: 150, l3: 90, l4: 90 },
                initialParams: { l1: 50, l2: 150, l3: 90, l4: 90 },
                options: [
                    { paramId: 'l1', label: '屋根高さ(L1)', unit: '', values: [50, 100, 150] }
                ]
            },
            {
                id: '5-2',
                title: 'もんだい5',
                shapeId: 'shape5',
                answerParams: { l1: 100, l2: 180, l3: 90, l4: 90 },
                initialParams: { l1: 100, l2: 120, l3: 90, l4: 90 },
                options: [
                    { paramId: 'l1', label: '屋根高さ(L1)', unit: '', fixed: 100 },
                    { paramId: 'l2', label: '屋根幅(L2)', unit: '', values: [120, 150, 180, 240] }
                ]
            },
            {
                id: '6-2',
                title: 'もんだい6',
                shapeId: 'shape6',
                answerParams: { alpha: 180, l1: 90, l2: 50 },
                initialParams: { alpha: 180, l1: 90, l2: 25 },
                options: [
                    { paramId: 'l2', label: '実の半径(L2)', unit: '', values: [25, 50, 75, 100] }
                ]
            },
            {
                id: '1-1',
                title: 'もんだい1',
                shapeId: 'shape1',
                answerParams: { l1: 100, side: 60, rot: 0, copy: 90 },
                initialParams: { l1: 50, side: 60, rot: 0, copy: 90 },
                options: [
                    { paramId: 'l1', label: 'L1長さ', unit: '', values: [50, 100, 150] }
                ]
            },
            {
                id: '1-2',
                title: 'もんだい',
                shapeId: 'shape1',
                answerParams: { l1: 120, side: 60, rot: 0, copy: 30 },
                initialParams: { l1: 120, side: 30, rot: 0, copy: 30 },
                options: [
                    { paramId: 'side', label: '1辺の長さ', unit: '', values: [30, 60, 90] }
                ]
            },
            
            {
                id: '1-5',
                title: 'もんだい',
                shapeId: 'shape1',
                answerParams: { l1: 80, side: 60, rot: 0, copy: 30 },
                initialParams: { l1: 150, side: 60, rot: 0, copy: 30 },
                options: [
                    { paramId: 'l1', label: 'L1長さ', unit: '', values: [80, 120, 150] },
                ]
            },

            {
                id: '5-3',
                title: 'もんだい5',
                shapeId: 'shape5',
                answerParams: { l1: 150, l2: 40, l3: 40, l4: 80 },
                initialParams: { l1: 100, l2: 100, l3: 40, l4: 80 },
                options: [
                    { paramId: 'l1', label: '屋根高さ(L1)', unit: '', values: [100, 150, 200] },
                    { paramId: 'l2', label: '屋根幅(L2)', unit: '', values: [40, 70, 100] }
                ]
            },
            {
                id: '9-1',
                title: 'もんだい9',
                shapeId: 'shape9',
                answerParams: { l1: 180, l2: 50, l3: 140, l4: 50 },
                initialParams: { l1: 80, l2: 40, l3: 80, l4: 30 },
                options: [
                    { paramId: 'l1', label: '上の幅(L1)', unit: '', values: [100, 140, 180] },
                    { paramId: 'l2', label: '上の高さ(L2)', unit: '', fixed: 50 },
                    { paramId: 'l3', label: '下の高さ(L3)', unit: '', values: [100, 140, 180] }
                ]
            },

            {
                id: '2-1',
                title: 'もんだい',
                shapeId: 'shape2',
                answerParams: { x: 100, y: 70, alpha: 30, beta: 45 },
                initialParams: { x: 60, y: 40, alpha: 30, beta: 45 },
                options: [
                    { paramId: 'x', label: 'L1長さ(X)', unit: '', values: [60, 80, 100] },
                    { paramId: 'y', label: 'L2長さ(Y)', unit: '', values: [40, 70, 100] },
                ]
            },
            {
                id: '2-2',
                title: 'もんだい',
                shapeId: 'shape2',
                answerParams: { x: 30, y: 80, alpha: 30, beta: 45 },
                initialParams: { x: 70, y: 40, alpha: 30, beta: 45 },
                options: [
                    { paramId: 'x', label: 'L1長さ(X)', unit: '', values: [30, 50, 70] },
                    { paramId: 'y', label: 'L2長さ(Y)', unit: '', values: [40, 80, 100] },
                ]
            },
            {
                id: '5-4',
                title: 'もんだい5',
                shapeId: 'shape5',
                answerParams: { l1: 40, l2: 80, l3: 150, l4: 30 },
                initialParams: { l1: 40, l2: 50, l3: 30, l4: 30 },
                options: [
                    { paramId: 'l2', label: '屋根幅(L2)', unit: '', values: [60, 80, 100] },
                    { paramId: 'l3', label: '本体高さ(L3)', unit: '', values: [50, 100, 150] },
                    { paramId: 'l4', label: '本体幅(L4)', unit: '', fixed: 30 }
                ]
            },
            {
                id: '9-2',
                title: 'もんだい9',
                shapeId: 'shape9',
                answerParams: { l1: 40, l2: 40, l3: 80, l4: 120 },
                initialParams: { l1: 100, l2: 80, l3: 80, l4: 120 },
                options: [
                    { paramId: 'l1', label: '上の幅(L1)', unit: '', values: [40, 60, 80, 100] },
                    { paramId: 'l2', label: '上の高さ(L2)', unit: '', values: [20, 40, 60] },
                    { paramId: 'l4', label: '下の幅(L4)', unit: '', fixed: 120 }
                ]
            },
            {
                id: '9-3',
                title: 'もんだい9',
                shapeId: 'shape9',
                answerParams: { l1: 160, l2: 40, l3: 100, l4: 100 },
                initialParams: { l1: 100, l2: 100, l3: 50, l4: 50 },
                options: [
                    { paramId: 'l1', label: '上の幅(L1)', unit: '', values: [80, 120, 160] },
                    { paramId: 'l2', label: '上の高さ(L2)', unit: '', values: [40, 80, 120] },
                    { paramId: 'l3', label: '下の高さ(L3)', unit: '', values: [80, 100, 120] },
                    { paramId: 'l4', label: '下の幅(L4)', unit: '', values: [50, 100, 120] }
                ]
            },
            
                        
            // --- Shape6 ---
            {
                id: '6-1',
                title: 'もんだい6',
                shapeId: 'shape6',
                answerParams: { alpha: 45, l1: 160, l2: 40 },
                initialParams: { alpha: 90, l1: 100, l2: 40 },
                options: [
                    { paramId: 'alpha', label: '角度(α)', unit: '°', values: [30, 45, 60, 90] },
                    { paramId: 'l1', label: '茎の長さ(L1)', unit: '', values: [100,160,220] }
                ]
            },
            
            // --- Shape7 ---
            
            // --- Shape9 ---
            
            
            // --- Shape10 ---
            {
                id: '10-1',
                title: 'もんだい10',
                shapeId: 'shape10',
                answerParams: { l1: 180, l2: 90, alpha: 45 },
                initialParams: { l1: 180, l2: 40, alpha: 20 },
                options: [
                    { paramId: 'l1', label: '軸の長さ(L1)', unit: '', fixed: 180 },
                    { paramId: 'l2', label: '矢の長さ(L2)', unit: '', values: [90, 120, 150] },
                    { paramId: 'alpha', label: '矢の角度(α)', unit: '°', values: [20, 45, 60, 90] }
                ]
            },
            {
                id: '10-2',
                title: 'もんだい10',
                shapeId: 'shape10',
                answerParams: { l1: 200, l2: 120, alpha: 30 },
                initialParams: { l1: 50, l2: 120, alpha: 90 },
                options: [
                    { paramId: 'l1', label: '軸の長さ(L1)', unit: '', values: [50, 100, 150, 200] },
                    { paramId: 'l2', label: '矢の長さ(L2)', unit: '', fixed: 120 },
                    { paramId: 'alpha', label: '矢の角度(α)', unit: '°', values: [30, 45, 60, 90] }
                ]
            },

            {
                id: '2-3',
                title: 'もんだい',
                shapeId: 'shape2',
                answerParams: { x: 80, y: 50, alpha: 60, beta: 45 },
                initialParams: { x: 80, y: 50, alpha: 20, beta: 45 },
                options: [
                    { paramId: 'alpha', label: 'L2角度(α)', unit: '°', values: [30, 45, 60, 90] }
                ]
            },
            {
                id: '1-3',
                title: 'もんだい',
                shapeId: 'shape1',
                answerParams: { l1: 100, side: 60, rot: 60, copy: 30 },
                initialParams: { l1: 150, side: 60, rot: 15, copy: 30 },
                options: [
                    { paramId: 'l1', label: 'L1長さ', unit: '', values: [50, 100, 130] },
                    { paramId: 'side', label: '1辺の長さ', unit: '', fixed: 60 },
                    { paramId: 'rot', label: '回転角', unit: '°', values: [0, 30, 60] }

                ]
            },
            {
                id: '1-4',
                title: 'もんだい',
                shapeId: 'shape1',
                answerParams: { l1: 120, side: 100, rot: 90, copy: 30 },
                initialParams: { l1: 120, side: 60, rot: 15, copy: 30 },
                options: [
                    { paramId: 'l1', label: 'L1長さ', unit: '', fixed: 120 },
                    { paramId: 'side', label: '1辺の長さ', unit: '', values: [50, 100, 130] },
                    { paramId: 'rot', label: '回転角', unit: '°', values: [30, 60, 90] }

                ]
            },

            {
                id: 's2p2',
                title: '図形2 - 問題2',
                shapeId: 'shape2',
                answerParams: { x: 90, y: 50, alpha: 60, beta: 20 },
                initialParams: { x: 70, y: 50, alpha: 30, beta: 60 },
                options: [
                    { paramId: 'x', label: 'L1長さ(X)', unit: '', values: [60, 90, 120] },
                    { paramId: 'y', label: 'L2長さ(Y)', unit: '', fixed: 50 },
                    { paramId: 'alpha', label: 'L2角度(α)', unit: '°', values: [45, 60, 90] },
                    { paramId: 'beta', label: 'コピー角度(β)', unit: '°', values: [15, 20, 30] }
                ]
            },
            {
                id: 's2p3',
                title: '図形2 - 問題3',
                shapeId: 'shape2',
                answerParams: { x: 100, y: 70, alpha: 90, beta: 90 },
                initialParams: { x: 70, y: 30, alpha: 90, beta: 45 },
                options: [
                    { paramId: 'x', label: 'L1長さ(X)', unit: '', values: [70, 100] },
                    { paramId: 'y', label: 'L2長さ(Y)', unit: '', values: [30, 50, 70] },
                    { paramId: 'alpha', label: 'L2角度(α)', unit: '°', fixed: 90 },
                    { paramId: 'beta', label: 'コピー角度(β)', unit: '°', values: [45, 90] }
                ]
            },
            // --- Shape3 ---
            {
                id: 's3p1',
                title: '図形3 - 問題1',
                shapeId: 'shape3',
                answerParams: { a: 80, b: 60, c: 30, d: 30 },
                initialParams: { a: 80, b: 50, c: 40, d: 20 },
                options: [
                    { paramId: 'a', label: '底辺(A)', unit: '', fixed: 80 },
                    { paramId: 'b', label: '高さ(B)', unit: '', values: [50, 60, 70] },
                    { paramId: 'c', label: 'ずれ(C)', unit: '', values: [20, 30, 40] },
                    { paramId: 'd', label: '幹幅(D)', unit: '', values: [20, 30, 40] }
                ]
            },
            {
                id: 's3p2',
                title: '図形3 - 問題2',
                shapeId: 'shape3',
                answerParams: { a: 100, b: 50, c: 30, d: 40 },
                initialParams: { a: 120, b: 50, c: 40, d: 40 },
                options: [
                    { paramId: 'a', label: '底辺(A)', unit: '', values: [80, 100, 120] },
                    { paramId: 'b', label: '高さ(B)', unit: '', fixed: 50 },
                    { paramId: 'c', label: 'ずれ(C)', unit: '', values: [30, 40] },
                    { paramId: 'd', label: '幹幅(D)', unit: '', fixed: 40 }
                ]
            },
            // --- Shape4 ---
            {
                id: 's4p1',
                title: '図形4 - 問題1',
                shapeId: 'shape4',
                answerParams: { r: 100, sa: 75, la: 125 },
                initialParams: { r: 80, sa: 75, la: 100 },
                options: [
                    { paramId: 'r', label: '円半径(R)', unit: '', values: [80, 100, 120] },
                    { paramId: 'sa', label: '楕円短半径(SA)', unit: '', fixed: 75 },
                    { paramId: 'la', label: '楕円長半径(LA)', unit: '', values: [100, 125] }
                ]
            },
            {
                id: 's7p1',
                title: '図形7 - 問題1',
                shapeId: 'shape7',
                answerParams: { l1: 100, l2: 50 },
                initialParams: { l1: 80, l2: 50 },
                options: [
                    { paramId: 'l1', label: '正方形の辺(L1)', unit: '', values: [80, 100, 120] },
                    { paramId: 'l2', label: '円の半径(L2)', unit: '', fixed: 50 }
                ]
            },
            {
                id: 's7p2',
                title: '図形7 - 問題2 (70.7)',
                shapeId: 'shape7',
                answerParams: { l1: 100, l2: 70.7 },
                initialParams: { l1: 100, l2: 50 },
                options: [
                    { paramId: 'l1', label: '正方形の辺(L1)', unit: '', fixed: 100 },
                    { paramId: 'l2', label: '円の半径(L2)', unit: '', values: [50, 60, 70.7, 80] }
                ]
            },
            // --- Shape8 ---
            {
                id: 's8p1',
                title: '図形8 - 問題1',
                shapeId: 'shape8',
                answerParams: { l1: 100, l2: 100, alpha: 15 },
                initialParams: { l1: 80, l2: 100, alpha: 10 },
                options: [
                    { paramId: 'l1', label: '柄の長さ(L1)', unit: '', values: [80, 100, 120] },
                    { paramId: 'l2', label: '歯の長さ(L2)', unit: '', fixed: 100 },
                    { paramId: 'alpha', label: '歯の角度(α)', unit: '°', values: [10, 15, 20] }
                ]
            },
            {
                id: 's8p2',
                title: '図形8 - 問題2',
                shapeId: 'shape8',
                answerParams: { l1: 100, l2: 100, alpha: 15 },
                initialParams: { l1: 100, l2: 80, alpha: 25 },
                options: [
                    { paramId: 'l1', label: '柄の長さ(L1)', unit: '', fixed: 100 },
                    { paramId: 'l2', label: '歯の長さ(L2)', unit: '', values: [80, 100] },
                    { paramId: 'alpha', label: '歯の角度(α)', unit: '°', values: [15, 25] }
                ]
            }


        ];


        // --- DOM要素の取得 ---
        const problemDropdown = document.getElementById('problemDropdown');
        const problemTitle = document.getElementById('problemTitle');
        const paramSelectionContainer = document.getElementById('paramSelectionContainer');
        let submitAnswerBtn = document.getElementById('submitAnswerBtn');
        const userCanvas = document.getElementById('userCanvas');
        const userCanvasContainer = document.getElementById('userCanvasContainer');
        const answerCanvas = document.getElementById('answerCanvas');
        const answerCanvasContainer = document.getElementById('answerCanvasContainer');
        const clearMessage = document.getElementById('clearMessage');

        const nextProblemBtn = document.getElementById('nextProblemBtn');
        const reloadBtn = document.getElementById('reloadBtn');

        // --- 汎用リサイズ関数 ---
        function resizeAllCanvases() {
            const userSize = Math.min(userCanvasContainer.clientWidth, userCanvasContainer.clientHeight) - 16;
            userCanvas.width = userSize;
            userCanvas.height = userSize;

            const answerSize = Math.min(answerCanvasContainer.clientWidth, answerCanvasContainer.clientHeight) - 16;
            answerCanvas.width = answerSize;
            answerCanvas.height = answerSize;

            drawProblemMode();
        }


        // --- 問題モード初期化・描画 ---

        // 問題UIを構築
        function setupProblemUI() {
            // (もしあれば)前回の図形のアニメーションループを停止
            if (currentShapeId && shapeDefs[currentShapeId] && shapeDefs[currentShapeId].stopIconAnimations) {
                shapeDefs[currentShapeId].stopIconAnimations();
            }

            const problem = problemDatabase.find(p => p.id === currentProblemId);
            if (!problem) {
                paramSelectionContainer.innerHTML = '<p>問題の読み込みに失敗しました。</p>';
                submitAnswerBtn.disabled = true;
                return;
            }

            currentShapeId = problem.shapeId;
            const shapeDef = shapeDefs[currentShapeId];
            if (!shapeDef) {
                paramSelectionContainer.innerHTML = `<p>図形定義 '${currentShapeId}' が見つかりません。</p>`;
                submitAnswerBtn.disabled = true;
                return;
            }

            problemTitle.textContent = problem.title;
            paramSelectionContainer.innerHTML = '';
            userSelections = {};

            currentUserParams = { ...problem.initialParams };

            const visibleParamIds = new Set();

            problem.options.forEach(opt => {
                visibleParamIds.add(opt.paramId);

                const groupDiv = document.createElement('div');
                groupDiv.className = 'space-y-2 text-center'; // 中央寄せのために text-center 追加

                // ラベル (アイコン) - 中央寄せ
                const label = document.createElement('label');
                label.className = 'flex items-center justify-center space-x-2'; // justify-center 追加
                const canvas = document.createElement('canvas');
                canvas.id = `label_icon_prob_${currentShapeId}_${opt.paramId}`;

                canvas.width = 80;
                canvas.height = 60;

                canvas.className = 'border border-gray-300 rounded';
                canvas.title = opt.label;
                label.appendChild(canvas);
                groupDiv.appendChild(label);

                const btnContainer = document.createElement('div');
                btnContainer.className = 'flex flex-wrap gap-2 justify-center'; // justify-center 追加

                if (opt.fixed !== undefined) {
                    // 固定値
                    const btn = document.createElement('button');
                    btn.className = `${paramBtnBase} ${paramBtnFixed}`;
                    btn.textContent = `${opt.fixed}${opt.unit || ''}`;
                    btnContainer.appendChild(btn);
                    userSelections[opt.paramId] = opt.fixed;
                    currentUserParams[opt.paramId] = opt.fixed;

                } else if (opt.values) {
                    // 選択肢
                    const initialValue = problem.initialParams[opt.paramId];
                    userSelections[opt.paramId] = initialValue;

                    opt.values.forEach(val => {
                        const btn = document.createElement('button');

                        const isSelected = (val === initialValue);
                        btn.className = `${paramBtnBase} ${isSelected ? paramBtnSelected : paramBtnUnselected}`;

                        btn.textContent = `${val}${opt.unit || ''}`;
                        btn.dataset.param = opt.paramId;
                        btn.dataset.value = val;

                        btn.addEventListener('click', () => {
                            userSelections[opt.paramId] = val;
                            btnContainer.querySelectorAll('button').forEach(b => {
                                if (b !== btn) {
                                    if (!b.className.includes(paramBtnFixed)) {
                                        b.className = `${paramBtnBase} ${paramBtnUnselected}`;
                                    }
                                }
                            });
                            btn.className = `${paramBtnBase} ${paramBtnSelected}`;
                            checkAllParamsSelected();
                        });
                        btnContainer.appendChild(btn);
                    });
                }
                groupDiv.appendChild(btnContainer);
                paramSelectionContainer.appendChild(groupDiv);
            });

            shapeDef.params.forEach(paramId => {
                if (!visibleParamIds.has(paramId)) {
                    if (problem.answerParams[paramId] !== undefined) {
                        userSelections[paramId] = problem.answerParams[paramId];
                    }
                }
            });

            checkAllParamsSelected();

            problem.options.forEach(opt => {
                const canvasId = `label_icon_prob_${currentShapeId}_${opt.paramId}`;
                if (shapeDef.drawIconFns[opt.paramId]) {
                    shapeDef.drawIconFns[opt.paramId](canvasId);
                }
            });

            // 「次の問題へ」ボタンの状態更新
            updateNextButtonState();

            resizeAllCanvases();
        }

        // 「次の問題へ」ボタンの状態更新
        function updateNextButtonState() {
            const currentIndex = problemDatabase.findIndex(p => p.id === currentProblemId);
            if (currentIndex === -1 || currentIndex === problemDatabase.length - 1) {
                nextProblemBtn.disabled = true;
                nextProblemBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                nextProblemBtn.disabled = false;
                nextProblemBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        function drawProblemMode() {
            if (!currentProblemId || !currentShapeId) return;
            const problem = problemDatabase.find(p => p.id === currentProblemId);
            const shapeDef = shapeDefs[currentShapeId];
            if (!problem || !shapeDef) {
                const ctxUser = userCanvas.getContext('2d');
                ctxUser.clearRect(0, 0, userCanvas.width, userCanvas.height);
                const ctxAnswer = answerCanvas.getContext('2d');
                ctxAnswer.clearRect(0, 0, answerCanvas.width, answerCanvas.height);
                return;
            }

            const highlights = {};
            problem.options.forEach(opt => {
                highlights[opt.paramId] = true;
            });

            shapeDef.drawFn(userCanvas, currentUserParams, highlights);
            shapeDef.drawFn(answerCanvas, problem.answerParams, {});
        }

        function checkAllParamsSelected() {
            const problem = problemDatabase.find(p => p.id === currentProblemId);
            if (!problem) {
                submitAnswerBtn.disabled = true;
                return;
            }
            const allSelected = problem.options.every(opt => userSelections[opt.paramId] !== undefined);
            submitAnswerBtn.disabled = !allSelected;
        }

        // 回答チェック & クリア処理
        function checkAnswer() {
            const problem = problemDatabase.find(p => p.id === currentProblemId);
            if (!problem) return;

            const isCorrect = Object.keys(problem.answerParams).every(key => {
                const answerVal = problem.answerParams[key];
                const userVal = userSelections[key];

                if (problem.shapeId === 'shape7' && key === 'l2') {
                    return Math.abs(answerVal - userVal) < 0.1;
                }
                return answerVal === userVal;
            });

            if (isCorrect) {
                // クリア情報を記録
                if (!clearedProblems.has(currentProblemId)) {
                    clearedProblems.add(currentProblemId);
                    setupProblemDropdown(); // ドロップダウンの★を更新
                    problemDropdown.value = currentProblemId; // 選択状態を維持
                }

                clearMessage.classList.remove('hidden');
                setTimeout(() => {
                    clearMessage.classList.add('hidden');
                    // 自動で次の問題には行かない (ユーザー操作に任せる)
                }, 1500);
            }
        }

        function lerp(start, end, t) {
            return start * (1 - t) + end * t;
        }

        function animateParameters(targetParams) {
            const shapeDef = shapeDefs[currentShapeId];
            if (!shapeDef) return;

            const startParams = { ...currentUserParams };
            const animationOrder = shapeDef.params;
            const paramBaseDuration = 400;

            submitAnswerBtn.disabled = true;

            let animations = [];
            let cumulativeTime = 0;

            animationOrder.forEach(paramId => {
                const startVal = startParams[paramId];
                const endVal = (targetParams[paramId] !== undefined) ? targetParams[paramId] : startVal;

                const duration = (startVal !== endVal) ? paramBaseDuration : 0;

                animations.push({
                    id: paramId,
                    startVal: startVal,
                    endVal: endVal,
                    startTime: cumulativeTime,
                    endTime: cumulativeTime + duration
                });

                cumulativeTime += duration;
            });

            const totalDuration = cumulativeTime;
            let startTime = null;

            const problem = problemDatabase.find(p => p.id === currentProblemId);
            const highlights = {};
            if (problem) {
                problem.options.forEach(opt => {
                    highlights[opt.paramId] = true;
                });
            }

            function animationLoop(timestamp) {
                if (!startTime) startTime = timestamp;
                const elapsed = timestamp - startTime;

                let frameParams = { ...startParams };

                animations.forEach(anim => {
                    if (elapsed < anim.startTime) {
                        frameParams[anim.id] = anim.startVal;
                    } else if (elapsed >= anim.endTime) {
                        frameParams[anim.id] = anim.endVal;
                    } else {
                        if (anim.endTime === anim.startTime) {
                            frameParams[anim.id] = anim.endVal;
                        } else {
                            const progress = (elapsed - anim.startTime) / (anim.endTime - anim.startTime);
                            frameParams[anim.id] = lerp(anim.startVal, anim.endVal, progress);
                        }
                    }
                });

                shapeDef.drawFn(userCanvas, frameParams, highlights);

                if (elapsed < totalDuration) {
                    requestAnimationFrame(animationLoop);
                } else {
                    const finalParams = { ...currentUserParams, ...targetParams };
                    shapeDef.drawFn(userCanvas, finalParams, highlights);
                    currentUserParams = finalParams;

                    checkAllParamsSelected();
                    setTimeout(checkAnswer, 500);
                }
            }
            requestAnimationFrame(animationLoop);
        }

        // --- 初期化 ---
        document.addEventListener('DOMContentLoaded', () => {

            // ドロップダウン生成
            setupProblemDropdown();

            // イベントリスナー
            problemDropdown.addEventListener('change', (e) => {
                currentProblemId = e.target.value;
                setupProblemUI();
            });

            submitAnswerBtn.addEventListener('click', () => {
                animateParameters(userSelections);
            });

            // 次の問題へ
            nextProblemBtn.addEventListener('click', () => {
                const currentIndex = problemDatabase.findIndex(p => p.id === currentProblemId);
                if (currentIndex !== -1 && currentIndex < problemDatabase.length - 1) {
                    currentProblemId = problemDatabase[currentIndex + 1].id;
                    problemDropdown.value = currentProblemId;
                    setupProblemUI();
                }
            });

            // リロード (リセット)
            reloadBtn.addEventListener('click', () => {
                setupProblemUI(); // 現在のIDで再構築 = リセット
            });

            window.addEventListener('resize', resizeAllCanvases);

            // 初期表示
            if (problemDatabase.length > 0) {
                currentProblemId = problemDatabase[0].id;
                problemDropdown.value = currentProblemId;
                setupProblemUI();
            } else {
                paramSelectionContainer.innerHTML = '<p>問題が登録されていません。</p>';
                submitAnswerBtn.disabled = true;
                nextProblemBtn.disabled = true;
            }
        });

        // ドロップダウン生成 (★表示対応)
        function setupProblemDropdown() {
            problemDropdown.innerHTML = '';

            if (problemDatabase.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = '問題がありません';
                problemDropdown.appendChild(option);
                problemDropdown.disabled = true;
                return;
            }

            problemDatabase.forEach((problem) => {
                const option = document.createElement('option');
                option.value = problem.id;

                // クリア済みなら★を付与
                const star = clearedProblems.has(problem.id) ? '★ ' : '';
                option.textContent = `${star}${problem.title}`;

                problemDropdown.appendChild(option);
            });

            problemDropdown.disabled = false;
        }

    </script>
</body>

</html>