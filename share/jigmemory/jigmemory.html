<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Ç∏„Ç∞„ÇΩ„Éº„Éë„Ç∫„É´Á•ûÁµåË°∞Âº±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-color: #f8fafc;
            --p1-color: #3b82f6;
            --p2-color: #ef4444;
        }

        body {
            background-color: var(--bg-color);
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
            overflow: hidden; /* ‰∏ÄÁîªÈù¢„Å´Âèé„ÇÅ„Çã„Åü„ÇÅ */
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* „Ç´„Éº„Éâ„Éá„Ç∂„Ç§„É≥ */
        .card-container {
            perspective: 1000px;
        }

        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            transform-style: preserve-3d;
            cursor: pointer;
        }

        .card-container.flipped .card-inner {
            transform: rotateY(180deg);
        }

        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
        }

        .card-back {
            background-color: #fff;
            transform: rotateY(180deg);
        }

        .card-coord .card-front {
            background: linear-gradient(135deg, #475569, #1e293b);
            border: 1px solid #0f172a;
        }
        .card-fragment .card-front {
            background: linear-gradient(135deg, #78350f, #451a03);
            border: 1px solid #451a03;
        }

        .card-front::after {
            content: 'Ôºü';
            color: rgba(255,255,255,0.4);
            font-size: 1.2rem;
            font-weight: bold;
        }

        .card-coord .card-back {
            background-color: #fffbeb;
            border: 2px solid #fbbf24;
            font-weight: 800;
            font-size: 1rem;
            color: #1e293b;
        }

        .card-fragment .card-back {
            padding: 0;
            overflow: hidden;
            border: 1px solid #78350f;
        }

        /* È°çÁ∏Å */
        .frame-grid {
            display: grid;
            gap: 1px;
            background-color: #1e293b;
            border: 8px solid #451a03;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            border-radius: 6px;
        }

        .frame-cell {
            background-color: #0f172a;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .frame-cell::before {
            content: attr(data-coord);
            color: #cbd5e1;
            font-size: 1.2rem;
            font-weight: 900;
            position: absolute;
            z-index: 0;
            opacity: 0.8;
        }

        .matched-fragment {
            width: 100%;
            height: 100%;
            z-index: 1;
            background-repeat: no-repeat;
        }

        .pop-in { animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes pop {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .hidden-card { visibility: hidden; opacity: 0; transform: scale(0.8); transition: 0.4s; }

        .active-player {
            transform: scale(1.02);
            box-shadow: 0 4px 12px -2px rgba(0, 0, 0, 0.15);
            z-index: 10;
        }

        .difficulty-control {
            display: flex;
            background: #e2e8f0;
            padding: 3px;
            border-radius: 12px;
            gap: 2px;
        }

        .diff-btn {
            padding: 6px 12px;
            border-radius: 9px;
            font-weight: 800;
            transition: all 0.2s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 100px;
            font-size: 13px;
        }

        .diff-btn-active {
            background-color: #2563eb;
            color: white;
            box-shadow: 0 2px 6px rgba(37, 99, 235, 0.2);
        }

        .diff-btn-inactive {
            background-color: transparent;
            color: #64748b;
        }

        .btn-subtext {
            font-size: 9px;
            font-weight: normal;
            opacity: 0.8;
        }
    </style>
</head>
<body class="p-2 md:p-4">

    <!-- „Éò„ÉÉ„ÉÄ„Éº„Ç®„É™„Ç¢ -->
    <div class="w-full max-w-5xl mx-auto flex flex-col items-center shrink-0">
        <div class="flex items-center justify-center gap-2 mb-2">
            <h1 class="text-xl md:text-2xl font-black text-slate-800 tracking-tighter">„Ç∏„Ç∞„ÇΩ„Éº„Éë„Ç∫„É´Á•ûÁµåË°∞Âº±</h1>
            <button onclick="toggleModal('rule-modal', true)" class="w-6 h-6 rounded-full bg-white text-slate-600 font-black hover:bg-slate-100 transition-colors shadow-sm border border-slate-200 text-xs">Ôºü</button>
        </div>
        
        <div class="difficulty-control mb-4">
            <button onclick="changeDifficulty('beginner')" id="btn-beginner" class="diff-btn diff-btn-active">
                <span>ÂàùÁ¥ö</span>
                <span class="btn-subtext">3√ó3</span>
            </button>
            <button onclick="changeDifficulty('intermediate')" id="btn-intermediate" class="diff-btn diff-btn-inactive">
                <span>‰∏≠Á¥ö</span>
                <span class="btn-subtext">4√ó4</span>
            </button>
            <button onclick="changeDifficulty('advanced')" id="btn-advanced" class="diff-btn diff-btn-inactive">
                <span>‰∏äÁ¥ö</span>
                <span class="btn-subtext">ÂÖ®„Å¶Ëá™Âäõ</span>
            </button>
        </div>

        <div class="flex justify-between items-center bg-white p-2 rounded-2xl shadow-sm border border-slate-200 w-full max-w-2xl gap-2 mb-4">
            <div id="p1-score-box" class="flex flex-col items-center px-4 py-1 rounded-xl border-b-2 border-blue-500 transition-all active-player bg-slate-50 flex-1">
                <span class="text-[9px] font-black text-blue-600 uppercase tracking-widest">P1</span>
                <span id="p1-score" class="text-xl font-black text-blue-900 leading-none">0</span>
            </div>
            
            <div class="flex flex-col items-center gap-1 shrink-0 px-2">
                <div id="turn-display" class="px-4 py-1 rounded-full text-white bg-blue-500 font-bold text-[11px] shadow-sm whitespace-nowrap">
                    P1 „ÅÆÁï™„Åß„Åô
                </div>
                <button onclick="passTurn()" class="px-4 py-0.5 rounded-full border border-slate-200 text-slate-500 text-[10px] font-bold hover:bg-slate-50 transition-all">
                    „Éë„Çπ‚úãÔ∏è
                </button>
            </div>

            <div id="p2-score-box" class="flex flex-col items-center px-4 py-1 rounded-xl border-b-2 border-transparent transition-all bg-slate-50 flex-1">
                <span class="text-[9px] font-black text-red-600 uppercase tracking-widest">P2</span>
                <span id="p2-score" class="text-xl font-black text-red-900 leading-none">0</span>
            </div>
        </div>
    </div>

    <!-- „Ç≤„Éº„É†„Ç®„É™„Ç¢ -->
    <div class="flex flex-row gap-4 items-center justify-center flex-1 overflow-hidden w-full max-w-6xl mx-auto">
        
        <!-- Â∫ßÊ®ô„Ç´„Éº„Éâ -->
        <div class="hidden sm:flex flex-col items-center">
            <div id="coord-pool" class="grid gap-1.5 bg-white p-3 rounded-2xl border border-slate-200 shadow-sm">
                <!-- JSÁîüÊàê -->
            </div>
        </div>

        <!-- ‰∏≠Â§ÆÈ°çÁ∏Å -->
        <div class="flex flex-col items-center shrink-0">
            <div id="canvas-frame" class="frame-grid">
                <!-- JSÁîüÊàê -->
            </div>
            <button onclick="resetGame()" class="mt-4 px-6 py-2 bg-slate-800 text-white rounded-xl font-bold hover:bg-black text-[11px] shadow-lg">
                üîÑ „É™„Çª„ÉÉ„Éà
            </button>
        </div>

        <!-- Á†¥Áâá„Ç´„Éº„Éâ -->
        <div class="hidden sm:flex flex-col items-center">
            <div id="fragment-pool" class="grid gap-1.5 bg-white p-3 rounded-2xl border border-slate-200 shadow-sm">
                <!-- JSÁîüÊàê -->
            </div>
        </div>
    </div>

    <!-- „Çπ„Éû„ÉõÁî®/Áã≠„ÅÑÁîªÈù¢Áî®„ÅÆË°®Á§∫Ë£úÂÆåÔºàÊ®™‰∏¶„Å≥„ÅßË°®Á§∫„Åï„Çå„Å™„ÅÑÂ†¥Âêà„Å´ÂÇô„Åà„Å¶Ôºâ -->
    <div class="flex sm:hidden flex-row gap-4 mt-2 justify-center shrink-0">
        <div id="mobile-coord-pool-container" class="bg-white p-2 rounded-xl border border-slate-200">
             <div id="mobile-coord-pool" class="grid gap-1 flex-wrap"></div>
        </div>
        <div id="mobile-fragment-pool-container" class="bg-white p-2 rounded-xl border border-slate-200">
             <div id="mobile-fragment-pool" class="grid gap-1 flex-wrap"></div>
        </div>
    </div>

    <!-- „É¢„Éº„ÉÄ„É´Á≥ª -->
    <div id="rule-modal" class="fixed inset-0 bg-slate-900/80 hidden items-center justify-center z-[100] p-4">
        <div class="bg-white p-8 rounded-3xl max-w-xs w-full shadow-2xl pop-in">
            <h2 class="text-xl font-black text-slate-800 mb-4 text-center">ÈÅä„Å≥„Åã„Åü</h2>
            <div class="space-y-3 text-slate-600 text-xs mb-6">
                <p>1. Â∑¶Âè≥„ÅÆ„Ç´„Éº„Éâ„Çí1Êûö„Åö„Å§„ÇÅ„Åè„Çä„Åæ„Åô„ÄÇ</p>
                <p>2. Ê≠£Ëß£„ÅÆ<b>Â∫ßÊ®ô</b>„Å®<b>Áµµ</b>„ÅÆ„Éö„Ç¢„Å™„ÇâÂæóÁÇπÔºÅ</p>
                <p>3. ÂÖ®„Å¶ÊèÉ„Å£„Åü„ÇâÁµÇ‰∫Ü„ÄÅÂæóÁÇπÂãùË≤†„Åß„Åô„ÄÇ</p>
            </div>
            <button onclick="toggleModal('rule-modal', false)" class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700">OK!</button>
        </div>
    </div>

    <div id="game-over" class="fixed inset-0 bg-slate-900/90 hidden items-center justify-center z-[110] p-4">
        <div class="bg-white p-10 rounded-[2.5rem] text-center max-w-xs w-full shadow-2xl pop-in">
            <div class="text-4xl mb-4">üñºÔ∏è</div>
            <h2 class="text-xl font-black text-slate-900 mb-2">„Éë„Ç∫„É´ÂÆåÊàêÔºÅ</h2>
            <p id="winner-text" class="text-sm font-bold text-blue-600 mb-6"></p>
            <div class="flex justify-around bg-slate-50 p-4 rounded-2xl mb-6 text-xs">
                <div>P1: <span id="final-p1" class="font-black text-blue-600">0</span></div>
                <div class="w-px bg-slate-200"></div>
                <div>P2: <span id="final-p2" class="font-black text-red-600">0</span></div>
            </div>
            <button onclick="resetGame()" class="w-full py-4 bg-blue-600 text-white rounded-2xl font-bold hover:bg-blue-700 shadow-lg">„ÇÇ„ÅÜ‰∏ÄÂ∫¶</button>
        </div>
    </div>

    <script>
        const difficulties = {
            beginner: { size: 3, preFill: 'center', frameCellSize: 85, imageSize: 300, cardSize: 55 },
            intermediate: { size: 4, preFill: 4, frameCellSize: 62, imageSize: 320, cardSize: 45 },
            advanced: { size: 4, preFill: 0, frameCellSize: 62, imageSize: 320, cardSize: 45 }
        };

        let currentDifficulty = 'beginner';
        let state = {
            currentPlayer: 1,
            scores: { 1: 0, 2: 0 },
            flippedCards: [],
            matchedCount: 0,
            isProcessing: false,
            imageUrl: ""
        };

        function getElements() {
            const isMobile = window.innerWidth < 640;
            return {
                coordPool: isMobile ? document.getElementById('mobile-coord-pool') : document.getElementById('coord-pool'),
                fragmentPool: isMobile ? document.getElementById('mobile-fragment-pool') : document.getElementById('fragment-pool'),
                canvasFrame: document.getElementById('canvas-frame'),
                turnDisplay: document.getElementById('turn-display'),
                p1Box: document.getElementById('p1-score-box'),
                p2Box: document.getElementById('p2-score-box')
            };
        }

        function initGame() {
            const config = difficulties[currentDifficulty];
            state.currentPlayer = 1;
            state.scores = { 1: 0, 2: 0 };
            state.flippedCards = [];
            state.matchedCount = 0;
            state.isProcessing = false;
            
            const seed = Math.floor(Math.random() * 10000);
            state.imageUrl = `https://picsum.photos/seed/${seed}/${config.imageSize}/${config.imageSize}`;

            const els = getElements();
            document.getElementById('coord-pool').innerHTML = '';
            document.getElementById('fragment-pool').innerHTML = '';
            document.getElementById('mobile-coord-pool').innerHTML = '';
            document.getElementById('mobile-fragment-pool').innerHTML = '';
            els.canvasFrame.innerHTML = '';
            document.getElementById('game-over').style.display = 'none';

            // „É¨„Ç§„Ç¢„Ç¶„ÉàË®≠ÂÆö
            const setGrid = (el) => el.style.gridTemplateColumns = `repeat(${config.size}, 1fr)`;
            setGrid(document.getElementById('coord-pool'));
            setGrid(document.getElementById('fragment-pool'));
            setGrid(document.getElementById('mobile-coord-pool'));
            setGrid(document.getElementById('mobile-fragment-pool'));
            setGrid(els.canvasFrame);
            
            let allItems = [];
            for (let r = 0; r < config.size; r++) {
                for (let c = 0; c < config.size; c++) {
                    allItems.push({ id: `${String.fromCharCode(65 + c)}${r + 1}`, r, c });
                }
            }

            let preFillIds = [];
            if (config.preFill === 'center') {
                const mid = Math.floor(config.size / 2);
                preFillIds.push(allItems.find(i => i.r === mid && i.c === mid).id);
            } else if (typeof config.preFill === 'number' && config.preFill > 0) {
                preFillIds = [...allItems].sort(() => 0.5 - Math.random()).slice(0, config.preFill).map(i => i.id);
            }

            allItems.forEach(item => {
                const cell = document.createElement('div');
                cell.className = 'frame-cell';
                cell.id = `frame-${item.id}`;
                cell.dataset.coord = item.id;
                cell.style.width = `${config.frameCellSize}px`;
                cell.style.height = `${config.frameCellSize}px`;
                els.canvasFrame.appendChild(cell);
                if (preFillIds.includes(item.id)) {
                    renderMatchedInFrame(item.id, item);
                    state.matchedCount++;
                }
            });

            const playable = allItems.filter(i => !preFillIds.includes(i.id));
            const coordCards = playable.map(item => createCard(item, 'coord'));
            const fragmentCards = playable.map(item => createCard(item, 'fragment'));
            
            shuffle([...coordCards]).forEach(c => els.coordPool.appendChild(c));
            shuffle([...fragmentCards]).forEach(c => els.fragmentPool.appendChild(c));

            updateUI();
        }

        function createCard(item, type) {
            const config = difficulties[currentDifficulty];
            const container = document.createElement('div');
            container.className = `card-container card-${type}`;
            container.dataset.id = item.id;
            container.dataset.type = type;
            container.style.width = `${config.cardSize}px`;
            container.style.height = `${config.cardSize}px`;

            const inner = document.createElement('div');
            inner.className = 'card-inner';
            const front = document.createElement('div');
            front.className = 'card-front';
            const back = document.createElement('div');
            back.className = 'card-back';

            if (type === 'coord') {
                back.textContent = item.id;
            } else {
                back.style.backgroundImage = `url(${state.imageUrl})`;
                const scale = config.cardSize * config.size;
                back.style.backgroundSize = `${scale}px ${scale}px`;
                back.style.backgroundPosition = `-${item.c * config.cardSize}px -${item.r * config.cardSize}px`;
            }

            inner.appendChild(front);
            inner.appendChild(back);
            container.appendChild(inner);
            container.addEventListener('click', () => handleCardClick(container));
            return container;
        }

        function handleCardClick(card) {
            if (state.isProcessing || card.classList.contains('flipped') || card.classList.contains('hidden-card')) return;
            card.classList.add('flipped');
            state.flippedCards.push(card);
            if (state.flippedCards.length === 2) {
                state.isProcessing = true;
                checkMatch();
            }
        }

        function checkMatch() {
            const [c1, c2] = state.flippedCards;
            const isMatch = (c1.dataset.id === c2.dataset.id) && (c1.dataset.type !== c2.dataset.type);
            const delay = isMatch ? 800 : 1500;

            setTimeout(() => {
                if (isMatch) {
                    const id = c1.dataset.id;
                    renderMatchedInFrame(id, getRowColFromId(id));
                    c1.classList.add('hidden-card');
                    c2.classList.add('hidden-card');
                    state.scores[state.currentPlayer]++;
                    state.matchedCount++;
                    if (state.matchedCount === difficulties[currentDifficulty].size ** 2) {
                        showTemporaryMsg("ÂÆåÊàêÔºÅÔºÅ");
                        setTimeout(showGameOver, 2000);
                    } else {
                        showTemporaryMsg("Ê≠£Ëß£ÔºÅ");
                        state.isProcessing = false;
                    }
                } else {
                    c1.classList.remove('flipped');
                    c2.classList.remove('flipped');
                    switchPlayer("„Éè„Ç∫„É¨");
                    state.isProcessing = false;
                }
                state.flippedCards = [];
                updateUI();
            }, delay);
        }

        function passTurn() {
            if (state.isProcessing) return;
            state.flippedCards.forEach(c => c.classList.remove('flipped'));
            state.flippedCards = [];
            switchPlayer("„Éë„Çπ");
            updateUI();
        }

        function switchPlayer(msg) {
            state.currentPlayer = state.currentPlayer === 1 ? 2 : 1;
            showTemporaryMsg(msg);
        }

        function renderMatchedInFrame(id, item) {
            const config = difficulties[currentDifficulty];
            const cell = document.getElementById(`frame-${id}`);
            const fragment = document.createElement('div');
            fragment.className = 'matched-fragment pop-in';
            fragment.style.backgroundImage = `url(${state.imageUrl})`;
            const scale = config.frameCellSize * config.size;
            fragment.style.backgroundSize = `${scale}px ${scale}px`;
            fragment.style.backgroundPosition = `-${item.c * config.frameCellSize}px -${item.r * config.frameCellSize}px`;
            cell.innerHTML = '';
            cell.appendChild(fragment);
        }

        function getRowColFromId(id) {
            return { r: parseInt(id.substring(1)) - 1, c: id.charCodeAt(0) - 65 };
        }

        function updateUI() {
            const els = getElements();
            document.getElementById('p1-score').textContent = state.scores[1];
            document.getElementById('p2-score').textContent = state.scores[2];
            
            const activeClass = (box, turn, color, isActive) => {
                if (isActive) {
                    box.classList.add('active-player', `border-${color}-500`, 'bg-white');
                    box.classList.remove('border-transparent', 'bg-slate-50');
                    turn.classList.replace(color === 'blue' ? 'bg-red-500' : 'bg-blue-500', `bg-${color}-500`);
                } else {
                    box.classList.remove('active-player', `border-${color}-500`, 'bg-white');
                    box.classList.add('border-transparent', 'bg-slate-50');
                }
            };

            activeClass(els.p1Box, els.turnDisplay, 'blue', state.currentPlayer === 1);
            activeClass(els.p2Box, els.turnDisplay, 'red', state.currentPlayer === 2);
            els.turnDisplay.textContent = `P${state.currentPlayer} „ÅÆÁï™„Åß„Åô`;
        }

        function showTemporaryMsg(msg) {
            const turn = document.getElementById('turn-display');
            turn.textContent = msg;
            setTimeout(() => { if (!state.isProcessing && state.matchedCount < difficulties[currentDifficulty].size ** 2) updateUI(); }, 1000);
        }

        function changeDifficulty(diff) {
            if (currentDifficulty === diff) return;
            currentDifficulty = diff;
            ['beginner', 'intermediate', 'advanced'].forEach(d => {
                document.getElementById(`btn-${d}`).className = d === diff ? "diff-btn diff-btn-active" : "diff-btn diff-btn-inactive";
            });
            initGame();
        }

        function resetGame() {
            if (state.matchedCount > 1 && state.matchedCount < difficulties[currentDifficulty].size ** 2) {
                if (!confirm('„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü')) return;
            }
            initGame();
        }

        function showGameOver() {
            const modal = document.getElementById('game-over');
            modal.style.display = 'flex';
            const winnerText = document.getElementById('winner-text');
            if (state.scores[1] > state.scores[2]) winnerText.textContent = "P1 „ÅÆÂãùÂà©ÔºÅ üèÜ";
            else if (state.scores[2] > state.scores[1]) winnerText.textContent = "P2 „ÅÆÂãùÂà©ÔºÅ üèÜ";
            else winnerText.textContent = "Âºï„ÅçÂàÜ„ÅëÔºÅ ü§ù";
            document.getElementById('final-p1').textContent = state.scores[1];
            document.getElementById('final-p2').textContent = state.scores[2];
        }

        function toggleModal(id, show) { document.getElementById(id).style.display = show ? 'flex' : 'none'; }
        function shuffle(a) { for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; } return a; }

        window.onload = initGame;
        // window.onresize „ÇíÂâäÈô§Ôºö„Ç¶„Ç§„É≥„Éâ„Ç¶„ÅÆ„É™„Çµ„Ç§„Ç∫„Åß„Ç≤„Éº„É†„Åå„É™„Çª„ÉÉ„Éà„Åï„Çå„Å™„ÅÑ„Çà„ÅÜ„Å´„Åó„Åæ„Åó„Åü„ÄÇ
    </script>
</body>
</html>