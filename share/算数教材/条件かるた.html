<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>条件かるたゲーム</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'M PLUS Rounded 1c', sans-serif;
            touch-action: manipulation; /* ダブルタップによるズームを無効化 */
        }
        .card {
            transition: transform 0.3s ease, opacity 0.3s ease;
            cursor: pointer;
        }
        .card.correct {
            transform: scale(0.9);
            opacity: 0;
        }
        .card.incorrect {
            animation: shake 0.5s;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .number-digit {
            transition: background-color 0.3s ease, color 0.3s ease, transform 0.3s ease;
        }
        .digit-changed {
            animation: pulse 0.5s;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen p-4">

    <div id="game-container" class="w-full max-w-4xl mx-auto bg-white rounded-2xl shadow-xl p-6 md:p-8">
        
        <!-- ヘッダー：数字とスコア -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-6">
            <div class="mb-4 md:mb-0">
                <h1 class="text-2xl md:text-3xl font-bold text-gray-700">条件かるた</h1>
                <p class="text-sm text-gray-500">数字に合う条件カードを選ぼう！</p>
            </div>
            <div class="flex items-center space-x-6">
                <div id="number-display" class="flex space-x-2">
                    <span class="number-digit bg-blue-500 text-white text-5xl md:text-6xl font-bold w-20 h-24 rounded-lg flex items-center justify-center shadow-md"></span>
                    <span class="number-digit bg-blue-500 text-white text-5xl md:text-6xl font-bold w-20 h-24 rounded-lg flex items-center justify-center shadow-md"></span>
                    <span class="number-digit bg-blue-500 text-white text-5xl md:text-6xl font-bold w-20 h-24 rounded-lg flex items-center justify-center shadow-md"></span>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-yellow-500">SCORE</div>
                    <div id="score" class="text-4xl font-bold">0</div>
                </div>
            </div>
        </header>

        <!-- 条件カードのグリッド -->
        <main id="card-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 min-h-[300px]">
            <!-- JavaScriptでカードが生成されます -->
        </main>

        <!-- コントロールエリア -->
        <footer class="mt-6 text-center">
            <button id="start-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-full text-xl shadow-lg transition-transform transform hover:scale-105">
                ゲームスタート
            </button>
            <div id="timer-info" class="text-gray-500 mt-2 h-6"></div>
        </footer>

    </div>

    <!-- ゲームオーバーモーダル -->
    <div id="game-over-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 text-center max-w-md w-full">
            <h2 id="game-over-title" class="text-4xl font-bold text-blue-600 mb-4">ゲーム終了！</h2>
            <p class="text-lg mb-2">あなたのスコアは...</p>
            <p id="final-score" class="text-8xl font-bold my-6">0</p>
            <button id="restart-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-full text-xl shadow-lg transition-transform transform hover:scale-105">
                もう一度プレイ
            </button>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM要素の取得 ---
        const numberDisplay = document.getElementById('number-display');
        const scoreEl = document.getElementById('score');
        const cardGrid = document.getElementById('card-grid');
        const startBtn = document.getElementById('start-btn');
        const restartBtn = document.getElementById('restart-btn');
        const gameOverModal = document.getElementById('game-over-modal');
        const finalScoreEl = document.getElementById('final-score');
        const timerInfoEl = document.getElementById('timer-info');
        const gameOverTitleEl = document.getElementById('game-over-title');

        // --- ゲームの状態変数 ---
        let score = 0;
        let currentNumber = 0;
        let currentDigits = [0, 0, 0];
        let gameInterval = null;
        let changeCounter = 0;
        const TOTAL_ROTATIONS = 4;
        const CHANGE_INTERVAL = 6000; // 6秒
        const CARDS_TO_SHOW = 12;

        // --- 条件カードの定義 ---
        // 各条件は、テキスト(text)と判定関数(check)を持つオブジェクト
        const allConditions = [
            { id: 1, text: "3の倍数である", check: (n, d) => n % 3 === 0 },
            { id: 2, text: "4の倍数である", check: (n, d) => n % 4 === 0 },
            { id: 3, text: "5の倍数である", check: (n, d) => n % 5 === 0 },
            { id: 4, text: "7の倍数である", check: (n, d) => n % 7 === 0 },
            { id: 5, text: "11の倍数である", check: (n, d) => n % 11 === 0 },
            { id: 6, text: "「5」が使われている", check: (n, d) => d.includes(5) },
            { id: 7, text: "「9」が使われている", check: (n, d) => d.includes(9) },
            { id: 8, text: "500よりも大きい", check: (n, d) => n > 500 },
            { id: 9, text: "500よりも小さい", check: (n, d) => n < 500 },
            { id: 10, text: "奇数のみでできている", check: (n, d) => d.every(digit => digit % 2 !== 0) },
            { id: 11, text: "偶数のみでできている", check: (n, d) => d.every(digit => digit % 2 === 0) },
            { id: 12, text: "1の位と10の位の差が5", check: (n, d) => Math.abs(d[1] - d[2]) === 5 },
            { id: 13, text: "1の位と100の位の差が5", check: (n, d) => Math.abs(d[0] - d[2]) === 5 },
            { id: 14, text: "百の位 - 十の位 = 一の位", check: (n, d) => d[0] - d[1] === d[2] },
            { id: 15, text: "百の位 + 十の位 = 一の位", check: (n, d) => d[0] + d[1] === d[2] },
            { id: 16, text: "同じ数字が2つある", check: (n, d) => new Set(d).size === 2 },
            { id: 17, text: "すべての位の数字が違う", check: (n, d) => new Set(d).size === 3 },
            { id: 18, text: "各位の数の和が15", check: (n, d) => d.reduce((a, b) => a + b, 0) === 15 },
            { id: 19, text: "回文数である (例: 121)", check: (n, d) => d[0] === d[2] },
            { id: 20, text: "素数である", check: (n, d) => {
                if (n <= 1) return false;
                for (let i = 2; i * i <= n; i++) {
                    if (n % i === 0) return false;
                }
                return true;
            }},
        ];

        // --- ゲームの初期化 ---
        function initGame() {
            score = 0;
            changeCounter = 0;
            updateScore();
            generateNewNumber();
            shuffleAndRenderCards();
            gameOverModal.classList.add('hidden');
            startBtn.disabled = false;
            startBtn.innerText = 'ゲームスタート';
            timerInfoEl.innerText = '';
        }

        // --- ゲーム開始 ---
        function startGame() {
            startBtn.disabled = true;
            startBtn.innerText = 'ゲーム中...';
            updateTimerInfo();
            gameInterval = setInterval(changeDigit, CHANGE_INTERVAL);
        }

        // --- 新しい3桁の数を生成 ---
        function generateNewNumber() {
            currentNumber = Math.floor(Math.random() * 900) + 100;
            updateDigitsAndDisplay();
        }

        // --- 数字と表示を更新 ---
        function updateDigitsAndDisplay() {
            const s = String(currentNumber).padStart(3, '0');
            currentDigits = [parseInt(s[0]), parseInt(s[1]), parseInt(s[2])];
            const digitElements = numberDisplay.children;
            digitElements[0].textContent = currentDigits[0];
            digitElements[1].textContent = currentDigits[1];
            digitElements[2].textContent = currentDigits[2];
        }

        // --- 条件カードをシャッフルして表示 ---
        function shuffleAndRenderCards() {
            cardGrid.innerHTML = '';
            const shuffled = [...allConditions].sort(() => 0.5 - Math.random());
            const selectedConditions = shuffled.slice(0, CARDS_TO_SHOW);

            selectedConditions.forEach(cond => {
                const card = document.createElement('div');
                card.className = 'card bg-blue-100 hover:bg-blue-200 rounded-lg p-4 flex items-center justify-center text-center font-bold text-blue-800 shadow';
                card.textContent = cond.text;
                card.dataset.id = cond.id;
                card.addEventListener('click', handleCardClick);
                cardGrid.appendChild(card);
            });
        }

        // --- カードクリックの処理 ---
        function handleCardClick(e) {
            if (!gameInterval) return; // ゲームが始まっていない場合は何もしない

            const clickedCard = e.currentTarget;
            if (clickedCard.classList.contains('correct')) return; // すでに消えたカードは無視

            const conditionId = parseInt(clickedCard.dataset.id);
            const condition = allConditions.find(c => c.id === conditionId);

            if (condition.check(currentNumber, currentDigits)) {
                // 正解の場合
                score = score+10;
                clickedCard.classList.add('correct');
                // アニメーション後にイベントリスナーを削除
                setTimeout(() => {
                    clickedCard.removeEventListener('click', handleCardClick);
                }, 300);

                if (document.querySelectorAll('.card:not(.correct)').length === 0) {
                    endGame(true); // 全てクリア
                }
            } else {
                // 不正解の場合
                score = score - 3;
                clickedCard.classList.add('incorrect');
                setTimeout(() => {
                    clickedCard.classList.remove('incorrect');
                }, 500);
            }
            updateScore();
        }

        // --- 定期的に数字を変更 ---
        function changeDigit() {
            const digitIndex = changeCounter % 3;
            let newDigit;
            
            do {
                newDigit = Math.floor(Math.random() * 10);
            } while (digitIndex === 0 && newDigit === 0); // 100の位は0にしない

            currentDigits[digitIndex] = newDigit;
            currentNumber = parseInt(currentDigits.join(''));
            
            updateDigitsAndDisplay();
            
            // 変更された桁をハイライト
            const digitElements = numberDisplay.children;
            digitElements[digitIndex].classList.add('digit-changed');
            setTimeout(() => {
                digitElements[digitIndex].classList.remove('digit-changed');
            }, 500);

            changeCounter++;
            updateTimerInfo();

            if (Math.floor((changeCounter -1) / 3) >= TOTAL_ROTATIONS) {
                endGame(false);
            }
        }
        
        // --- タイマー情報の更新 ---
        function updateTimerInfo() {
            const rotation = Math.floor(changeCounter / 3) + 1;
            if (rotation > TOTAL_ROTATIONS) {
                timerInfoEl.innerText = `全${TOTAL_ROTATIONS}ローテーション完了`;
                return;
            }
            const nextPlace = ['百', '十', '一'][changeCounter % 3];
            timerInfoEl.innerText = `ローテーション ${rotation}/${TOTAL_ROTATIONS} | 次は「${nextPlace}」の位が変わります`;
        }


        // --- スコア表示の更新 ---
        function updateScore() {
            scoreEl.textContent = score;
        }

        // --- ゲーム終了 ---
        function endGame(allCleared) {
            clearInterval(gameInterval);
            gameInterval = null;
            
            finalScoreEl.textContent = score;
            if (allCleared) {
                gameOverTitleEl.innerText = 'パーフェクト！';
            } else {
                gameOverTitleEl.innerText = 'ゲーム終了！';
            }
            gameOverModal.classList.remove('hidden');
        }

        // --- イベントリスナーの設定 ---
        startBtn.addEventListener('click', startGame);
        restartBtn.addEventListener('click', () => {
             initGame();
        });

        // --- 初期化 ---
        initGame();
    });
    </script>
</body>
</html>
