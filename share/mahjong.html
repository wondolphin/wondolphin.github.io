<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éº»é›€äº¤æ›ãƒ‘ã‚ºãƒ« - 1æ‰‹ã§ã‚¢ã‚¬ã‚Œï¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap');
        
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #064e3b;
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
        }

        .tile {
            width: 38px;
            height: 54px;
            background-color: #f8f8f8;
            border-radius: 4px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.8rem;
            color: #333;
            box-shadow: 0 3px 0 #ccc, 0 4px 6px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            user-select: none;
        }

        @media (min-width: 640px) {
            .tile { width: 48px; height: 68px; font-size: 2.4rem; }
        }

        .tile:hover:not(.selected):not(.disabled) {
            transform: translateY(-3px);
            filter: brightness(1.1);
        }

        .tile.selected {
            transform: translateY(-8px);
            box-shadow: 0 0 15px #fbbf24, 0 3px 0 #ccc;
            outline: 3px solid #fbbf24;
        }

        .tile.disabled {
            cursor: default;
            opacity: 0.8;
        }

        .tile.manzu { color: #d32f2f; }
        .tile.pinzu { color: #1976d2; }
        .tile.souzu { color: #2e7d32; }

        .staging-area {
            background-color: rgba(0,0,0,0.3);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 1rem;
            padding: 1rem;
            width: 100%;
        }

        .btn-disabled {
            opacity: 0.3;
            cursor: not-allowed;
            filter: grayscale(1);
        }

        .rule-badge {
            background: linear-gradient(135deg, #fbbf24, #d97706);
            color: black;
            padding: 4px 16px;
            border-radius: 999px;
            font-weight: bold;
            font-size: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .message-box {
            min-height: 1.5rem;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <header class="w-full py-6 text-center bg-black/20">
        <h1 class="text-2xl font-bold mb-3">éº»é›€äº¤æ›ãƒ‘ã‚ºãƒ« (1æ‰‹é™å®š)</h1>
        <div class="flex flex-col items-center gap-2">
            <div id="rule-display" class="rule-badge">? æšäº¤æ›</div>
            <div id="status-message" class="message-box text-sm text-yellow-400 mt-1">
                æ‰‹ç‰Œã¨ãƒ—ãƒ¼ãƒ«ã‹ã‚‰ç‰Œã‚’é¸ã‚“ã§ãã ã•ã„
            </div>
        </div>
    </header>

    <div class="w-full max-w-4xl px-4 py-4 flex flex-col gap-6">
        
        <!-- äº¤æ›å€™è£œã‚¨ãƒªã‚¢ (ãƒ—ãƒ¼ãƒ«) -->
        <section>
            <h2 class="text-[10px] uppercase tracking-widest text-white/50 text-center mb-2">Pool - æ‹¾ã†ç‰Œ</h2>
            <div id="pool-container" class="bg-black/20 p-4 rounded-xl flex flex-wrap justify-center gap-2 min-h-[100px]">
                <!-- JSã§ç”Ÿæˆ -->
            </div>
        </section>

        <!-- ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚° & äº¤æ›ãƒœã‚¿ãƒ³ -->
        <section class="staging-area flex flex-col md:flex-row items-center justify-between gap-4">
            <div class="flex-1 flex flex-col items-center">
                <span class="text-[10px] text-white/50 mb-1">æ¨ã¦ã‚‹</span>
                <div id="staging-discard" class="flex gap-2 min-h-[54px] md:min-h-[68px]"></div>
            </div>

            <div class="flex flex-col items-center gap-1">
                <button id="execute-swap-btn" class="px-10 py-4 bg-yellow-500 text-black font-bold rounded-full shadow-lg hover:bg-yellow-400 active:scale-95 transition-all btn-disabled text-lg">
                    äº¤æ›å®Ÿè¡Œ
                </button>
                <span id="swap-hint" class="text-[10px] text-white/60">1å›é™ã‚Šã®ãƒãƒ£ãƒ³ã‚¹ï¼</span>
            </div>

            <div class="flex-1 flex flex-col items-center">
                <span class="text-[10px] text-white/50 mb-1">æ‹¾ã†</span>
                <div id="staging-pick" class="flex gap-2 min-h-[54px] md:min-h-[68px]"></div>
            </div>
        </section>

        <!-- è‡ªåˆ†ã®æ‰‹ç‰Œ -->
        <section>
            <h2 class="text-[10px] uppercase tracking-widest text-white/50 text-center mb-2">Your Hand - ã‚ãªãŸã®æ‰‹ç‰Œ (14æš)</h2>
            <div id="hand-container" class="bg-black/40 p-4 rounded-xl flex flex-wrap justify-center gap-1 min-h-[100px]">
                <!-- JSã§ç”Ÿæˆ -->
            </div>
        </section>

        <div class="flex justify-center gap-8 mt-2">
            <button id="reset-btn" class="px-6 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-sm transition-all">
                ã“ã®å•é¡Œã‚’ãƒªã‚»ãƒƒãƒˆ
            </button>
            <button id="new-game-btn" class="px-6 py-2 bg-emerald-700 hover:bg-emerald-600 rounded-lg text-sm font-bold transition-all">
                æ–°ã—ã„å•é¡Œ
            </button>
        </div>
    </div>

    <!-- ã‚¯ãƒªã‚¢ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="win-modal" class="fixed inset-0 bg-black/90 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white text-gray-900 p-10 rounded-3xl text-center max-w-sm w-full shadow-2xl">
            <div class="text-7xl mb-4">ğŸ’®</div>
            <h2 class="text-3xl font-bold mb-2">ã‚¢ã‚¬ãƒªï¼</h2>
            <p class="text-gray-600 mb-8 font-medium">ç´ æ™´ã‚‰ã—ã„æ´å¯ŸåŠ›ã§ã™ï¼</p>
            <button id="next-level-btn" class="w-full py-4 bg-emerald-600 text-white rounded-xl font-bold text-xl hover:bg-emerald-700 active:scale-95 transition-all">
                æ¬¡ã®ãƒ‘ã‚ºãƒ«ã¸
            </button>
        </div>
    </div>

    <script>
        const TILE_DATA = [
            { id: 'm', class: 'manzu', icons: ['ğŸ€‡','ğŸ€ˆ','ğŸ€‰','ğŸ€Š','ğŸ€‹','ğŸ€Œ','ğŸ€','ğŸ€','ğŸ€'] },
            { id: 'p', class: 'pinzu', icons: ['ğŸ€™','ğŸ€š','ğŸ€›','ğŸ€œ','ğŸ€','ğŸ€','ğŸ€Ÿ','ğŸ€ ','ğŸ€¡'] },
            { id: 's', class: 'souzu', icons: ['ğŸ€','ğŸ€‘','ğŸ€’','ğŸ€“','ğŸ€”','ğŸ€•','ğŸ€–','ğŸ€—','ğŸ€˜'] }
        ];

        let hand = [];
        let pool = [];
        let selectedHandIds = [];
        let selectedPoolIds = [];
        let hasSwapped = false;
        let requiredSwapSize = 1; 
        let initialHandRaw = "";
        let initialPoolRaw = "";

        // åœ¨åº«ï¼ˆå±±ï¼‰ã‚’ç®¡ç†
        function createDeck(type) {
            let deck = [];
            for (let v = 1; v <= 9; v++) {
                for (let i = 0; i < 4; i++) {
                    deck.push({ 
                        typeId: type.id, 
                        value: v, 
                        class: type.class, 
                        icon: type.icons[v-1] 
                    });
                }
            }
            return deck.sort(() => Math.random() - 0.5);
        }

        function initGame() {
            document.getElementById('win-modal').classList.add('hidden');
            
            hasSwapped = false;
            selectedHandIds = [];
            selectedPoolIds = [];
            
            const type = TILE_DATA[Math.floor(Math.random() * 3)];
            let deck = createDeck(type);

            // 1. ã¾ãšã‚¢ã‚¬ãƒªã®14æšã‚’æŠ½å‡º
            const winningHand = generateWinningHandFromDeck(deck, type);
            
            // 2. ä»Šå›äº¤æ›ã™ã‚‹æšæ•°ã‚’æ±ºå®š (1ã€œ3æš)
            requiredSwapSize = Math.floor(Math.random() * 3) + 1;

            // 3. ã‚¢ã‚¬ãƒªå½¢ã‹ã‚‰æŒ‡å®šæšæ•°ã‚’æŠœã„ã¦ãƒ—ãƒ¼ãƒ«ã«æ··ãœã‚‹
            const scrambled = scrambleHandFromDeck(winningHand, deck, requiredSwapSize);
            
            hand = scrambled.h;
            pool = scrambled.p;
            initialHandRaw = JSON.stringify(hand);
            initialPoolRaw = JSON.stringify(pool);

            document.getElementById('rule-display').textContent = `${requiredSwapSize} æšäº¤æ›`;
            document.getElementById('status-message').textContent = "äº¤æ›ã™ã‚‹ç‰Œã‚’é¸ã‚“ã§ãã ã•ã„";
            document.getElementById('status-message').className = "message-box text-sm text-yellow-400 mt-1";

            updateUI();
        }

        function generateWinningHandFromDeck(deck, type) {
            let temp = [];
            let currentDeck = [...deck];
            const attempt = () => {
                temp = [];
                let d = [...currentDeck];
                for (let i = 0; i < 4; i++) {
                    const isKoutsu = Math.random() > 0.4;
                    if (isKoutsu) {
                        const possible = Array.from({length:9}, (_,i)=>i+1).filter(v => d.filter(x => x.value === v).length >= 3);
                        if (possible.length === 0) return false;
                        const v = possible[Math.floor(Math.random() * possible.length)];
                        for (let j = 0; j < 3; j++) {
                            const idx = d.findIndex(x => x.value === v);
                            temp.push(d.splice(idx, 1)[0]);
                        }
                    } else {
                        const possible = Array.from({length:7}, (_,i)=>i+1).filter(v => 
                            d.some(x => x.value === v) && d.some(x => x.value === v+1) && d.some(x => x.value === v+2)
                        );
                        if (possible.length === 0) return false;
                        const v = possible[Math.floor(Math.random() * possible.length)];
                        [v, v+1, v+2].forEach(val => {
                            const idx = d.findIndex(x => x.value === val);
                            temp.push(d.splice(idx, 1)[0]);
                        });
                    }
                }
                const pairs = Array.from({length:9}, (_,i)=>i+1).filter(v => d.filter(x => x.value === v).length >= 2);
                if (pairs.length === 0) return false;
                const pv = pairs[Math.floor(Math.random() * pairs.length)];
                for (let j = 0; j < 2; j++) {
                    const idx = d.findIndex(x => x.value === pv);
                    temp.push(d.splice(idx, 1)[0]);
                }
                deck.length = 0;
                deck.push(...d);
                return true;
            };
            while(!attempt()) { currentDeck = createDeck(type); }
            return temp;
        }

        function scrambleHandFromDeck(winningHand, deck, count) {
            let h = [...winningHand];
            let p = [];
            // countæšé¸ã‚“ã§ãƒ—ãƒ¼ãƒ«ã¸
            for (let i = 0; i < count; i++) {
                const idx = Math.floor(Math.random() * h.length);
                const tile = h.splice(idx, 1)[0];
                tile.id = Math.random();
                p.push(tile);
            }
            // å±±ã‹ã‚‰ãƒã‚ºãƒ¬ç‰Œã‚’è£œå……
            for (let i = 0; i < count; i++) {
                const tile = deck.splice(0, 1)[0];
                tile.id = Math.random();
                h.push(tile);
            }
            // ãƒ—ãƒ¼ãƒ«ã®æ®‹ã‚Šã‚’åŸ‹ã‚ã‚‹
            while (p.length < 8 && deck.length > 0) {
                const tile = deck.splice(0, 1)[0];
                tile.id = Math.random();
                p.push(tile);
            }
            h.forEach(t => { if(!t.id) t.id = Math.random(); });
            return { h, p: p.sort(() => Math.random() - 0.5) };
        }

        function updateUI() {
            const handBox = document.getElementById('hand-container');
            const poolBox = document.getElementById('pool-container');
            const stageDiscard = document.getElementById('staging-discard');
            const stagePick = document.getElementById('staging-pick');
            const swapBtn = document.getElementById('execute-swap-btn');
            const swapHint = document.getElementById('swap-hint');

            // Hand
            handBox.innerHTML = '';
            [...hand].sort((a,b) => a.value - b.value).forEach(t => {
                const el = createTile(t, selectedHandIds.includes(t.id));
                if (!hasSwapped) el.onclick = () => toggleSelect(t.id, 'hand');
                else el.classList.add('disabled');
                handBox.appendChild(el);
            });

            // Pool
            poolBox.innerHTML = '';
            pool.forEach(t => {
                const el = createTile(t, selectedPoolIds.includes(t.id));
                if (!hasSwapped) el.onclick = () => toggleSelect(t.id, 'pool');
                else el.classList.add('disabled');
                poolBox.appendChild(el);
            });

            // Staging
            stageDiscard.innerHTML = '';
            selectedHandIds.forEach(id => {
                const t = hand.find(x => x.id === id);
                stageDiscard.appendChild(createTile(t));
            });

            stagePick.innerHTML = '';
            selectedPoolIds.forEach(id => {
                const t = pool.find(x => x.id === id);
                stagePick.appendChild(createTile(t));
            });

            const hLen = selectedHandIds.length;
            const pLen = selectedPoolIds.length;
            const isCorrectCount = hLen === requiredSwapSize && pLen === requiredSwapSize;
            
            const canSwap = isCorrectCount && !hasSwapped;
            swapBtn.className = `px-10 py-4 bg-yellow-500 text-black font-bold rounded-full shadow-lg transition-all ${canSwap ? 'hover:bg-yellow-400 active:scale-95' : 'btn-disabled'}`;
            swapBtn.onclick = canSwap ? executeSwap : null;
            
            if (hasSwapped) {
                swapHint.textContent = "åˆ¤å®šçµ‚äº†";
            } else if (!isCorrectCount && (hLen > 0 || pLen > 0)) {
                swapHint.textContent = `ã‚ã¨ æ¨:${requiredSwapSize - hLen} / æ‹¾:${requiredSwapSize - pLen}`;
            } else {
                swapHint.textContent = isCorrectCount ? "æº–å‚™å®Œäº†ï¼" : `ä¸€åº¦ã«${requiredSwapSize}æšäº¤æ›`;
            }
        }

        function createTile(tile, isSelected = false) {
            const el = document.createElement('div');
            el.className = `tile ${tile.class} ${isSelected ? 'selected' : ''}`;
            el.textContent = tile.icon;
            return el;
        }

        function toggleSelect(id, type) {
            if (hasSwapped) return;
            if (type === 'hand') {
                if (selectedHandIds.includes(id)) {
                    selectedHandIds = selectedHandIds.filter(x => x !== id);
                } else if (selectedHandIds.length < requiredSwapSize) {
                    selectedHandIds.push(id);
                }
            } else {
                if (selectedPoolIds.includes(id)) {
                    selectedPoolIds = selectedPoolIds.filter(x => x !== id);
                } else if (selectedPoolIds.length < requiredSwapSize) {
                    selectedPoolIds.push(id);
                }
            }
            updateUI();
        }

        function executeSwap() {
            if (hasSwapped) return;

            // äº¤æ›å®Ÿè¡Œ
            selectedHandIds.forEach((hId, i) => {
                const pId = selectedPoolIds[i];
                const hIdx = hand.findIndex(t => t.id === hId);
                const pIdx = pool.findIndex(t => t.id === pId);
                const hTile = hand[hIdx];
                const pTile = pool[pIdx];
                hand[hIdx] = pTile;
                pool[pIdx] = hTile;
            });

            hasSwapped = true;
            selectedHandIds = [];
            selectedPoolIds = [];
            updateUI();

            // æ­£èª¤åˆ¤å®š
            if (checkAgari(hand)) {
                document.getElementById('status-message').textContent = "æ­£è§£ï¼ã‚¢ã‚¬ãƒªå®Œæˆã§ã™ï¼";
                document.getElementById('status-message').className = "message-box text-sm text-emerald-400 mt-1";
                setTimeout(() => document.getElementById('win-modal').classList.remove('hidden'), 600);
            } else {
                document.getElementById('status-message').textContent = "ã‚¢ã‚¬ãƒªã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ãƒªã‚»ãƒƒãƒˆã—ã¦è€ƒãˆç›´ã—ã¾ã—ã‚‡ã†ã€‚";
                document.getElementById('status-message').className = "message-box text-sm text-red-400 mt-1";
            }
        }

        function checkAgari(tiles) {
            const counts = {};
            tiles.forEach(t => {
                const key = t.typeId + t.value;
                counts[key] = (counts[key] || 0) + 1;
            });
            const keys = Object.keys(counts);
            for (let k of keys) {
                if (counts[k] >= 2) {
                    const copy = {...counts};
                    copy[k] -= 2;
                    if (copy[k] === 0) delete copy[k];
                    if (canFormSets(copy, 4)) return true;
                }
            }
            return false;
        }

        function canFormSets(counts, needed) {
            if (needed === 0) return true;
            const keys = Object.keys(counts).sort();
            if (keys.length === 0) return false;
            const first = keys[0];
            const type = first[0];
            const val = parseInt(first.substring(1));
            
            // åˆ»å­
            if (counts[first] >= 3) {
                const next = {...counts};
                next[first] -= 3;
                if (next[first] === 0) delete next[first];
                if (canFormSets(next, needed - 1)) return true;
            }
            
            // é †å­
            const k2 = type + (val+1);
            const k3 = type + (val+2);
            if (counts[k2] > 0 && counts[k3] > 0) {
                const next = {...counts};
                next[first]--; next[k2]--; next[k3]--;
                [first, k2, k3].forEach(k => { if (next[k] === 0) delete next[k]; });
                if (canFormSets(next, needed - 1)) return true;
            }
            return false;
        }

        document.getElementById('reset-btn').onclick = () => {
            hand = JSON.parse(initialHandRaw);
            pool = JSON.parse(initialPoolRaw);
            selectedHandIds = [];
            selectedPoolIds = [];
            hasSwapped = false;
            document.getElementById('status-message').textContent = "è€ƒãˆç›´ã—ã¾ã—ã‚‡ã†ã€‚ç‰Œã‚’é¸ã‚“ã§ãã ã•ã„ã€‚";
            document.getElementById('status-message').className = "message-box text-sm text-yellow-400 mt-1";
            updateUI();
        };

        document.getElementById('new-game-btn').onclick = initGame;
        document.getElementById('next-level-btn').onclick = initGame;

        window.onload = initGame;
    </script>
</body>
</html>